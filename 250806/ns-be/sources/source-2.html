


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > ChoosePromotionVM</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.promotion.presentation.viewModel</a>
</div>

<h1>Coverage Summary for Class: ChoosePromotionVM (vn.momo.compose.payment.promotion.presentation.viewModel)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ChoosePromotionVM</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/232)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/334)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1924)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ChoosePromotionVM$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$checkABTestFlatVoucherReward$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$checkAutoPickedVouchers$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$checkAutoPickedVouchers$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/43)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$displayVouchersState$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$displayVouchersState$1$invokeSuspend$$inlined$sortedByDescending$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$footerButtonProps$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$onCreate$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$onToggleVoucherSelect$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/66)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$onVoucherClick$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$special$$inlined$inject$default$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$special$$inlined$inject$default$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$special$$inlined$inject$default$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/54)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/246)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/391)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2225)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.promotion.presentation.viewModel
&nbsp;
&nbsp;import kotlinx.coroutines.delay
&nbsp;import kotlinx.coroutines.flow.MutableStateFlow
&nbsp;import kotlinx.coroutines.flow.SharingStarted
&nbsp;import kotlinx.coroutines.flow.StateFlow
&nbsp;import kotlinx.coroutines.flow.combine
&nbsp;import kotlinx.coroutines.flow.launchIn
&nbsp;import kotlinx.coroutines.flow.onEach
&nbsp;import kotlinx.coroutines.flow.stateIn
&nbsp;import kotlinx.coroutines.flow.take
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.json.jsonObject
&nbsp;import kotlinx.serialization.serializer
&nbsp;import org.koin.core.parameter.parametersOf
&nbsp;import org.koin.core.scope.Scope
&nbsp;import vn.momo.compose.payment.base.core.composeApi.ILogger
&nbsp;import vn.momo.compose.payment.base.core.composeApi.INavigator
&nbsp;import vn.momo.compose.payment.base.domain.entities.ChoosePromotionCallbackData
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.common.ABTestUseCase
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.ViewModel
&nbsp;import vn.momo.compose.payment.promotion.core.model.PromotionSourceScreen
&nbsp;import vn.momo.compose.payment.promotion.core.model.toTrackingParams
&nbsp;import vn.momo.compose.payment.promotion.core.utils.InfiniteQuery
&nbsp;import vn.momo.compose.payment.promotion.core.utils.createInfiniteQuery
&nbsp;import vn.momo.compose.payment.promotion.core.utils.sequenceQueriesFactory
&nbsp;import vn.momo.compose.payment.promotion.data.constants.MatrixGroupAvailability
&nbsp;import vn.momo.compose.payment.promotion.data.constants.PromotionABNamespace
&nbsp;import vn.momo.compose.payment.promotion.data.constants.PromotionABTagname
&nbsp;import vn.momo.compose.payment.promotion.data.constants.StackingVoucherGroups
&nbsp;import vn.momo.compose.payment.promotion.data.constants.TrackingConst
&nbsp;import vn.momo.compose.payment.promotion.data.constants.VoucherPathType
&nbsp;import vn.momo.compose.payment.promotion.data.dto.CheckPromoCodeParams
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toPromoCodeRequestDTO
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toPromoCodeSBRequestDTO
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toVoucherBase
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toVoucherDTO
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.ChoosePromotionSource
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.IVoucherBase
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherBase
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherDetailCallbackData
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherDetailParams
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherGroup
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherLocalType
&nbsp;import vn.momo.compose.payment.promotion.domain.repositories.IVoucherDetailRepository
&nbsp;import vn.momo.compose.payment.promotion.domain.repositories.IVoucherRepository
&nbsp;import vn.momo.compose.payment.promotion.presentation.model.ChoosePromotionScreenProps
&nbsp;import vn.momo.compose.payment.promotion.presentation.model.FooterButtonProps
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.ValidationUtils
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.distinctById
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.flattenToGroups
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.getFooterButtonPropsUtil
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.delegate.IPromotionVMTracking
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.reducers.ChoosePromotionReducer
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.CollectVoucherSlice
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.PromoCodeSlice
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.VoucherCoinSlice
&nbsp;import vn.momo.compose.utils.datamapping.ModelConvertUtils
&nbsp;import vn.momo.compose.utils.emptyJsonObject
&nbsp;
&nbsp;class ChoosePromotionVM(
<b class="nc">&nbsp;    private val koinScope: Scope,</b>
<b class="nc">&nbsp;    private val navigator: INavigator,</b>
<b class="nc">&nbsp;    private val logger: ILogger,</b>
<b class="nc">&nbsp;    private val voucherRepository: IVoucherRepository,</b>
<b class="nc">&nbsp;    private val voucherDetailRepository: IVoucherDetailRepository,</b>
<b class="nc">&nbsp;    private val screenProps: Map&lt;String, Any?&gt;? = null,</b>
<b class="nc">&nbsp;    private val promotionTracer: IPromotionVMTracking,</b>
<b class="nc">&nbsp;    private val abTestUseCase: ABTestUseCase,</b>
<b class="nc">&nbsp;) : ViewModel&lt;ChoosePromotionReducer.State, ChoosePromotionReducer.Action, ChoosePromotionReducer.Effect&gt;(</b>
<b class="nc">&nbsp;    ChoosePromotionReducer.State(),</b>
<b class="nc">&nbsp;    ChoosePromotionReducer()</b>
&nbsp;), IPromotionVMTracking by promotionTracer {
<b class="nc">&nbsp;    val params = ChoosePromotionScreenProps.fromMap(screenProps) ?: ChoosePromotionScreenProps()</b>
<b class="nc">&nbsp;    private val isMultiBillFlow = params.isSingleBillFlow != true</b>
<b class="nc">&nbsp;    private val sourceScreen = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;        PromotionSourceScreen.MULTI_BILL</b>
&nbsp;    } else {
<b class="nc">&nbsp;        PromotionSourceScreen.SINGLE_BILL</b>
&nbsp;    }
&nbsp;    private var hasTrackedScreenInteracted: Boolean = false
&nbsp;
&nbsp;    private val _defaultSelectedVouchers =
<b class="nc">&nbsp;        MutableStateFlow(params.selectedVouchers?.map { it.toVoucherBase() } ?: emptyList())</b>
<b class="nc">&nbsp;    private val defaultSelectedVouchers: StateFlow&lt;List&lt;IVoucherBase&gt;&gt; = _defaultSelectedVouchers</b>
&nbsp;    private fun updateDefaultSelectedVouchers(vouchers: List&lt;IVoucherBase&gt;) {
<b class="nc">&nbsp;        _defaultSelectedVouchers.value = vouchers</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    val promoCodeSlice by koinScope.inject&lt;PromoCodeSlice&gt; { parametersOf(viewModelScope) }</b>
<b class="nc">&nbsp;    val voucherCoinSlice by koinScope.inject&lt;VoucherCoinSlice&gt; {</b>
<b class="nc">&nbsp;        parametersOf(</b>
<b class="nc">&nbsp;            viewModelScope,</b>
<b class="nc">&nbsp;            params</b>
&nbsp;        )
&nbsp;    }
<b class="nc">&nbsp;    val collectVoucherSlice by koinScope.inject&lt;CollectVoucherSlice&gt; { parametersOf(viewModelScope) }</b>
&nbsp;
<b class="nc">&nbsp;    private val sequencedVoucherQuery = sequenceQueriesFactory(</b>
<b class="nc">&nbsp;        scope = viewModelScope,</b>
<b class="nc">&nbsp;        initialEnabled = !isMultiBillFlow, // wait for AB test check in multi-bill flow</b>
<b class="nc">&nbsp;        queriesProvider = { createVoucherQueries() }</b>
&nbsp;    )
&nbsp;
&nbsp;    private fun createVoucherQueries(): List&lt;InfiniteQuery&lt;IVoucherBase&gt;&gt; {
<b class="nc">&nbsp;        return listOfNotNull(</b>
<b class="nc">&nbsp;            createRecommendVoucherQuery(),</b>
<b class="nc">&nbsp;            createValidRewardVoucherQuery(),</b>
<b class="nc">&nbsp;            createValidCollectVoucherQuery(),</b>
<b class="nc">&nbsp;            createInvalidCollectVoucherQuery(),</b>
<b class="nc">&nbsp;            createInvalidRewardVoucherQuery(),</b>
<b class="nc">&nbsp;            createInvalidVoucherQuery()</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun createRecommendVoucherQuery(): InfiniteQuery&lt;IVoucherBase&gt; {
<b class="nc">&nbsp;        return createVoucherListQuery(</b>
<b class="nc">&nbsp;            pathType = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;                VoucherPathType.MultiBillRecommend</b>
&nbsp;            } else {
<b class="nc">&nbsp;                VoucherPathType.SingleBillRecommend</b>
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun createValidCollectVoucherQuery(): InfiniteQuery&lt;IVoucherBase&gt; {
<b class="nc">&nbsp;        return createVoucherListQuery(</b>
<b class="nc">&nbsp;            pathType = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;                VoucherPathType.MultiBillGiftMask</b>
&nbsp;            } else {
<b class="nc">&nbsp;                VoucherPathType.SingleBillGiftMask</b>
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun createValidRewardVoucherQuery(): InfiniteQuery&lt;IVoucherBase&gt;? {
<b class="nc">&nbsp;        return if (isMultiBillFlow &amp;&amp; state.value.shouldFlatVoucherReward) {</b>
<b class="nc">&nbsp;            createVoucherCoinQuery(status = &quot;VALID&quot;)</b>
&nbsp;        } else {
<b class="nc">&nbsp;            null</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun createInvalidCollectVoucherQuery(): InfiniteQuery&lt;IVoucherBase&gt; {
<b class="nc">&nbsp;        return createVoucherListQuery(</b>
<b class="nc">&nbsp;            pathType = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;                VoucherPathType.MultiBillInvalidGiftMask</b>
&nbsp;            } else {
<b class="nc">&nbsp;                VoucherPathType.SingleBillInvalidGiftMask</b>
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun createInvalidRewardVoucherQuery(): InfiniteQuery&lt;IVoucherBase&gt;? {
<b class="nc">&nbsp;        return if (isMultiBillFlow &amp;&amp; state.value.shouldFlatVoucherReward) {</b>
<b class="nc">&nbsp;            createVoucherCoinQuery(status = &quot;INVALID&quot;)</b>
&nbsp;        } else {
<b class="nc">&nbsp;            null</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun createInvalidVoucherQuery(): InfiniteQuery&lt;IVoucherBase&gt; {
<b class="nc">&nbsp;        return createVoucherListQuery(</b>
<b class="nc">&nbsp;            pathType = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;                VoucherPathType.MultiBillInvalid</b>
&nbsp;            } else {
<b class="nc">&nbsp;                VoucherPathType.SingleBillInvalid</b>
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun createVoucherListQuery(pathType: VoucherPathType): InfiniteQuery&lt;IVoucherBase&gt; {
<b class="nc">&nbsp;        return viewModelScope.createInfiniteQuery(</b>
&nbsp;            queryFn = { page -&gt;
<b class="nc">&nbsp;                voucherRepository.getVoucherList(pathType, page, params)</b>
&nbsp;            },
<b class="nc">&nbsp;            enabled = false,</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun createVoucherCoinQuery(status: String): InfiniteQuery&lt;IVoucherBase&gt; {
<b class="nc">&nbsp;        return viewModelScope.createInfiniteQuery(</b>
&nbsp;            queryFn = { page -&gt;
<b class="nc">&nbsp;                voucherRepository.getListVoucherCoin(page, params, status)</b>
&nbsp;            },
<b class="nc">&nbsp;            enabled = false,</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    fun onCreate() {
<b class="nc">&nbsp;        logger.i(&quot;[ChoosePromotion] onCreate ${params.toDebugString()}&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        initializeTracking(params)</b>
<b class="nc">&nbsp;        trackVoucherScreenDisplayed(sourceScreen)</b>
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            delay(TrackingConst.SCREEN_VIEWED_LENGTH)</b>
<b class="nc">&nbsp;            trackVoucherScreenViewed(sourceScreen)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (defaultSelectedVouchers.value.isNotEmpty()) {</b>
<b class="nc">&nbsp;            logger.i(&quot;[ChoosePromotion] defaultSelectedVouchers: ${defaultSelectedVouchers.value.size} invalids: ${this.params.selectedVouchers?.filter { it.isInValid == true }?.size}&quot;)</b>
<b class="nc">&nbsp;            dispatch(ChoosePromotionReducer.Action.SetSelectedVouchers(defaultSelectedVouchers.value))</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;            checkAutoPickedVouchers()</b>
<b class="nc">&nbsp;            checkABTestFlatVoucherReward()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    init {</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            sequencedVoucherQuery.state.collect { queryState -&gt;</b>
<b class="nc">&nbsp;                logger.i(&quot;[ChoosePromotionVM] sequenced query state - pages: ${queryState.pages.size}, isFetching: ${queryState.isFetching}&quot;)</b>
&nbsp;
<b class="nc">&nbsp;                if (!hasTrackedScreenInteracted &amp;&amp; queryState.isFetched) {</b>
<b class="nc">&nbsp;                    hasTrackedScreenInteracted = true</b>
<b class="nc">&nbsp;                    trackVoucherScreenInteracted(sourceScreen)</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                val vouchers = queryState.pages</b>
<b class="nc">&nbsp;                    .flatMap { it.records }</b>
<b class="nc">&nbsp;                    .distinctById()</b>
&nbsp;
<b class="nc">&nbsp;                dispatch(</b>
<b class="nc">&nbsp;                    ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                        vouchers = vouchers,</b>
<b class="nc">&nbsp;                        isFetching = queryState.isFetching,</b>
<b class="nc">&nbsp;                        isRefetching = queryState.isRefetching,</b>
<b class="nc">&nbsp;                        hasNextPage = queryState.hasNextPage(),</b>
&nbsp;                    )
&nbsp;                )
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private fun checkAutoPickedVouchers() {
&nbsp;        /**
&nbsp;         * Auto picked vouchers are passed in from voucherInfo
&nbsp;         * but have not cached in selectedVouchers yet
&nbsp;         */
<b class="nc">&nbsp;        if (defaultSelectedVouchers.value.isEmpty()) {</b>
<b class="nc">&nbsp;            val autoPickedVoucherIds = params.billData?.giftId</b>
<b class="nc">&nbsp;                ?.split(&quot;,&quot;)</b>
<b class="nc">&nbsp;                ?.filter { it.isNotBlank() }</b>
&nbsp;
<b class="nc">&nbsp;            logger.i(&quot;[ChoosePromotionVM] autoPickedVoucherIds: $autoPickedVoucherIds&quot;)</b>
&nbsp;
<b class="nc">&nbsp;            if (!autoPickedVoucherIds.isNullOrEmpty()) {</b>
<b class="nc">&nbsp;                viewModelScope.launch {</b>
<b class="nc">&nbsp;                    voucherDetailRepository</b>
<b class="nc">&nbsp;                        .getVoucherDetails(autoPickedVoucherIds)</b>
<b class="nc">&nbsp;                        .take(1)</b>
<b class="nc">&nbsp;                        .onEach {</b>
<b class="nc">&nbsp;                            val autoPickedVouchers = it?.filter { voucher -&gt;</b>
<b class="nc">&nbsp;                                voucher.ID in autoPickedVoucherIds</b>
<b class="nc">&nbsp;                            } ?: emptyList()</b>
&nbsp;
<b class="nc">&nbsp;                            logger.i(&quot;[ChoosePromotionVM] fetched ${autoPickedVouchers.size} auto picked vouchers&quot;)</b>
&nbsp;
<b class="nc">&nbsp;                            if (autoPickedVouchers.isNotEmpty()) {</b>
<b class="nc">&nbsp;                                updateDefaultSelectedVouchers(autoPickedVouchers)</b>
<b class="nc">&nbsp;                                dispatch(</b>
<b class="nc">&nbsp;                                    ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                                        autoPickedVouchers</b>
&nbsp;                                    )
&nbsp;                                )
&nbsp;                            }
<b class="nc">&nbsp;                        }.launchIn(this)</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Combine selected vouchers and vouchers state
&nbsp;     * Put selected vouchers at the top of the list
&nbsp;     * Distinct by ID or extra.collectId
&nbsp;     */
<b class="nc">&nbsp;    val displayVouchersState = combine(</b>
<b class="nc">&nbsp;        promoCodeSlice.state,</b>
<b class="nc">&nbsp;        voucherCoinSlice.state,</b>
<b class="nc">&nbsp;        state</b>
&nbsp;    ) { promoCodeState, voucherCoinState, currentState -&gt;
<b class="nc">&nbsp;        (promoCodeState.generatedPromoVouchers</b>
<b class="nc">&nbsp;                + voucherCoinState.claimedVouchers</b>
<b class="nc">&nbsp;                + defaultSelectedVouchers.value</b>
<b class="nc">&nbsp;                + currentState.vouchers)</b>
<b class="nc">&nbsp;            .sortedByDescending { it.generatedAt }</b>
<b class="nc">&nbsp;            .distinctById()</b>
<b class="nc">&nbsp;    }.stateIn(</b>
<b class="nc">&nbsp;        viewModelScope,</b>
<b class="nc">&nbsp;        SharingStarted.WhileSubscribed(5000),</b>
<b class="nc">&nbsp;        emptyList()</b>
&nbsp;    )
&nbsp;
&nbsp;    fun onRefetch() {
<b class="nc">&nbsp;        sequencedVoucherQuery.onRefetch()</b>
<b class="nc">&nbsp;        voucherCoinSlice.voucherCoinQuery.onRefetch()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onFetchNextPage() {
<b class="nc">&nbsp;        sequencedVoucherQuery.onFetchNextPage()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun handleVoucherDetailCallback(
&nbsp;        voucher: IVoucherBase,
&nbsp;        index: Int,
&nbsp;        callbackData: VoucherDetailCallbackData?
&nbsp;    ) {
<b class="nc">&nbsp;        if (callbackData?.shouldClearSelectedVouchers == true) {</b>
<b class="nc">&nbsp;            dispatch(ChoosePromotionReducer.Action.SetSelectedVouchers(emptyList()))</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (callbackData?.isRemoveVoucher == true) {</b>
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                    state.value.selectedVouchers.filter { it.ID != voucher.ID }</b>
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val collectedVoucher = callbackData?.collectedVoucher?.toVoucherBase()</b>
&nbsp;
<b class="nc">&nbsp;        if (collectedVoucher != null) {</b>
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                    vouchers = state.value.vouchers.map { item -&gt;</b>
<b class="nc">&nbsp;                        if (</b>
<b class="nc">&nbsp;                            (item.extra?.collectId != null &amp;&amp; item.extra?.collectId == voucher.extra?.collectId) ||</b>
<b class="nc">&nbsp;                            (item.extra?.rewardId != null &amp;&amp; item.extra?.rewardId == voucher.extra?.rewardId)</b>
&nbsp;                        ) {
<b class="nc">&nbsp;                            collectedVoucher</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            item</b>
<b class="nc">&nbsp;                        }</b>
&nbsp;                    },
<b class="nc">&nbsp;                    isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                    isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                    hasNextPage = state.value.hasNextPage,</b>
&nbsp;                )
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            if (voucher.localType == VoucherLocalType.VoucherCoin) {</b>
<b class="nc">&nbsp;                voucherCoinSlice.voucherCoinQuery.onRefetch()</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val selectedVoucher = callbackData?.itemSelected?.toVoucherBase()</b>
&nbsp;
<b class="nc">&nbsp;        if (selectedVoucher != null &amp;&amp; checkVoucherAvailabilityByGroup(selectedVoucher)) {</b>
<b class="nc">&nbsp;            this.onToggleVoucherSelect(selectedVoucher, index)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (callbackData?.shouldClosePrevScreen == true) {</b>
<b class="nc">&nbsp;            navigator.dismiss()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onVoucherClick(voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherComponentClicked(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        if (voucher.localType == VoucherLocalType.VoucherCoin ||</b>
<b class="nc">&nbsp;            voucher.localType == VoucherLocalType.InvalidVoucherCoin</b>
&nbsp;        ) {
<b class="nc">&nbsp;            voucherCoinSlice.navigateToVoucherDetail(</b>
<b class="nc">&nbsp;                voucher,</b>
&nbsp;                callbackFn = {
<b class="nc">&nbsp;                    this.handleVoucherDetailCallback(</b>
<b class="nc">&nbsp;                        voucher,</b>
<b class="nc">&nbsp;                        index,</b>
<b class="nc">&nbsp;                        it</b>
&nbsp;                    )
&nbsp;                },
<b class="nc">&nbsp;                selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;                isDisabled = !checkVoucherAvailabilityByGroup(voucher)</b>
&nbsp;            )
&nbsp;            return
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val params = VoucherDetailParams(</b>
<b class="nc">&nbsp;            voucher = voucher.toVoucherDTO(</b>
<b class="nc">&nbsp;                selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;                isDisabled = !checkVoucherAvailabilityByGroup(voucher)</b>
&nbsp;            ),
<b class="nc">&nbsp;            giftId = when {</b>
<b class="nc">&nbsp;                !voucher.giftId.isNullOrBlank() -&gt; voucher.giftId</b>
<b class="nc">&nbsp;                !voucher.ID.isNullOrBlank() -&gt; voucher.ID</b>
<b class="nc">&nbsp;                !voucher.id.isNullOrBlank() -&gt; voucher.id</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            },
<b class="nc">&nbsp;            giftType = when {</b>
<b class="nc">&nbsp;                !voucher.giftType.isNullOrBlank() -&gt; voucher.giftType</b>
<b class="nc">&nbsp;                !voucher.typeId.isNullOrBlank() -&gt; voucher.typeId</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            },
<b class="nc">&nbsp;            campaignId = voucher.extra?.campaignId,</b>
<b class="nc">&nbsp;            source = ChoosePromotionSource.ttat.toString(),</b>
&nbsp;        )
<b class="nc">&nbsp;        navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;            &quot;instant_voucher_detail&quot;,</b>
<b class="nc">&nbsp;            ModelConvertUtils.encodeToJson(serializer(), params)?.jsonObject ?: emptyJsonObject(),</b>
<b class="nc">&nbsp;            VoucherDetailCallbackData.serializer(),</b>
<b class="nc">&nbsp;        ).onEach {</b>
<b class="nc">&nbsp;            this.handleVoucherDetailCallback(</b>
<b class="nc">&nbsp;                voucher,</b>
<b class="nc">&nbsp;                index,</b>
<b class="nc">&nbsp;                it,</b>
&nbsp;            )
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onToggleVoucherSelect(voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        val isSelected = checkVoucherSelected(voucher)</b>
&nbsp;
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = isSelected,</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherActionTriggered(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
<b class="nc">&nbsp;            action = if (isSelected) {</b>
<b class="nc">&nbsp;                &quot;unchoose&quot;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                &quot;choose&quot;</b>
&nbsp;            }
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            if (</b>
<b class="nc">&nbsp;                !isSelected &amp;&amp;</b>
<b class="nc">&nbsp;                ValidationUtils.checkUserProfStatus(voucher, navigator, viewModelScope)</b>
&nbsp;            ) {
&nbsp;                return@launch
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                    if (isSelected) {</b>
<b class="nc">&nbsp;                        state.value.selectedVouchers.filter { it.ID != voucher.ID }</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        state.value.selectedVouchers + voucher</b>
&nbsp;                    }
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onClaimVoucherCoin(
&nbsp;        voucher: IVoucherBase,
&nbsp;        index: Int,
&nbsp;    ) {
<b class="nc">&nbsp;        if (state.value.shouldFlatVoucherReward) {</b>
<b class="nc">&nbsp;            val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;                selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;                index = index,</b>
&nbsp;            )
<b class="nc">&nbsp;            trackVoucherActionTriggered(</b>
<b class="nc">&nbsp;                sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;                giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;                campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;                slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;                status = voucherTrackingParams.status,</b>
<b class="nc">&nbsp;                action = &quot;exchange&quot;</b>
&nbsp;            )
&nbsp;        } else {
<b class="nc">&nbsp;            trackVoucherCoinExchangeNowClicked(</b>
<b class="nc">&nbsp;                giftType = voucher.typeId ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                campaignId = voucher.extra?.campaignId ?: voucher.campaign,</b>
&nbsp;            )
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        voucherCoinSlice.claimVoucherCoin(</b>
<b class="nc">&nbsp;            voucher = voucher as VoucherBase,</b>
&nbsp;            onSuccess = {
<b class="nc">&nbsp;                dispatch(</b>
<b class="nc">&nbsp;                    ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                        vouchers = state.value.vouchers.map { item -&gt;</b>
<b class="nc">&nbsp;                            if (item.extra?.rewardId == it.extra?.rewardId) {</b>
<b class="nc">&nbsp;                                it</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                item</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;                        },
<b class="nc">&nbsp;                        isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                        isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                        hasNextPage = state.value.hasNextPage,</b>
&nbsp;                    )
&nbsp;                )
&nbsp;
<b class="nc">&nbsp;                if (voucher.extra?.isInvalid != true &amp;&amp; checkVoucherAvailabilityByGroup(it)) {</b>
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                            listOf(it) + state.value.selectedVouchers</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;            },
&nbsp;            onError = {
<b class="nc">&nbsp;                logger.e(&quot;[ChoosePromotionVM] onClaimVoucherCoin error: $it&quot;)</b>
&nbsp;            },
<b class="nc">&nbsp;            shouldUpdateClaimedState = !state.value.shouldFlatVoucherReward,</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    fun onCollectVoucher(voucher: VoucherBase, index: Int) {
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherActionTriggered(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
<b class="nc">&nbsp;            action = &quot;collect&quot;</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        collectVoucherSlice.onCollect(</b>
<b class="nc">&nbsp;            voucher,</b>
&nbsp;            onSuccess = {
<b class="nc">&nbsp;                dispatch(</b>
<b class="nc">&nbsp;                    ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                        vouchers = state.value.vouchers.map { item -&gt;</b>
<b class="nc">&nbsp;                            if (item.extra?.collectId == it.extra?.collectId) {</b>
<b class="nc">&nbsp;                                it</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                item</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;                        },
<b class="nc">&nbsp;                        isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                        isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                        hasNextPage = state.value.hasNextPage,</b>
&nbsp;                    )
&nbsp;                )
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    fun onCheckPromoCode(promoCode: String) {
<b class="nc">&nbsp;        trackVoucherPromoCodeInputted(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            promoCode = promoCode,</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        val selectedGroups = state.value.selectedVouchers.flattenToGroups().map { it.toString() }</b>
<b class="nc">&nbsp;        promoCodeSlice.onCheckPromoCode(</b>
<b class="nc">&nbsp;            params = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;                CheckPromoCodeParams.RequestDTO(</b>
<b class="nc">&nbsp;                    params.toPromoCodeRequestDTO(promoCode, selectedGroups)</b>
&nbsp;                )
&nbsp;            } else {
<b class="nc">&nbsp;                CheckPromoCodeParams.SBRequestDTO(</b>
<b class="nc">&nbsp;                    params.toPromoCodeSBRequestDTO(promoCode)</b>
&nbsp;                )
&nbsp;            },
&nbsp;            onSuccess = { generatedVouchers -&gt;
<b class="nc">&nbsp;                if (generatedVouchers.size == 1 &amp;&amp; state.value.selectedVouchers.isEmpty()) {</b>
&nbsp;                    // auto select voucher when only one voucher is generated
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                            generatedVouchers.filter { it.localType == VoucherLocalType.Recommend }</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                trackVoucherPromoCodeErrorViewed(</b>
<b class="nc">&nbsp;                    sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;                    promoCode = promoCode,</b>
<b class="nc">&nbsp;                    errorType = &quot;0&quot;,</b>
<b class="nc">&nbsp;                    errorMsg = &quot;0&quot;,</b>
&nbsp;                )
&nbsp;            },
&nbsp;            onError = {
<b class="nc">&nbsp;                trackVoucherPromoCodeErrorViewed(</b>
<b class="nc">&nbsp;                    sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;                    promoCode = promoCode,</b>
<b class="nc">&nbsp;                    errorType = &quot;1&quot;,</b>
<b class="nc">&nbsp;                    errorMsg = it,</b>
&nbsp;                )
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun checkVoucherSelected(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        return state.value.selectedVouchers.any { voucher.ID == it.ID }</b>
&nbsp;    }
&nbsp;
&nbsp;    fun checkVoucherAvailabilityByGroup(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        if (params.isSingleBillFlow == true) {</b>
&nbsp;            // no stacking voucher in single bill flow
<b class="nc">&nbsp;            return state.value.selectedVouchers.isEmpty() || checkVoucherSelected(voucher)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (voucher.groups.isNullOrEmpty()) {</b>
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val selectedGroups = state.value.selectedVouchers.flattenToGroups()</b>
&nbsp;
&nbsp;        // Available when no one has been selected or this item is selected
<b class="nc">&nbsp;        if (selectedGroups.isEmpty() || checkVoucherSelected(voucher)) {</b>
<b class="nc">&nbsp;            return true</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return !voucher.groups!!.any { itemGroup -&gt;</b>
<b class="nc">&nbsp;            selectedGroups.any { selectedGroup -&gt;</b>
<b class="nc">&nbsp;                MatrixGroupAvailability[selectedGroup]?.get(itemGroup) != &quot;available&quot;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Use to display stacking promo tag in voucher item
&nbsp;     * When voucher groups have &gt;= 2 groups in StackingVoucherGroups
&nbsp;     */
&nbsp;    val shouldDisplayStackingVoucherTag: Boolean
&nbsp;        get() {
<b class="nc">&nbsp;            if (params.isSingleBillFlow == true) {</b>
&nbsp;                // no stacking voucher in single bill flow
<b class="nc">&nbsp;                return false</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            val allGroupsSet = mutableSetOf&lt;VoucherGroup&gt;()</b>
<b class="nc">&nbsp;            var stackingVoucherGroupsCount = 0</b>
&nbsp;
<b class="nc">&nbsp;            for (voucherItem in state.value.vouchers) {</b>
<b class="nc">&nbsp;                if (voucherItem.groups.isNullOrEmpty()) continue</b>
&nbsp;
<b class="nc">&nbsp;                for (group in voucherItem.groups!!.filterNotNull()) {</b>
<b class="nc">&nbsp;                    if (allGroupsSet.contains(group)) continue</b>
<b class="nc">&nbsp;                    allGroupsSet.add(group)</b>
<b class="nc">&nbsp;                    if (StackingVoucherGroups.contains(group)) {</b>
<b class="nc">&nbsp;                        stackingVoucherGroupsCount++</b>
&nbsp;                        // Early exit if condition already satisfied
<b class="nc">&nbsp;                        if (stackingVoucherGroupsCount &gt;= 2) return true</b>
&nbsp;                        // Skip the rest of the groups in the current voucher
&nbsp;                        break
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
&nbsp;    fun checkVoucherStackable(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        if (!shouldDisplayStackingVoucherTag) {</b>
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return voucher.groups?.any { itemGroup -&gt;</b>
<b class="nc">&nbsp;            StackingVoucherGroups.any { it == itemGroup }</b>
<b class="nc">&nbsp;        } ?: false</b>
&nbsp;    }
&nbsp;
&nbsp;    fun screenGoBack() {
<b class="nc">&nbsp;        navigator.dismiss()</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    val footerButtonProps: StateFlow&lt;FooterButtonProps&gt; = combine(</b>
<b class="nc">&nbsp;        state,</b>
<b class="nc">&nbsp;        defaultSelectedVouchers,</b>
&nbsp;    ) { currentState, defaultVouchers -&gt;
<b class="nc">&nbsp;        getFooterButtonPropsUtil(</b>
<b class="nc">&nbsp;            selectedVouchers = currentState.selectedVouchers,</b>
<b class="nc">&nbsp;            defaultSelectedVouchers = defaultVouchers,</b>
<b class="nc">&nbsp;            callbackToPayment = { callbackToPayment() }</b>
&nbsp;        )
<b class="nc">&nbsp;    }.stateIn(</b>
<b class="nc">&nbsp;        viewModelScope,</b>
<b class="nc">&nbsp;        SharingStarted.WhileSubscribed(5000),</b>
<b class="nc">&nbsp;        FooterButtonProps()</b>
&nbsp;    )
&nbsp;
&nbsp;    private fun callbackToPayment() {
<b class="nc">&nbsp;        val vouchersToApply = state.value.selectedVouchers.filter {</b>
<b class="nc">&nbsp;            it.localType != VoucherLocalType.Invalid</b>
&nbsp;        }
<b class="nc">&nbsp;        val callbackData = ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;            ChoosePromotionCallbackData.serializer(), ChoosePromotionCallbackData(</b>
<b class="nc">&nbsp;                onPromotionChanged = true,</b>
<b class="nc">&nbsp;                selectedVouchers = vouchersToApply</b>
<b class="nc">&nbsp;                    .map {</b>
<b class="nc">&nbsp;                        val voucher: VoucherBase = it as VoucherBase</b>
<b class="nc">&nbsp;                        ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;                            serializer(),</b>
<b class="nc">&nbsp;                            voucher.toVoucherDTO()</b>
<b class="nc">&nbsp;                        )?.jsonObject</b>
<b class="nc">&nbsp;                            ?: emptyJsonObject()</b>
&nbsp;                    }
&nbsp;            )
<b class="nc">&nbsp;        )?.jsonObject</b>
&nbsp;
<b class="nc">&nbsp;        logger.i(&quot;[ChoosePromotionVM], callbackData=$callbackData&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        trackVoucherApplyButtonClicked(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = vouchersToApply.map { it.typeId }.joinToString(&quot;,&quot;),</b>
<b class="nc">&nbsp;            campaignId = vouchersToApply.map { it.campaign ?: it.extra?.campaignId }</b>
<b class="nc">&nbsp;                .joinToString(&quot;,&quot;),</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        navigator.dismiss(callbackData)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private var displayedVouchers: List&lt;IVoucherBase&gt; = emptyList()</b>
&nbsp;    fun onVoucherDisplayed(voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        if (displayedVouchers.any {</b>
<b class="nc">&nbsp;                (!voucher.ID.isNullOrBlank() &amp;&amp; it.ID == voucher.ID)</b>
<b class="nc">&nbsp;                        || (!voucher.extra?.collectId.isNullOrBlank() &amp;&amp; it.extra?.collectId == voucher.extra?.collectId)</b>
<b class="nc">&nbsp;                        || (!voucher.extra?.rewardId.isNullOrBlank() &amp;&amp; it.extra?.rewardId == voucher.extra?.rewardId)</b>
&nbsp;            }) {
&nbsp;            return
&nbsp;        }
<b class="nc">&nbsp;        displayedVouchers = displayedVouchers + voucher</b>
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherComponentDisplayed(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks the AB test for flat voucher reward feature and enables query execution.
&nbsp;     * This method determines whether to include voucher coin queries in the sequence.
&nbsp;     */
&nbsp;    private fun checkABTestFlatVoucherReward() {
<b class="nc">&nbsp;        abTestUseCase.invoke(</b>
<b class="nc">&nbsp;            namespace = PromotionABNamespace.VoucherRewardTTAT.code,</b>
<b class="nc">&nbsp;            defaultFlow = PromotionABTagname.Control.code,</b>
<b class="nc">&nbsp;            janusFlow = true</b>
<b class="nc">&nbsp;        ).onEach { treatment -&gt;</b>
<b class="nc">&nbsp;            logger.i(&quot;[ChoosePromotionVM] AB test treatment: $treatment&quot;)</b>
&nbsp;
&nbsp;            // Update state with AB test result
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetShouldFlatVoucherReward(</b>
<b class="nc">&nbsp;                    treatment == PromotionABTagname.FlatVcReward.code</b>
&nbsp;                )
&nbsp;            )
&nbsp;
&nbsp;            // Enable query sequence now that AB test is complete
&nbsp;            // This will trigger lazy creation of queries based on the AB test result
<b class="nc">&nbsp;            sequencedVoucherQuery.enabled.value = true</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-22 16:30</div>
</div>
</body>
</html>
