


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > PaymentSingleBillVM</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.singleBill.presentation.viewModel</a>
</div>

<h1>Coverage Summary for Class: PaymentSingleBillVM (vn.momo.compose.payment.singleBill.presentation.viewModel)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">PaymentSingleBillVM</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/136)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/848)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PaymentSingleBillVM$changeSof$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/166)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$changeSof$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$checkout$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/123)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$handleInitError$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$handleSplitBill$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/96)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$navigateChoosePromotion$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$navigateChoosePromotion$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onChangePromotion$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onCreate$$inlined$filter$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onCreate$$inlined$filter$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onCreate$$inlined$filter$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onCreate$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onCreate$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onCreate$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    25%
  </span>
  <span class="absValue">
    (1/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$onCreate$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$openSuggestSofBottomSheet$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/65)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$processConfirm$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/120)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$processConfirm$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$processConfirm$1$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$reInitWithNewAmount$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentSingleBillVM$special$$inlined$inject$default$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/48)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.7%
  </span>
  <span class="absValue">
    (1/150)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/278)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1722)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.singleBill.presentation.viewModel
&nbsp;
&nbsp;import kotlinx.coroutines.flow.catch
&nbsp;import kotlinx.coroutines.flow.filter
&nbsp;import kotlinx.coroutines.flow.launchIn
&nbsp;import kotlinx.coroutines.flow.onEach
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.json.buildJsonObject
&nbsp;import kotlinx.serialization.json.double
&nbsp;import kotlinx.serialization.json.int
&nbsp;import kotlinx.serialization.json.jsonPrimitive
&nbsp;import kotlinx.serialization.json.put
&nbsp;import org.koin.core.parameter.parametersOf
&nbsp;import vn.momo.compose.payment.base.core.composeApi.ILogger
&nbsp;import vn.momo.compose.payment.base.core.composeApi.INavigator
&nbsp;import vn.momo.compose.payment.base.core.composeApi.grafana.model.TraceParameter
&nbsp;import vn.momo.compose.payment.base.core.model.isBlockRevamp
&nbsp;import vn.momo.compose.payment.base.core.service.trace.GrafanaTrace
&nbsp;import vn.momo.compose.payment.base.core.service.trace.model.grafana.SBUserEvent
&nbsp;import vn.momo.compose.payment.base.domain.entities.ChangeSofActor
&nbsp;import vn.momo.compose.payment.base.domain.entities.ChoosePromotionCallbackData
&nbsp;import vn.momo.compose.payment.base.domain.entities.ConsentType
&nbsp;import vn.momo.compose.payment.base.domain.entities.SOFItem
&nbsp;import vn.momo.compose.payment.base.domain.entities.VoucherItemLocal
&nbsp;import vn.momo.compose.payment.base.domain.repository.ConsentManager
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.delegate.ConfirmViewModelTracking
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.reducer.SofReducer.Action
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.reducer.SofReducer.Effect
&nbsp;import vn.momo.compose.payment.di.PaymentKoinScope
&nbsp;import vn.momo.compose.payment.di.PaymentKoinScope.SINGLE
&nbsp;import vn.momo.compose.payment.payx.domain.entities.PromotionType
&nbsp;import vn.momo.compose.payment.base.domain.entities.overlayData.PayXBottomSheet
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.controller.paymentOverlay.OverlayEffect
&nbsp;import vn.momo.compose.payment.payx.presentation.model.CustomContentBottomSheetProps
&nbsp;import vn.momo.compose.payment.payx.presentation.model.SuggestedSofBottomSheetProps
&nbsp;import vn.momo.compose.payment.payx.presentation.model.SuggestedSofType
&nbsp;import vn.momo.compose.payment.payx.presentation.view.components.PromotionStatus
&nbsp;import vn.momo.compose.payment.payx.presentation.view.components.TrackStatusValue
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.reducers.UiVersion
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.ViewModel
&nbsp;import vn.momo.compose.payment.singleBill.data.dataSource.memory.SingleBillSession
&nbsp;import vn.momo.compose.payment.singleBill.data.repository.SBVoucherRepository
&nbsp;import vn.momo.compose.payment.singleBill.data.repository.transaction.SBTransactionManager
&nbsp;import vn.momo.compose.payment.singleBill.domain.entities.SBConfirmResponse
&nbsp;import vn.momo.compose.payment.singleBill.domain.entities.error.SingleBillError
&nbsp;import vn.momo.compose.payment.singleBill.domain.entities.error.isNoResponseErrorSB
&nbsp;import vn.momo.compose.payment.singleBill.domain.model.SBTransaction
&nbsp;import vn.momo.compose.payment.singleBill.domain.useCases.confirm.SBConfirmFactory
&nbsp;import vn.momo.compose.payment.singleBill.domain.useCases.confirm.SBConfirmParams
&nbsp;import vn.momo.compose.payment.singleBill.domain.useCases.confirm.SBHandleConfirmResponse
&nbsp;import vn.momo.compose.payment.singleBill.domain.useCases.voucher.GenerateSBChooseVouchersUseCase
&nbsp;import vn.momo.compose.payment.singleBill.presentation.model.SBConfirmScreenProps
&nbsp;import vn.momo.compose.payment.singleBill.presentation.model.SBPaymentEvent
&nbsp;import vn.momo.compose.payment.singleBill.presentation.viewModel.controller.error.handleSingleBillError
&nbsp;import vn.momo.compose.payment.singleBill.presentation.viewModel.controller.overlay.SBOverlay
&nbsp;import vn.momo.compose.payment.singleBill.presentation.viewModel.delegate.SBConfirmTracker
&nbsp;import vn.momo.compose.payment.singleBill.presentation.viewModel.reducer.SingleBillTransactionReducer
&nbsp;import vn.momo.compose.payment.singleBill.presentation.viewModel.slices.SingleSofSlice
&nbsp;import vn.momo.compose.utils.datamapping.ModelConvertUtils
&nbsp;import vn.momo.compose.utils.datamapping.emptyJsonObject
&nbsp;import vn.momo.core.modules.common.utilities.safePrintStackTrace
&nbsp;
&nbsp;class PaymentSingleBillVM(
<b class="nc">&nbsp;    private val koinId: String,</b>
<b class="nc">&nbsp;    private val navigator: INavigator,</b>
<b class="nc">&nbsp;    private val transactionManager: SBTransactionManager,</b>
<b class="nc">&nbsp;    private val sbConfirmFactory: SBConfirmFactory,</b>
<b class="nc">&nbsp;    private val session: SingleBillSession,</b>
<b class="nc">&nbsp;    private val logger: ILogger,</b>
<b class="nc">&nbsp;    private val consentManager: ConsentManager,</b>
<b class="nc">&nbsp;    private val generateChoosePromotionUseCase: GenerateSBChooseVouchersUseCase,</b>
<b class="nc">&nbsp;    private val voucherRepository: SBVoucherRepository,</b>
<b class="nc">&nbsp;    private val sbHandleConfirmResponse: SBHandleConfirmResponse,</b>
<b class="nc">&nbsp;    private val tracker: SBConfirmTracker,</b>
<b class="nc">&nbsp;) : ViewModel&lt;SingleBillTransactionReducer.State, SingleBillTransactionReducer.Action, SingleBillTransactionReducer.Effect&gt;(</b>
<b class="nc">&nbsp;    initialState = SingleBillTransactionReducer.State(), reducer = SingleBillTransactionReducer()</b>
&nbsp;), ConfirmViewModelTracking by tracker {
<b class="nc">&nbsp;    lateinit var props: SBConfirmScreenProps</b>
<b class="nc">&nbsp;    val sofSlice by PaymentKoinScope.getScope(SINGLE, koinId)</b>
<b class="nc">&nbsp;        .inject&lt;SingleSofSlice&gt; { parametersOf(viewModelScope) }</b>
&nbsp;
<b class="nc">&nbsp;    private val currentSof: SOFItem? get() = sofSlice.state.value.selected</b>
&nbsp;
&nbsp;    val version
<b class="nc">&nbsp;        get() = sofSlice.state.value.version</b>
&nbsp;
&nbsp;    override fun onCleared() {
<b class="nc">&nbsp;        PaymentKoinScope.end(koinId)</b>
<b class="nc">&nbsp;        trackScreenEnd()</b>
<b class="nc">&nbsp;        super.onCleared()</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    val discountCode get() = state.value.promotion.promoDisplay.find { it.promoType == PromotionType.DISCOUNT_CODE }?.promoId</b>
&nbsp;
&nbsp;    fun onCreate(params: Map&lt;String, Any?&gt;) {
<b class="nc">&nbsp;        props = SBConfirmScreenProps.fromMap(params) ?: SBConfirmScreenProps()</b>
<b class="nc">&nbsp;        getVersion(props.versionTag)</b>
<b class="nc">&nbsp;        trackScreenDisplay(version)</b>
<b class="nc">&nbsp;        sofSlice.effect.onEach {</b>
<b class="nc">&nbsp;            when (it) {</b>
<b class="nc">&nbsp;                is Effect.InitSofTransaction -&gt; changeSof(it)</b>
&nbsp;                else -&gt; {}
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        checkout()</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            consentManager.getConfig()</b>
&nbsp;        }
<b class="nc">&nbsp;        session.sbEvent.onEach {</b>
<b class="nc">&nbsp;            when (it) {</b>
<b class="nc">&nbsp;                is SBPaymentEvent.AllowToConfirm -&gt; enableConfirm()</b>
<b class="nc">&nbsp;                is SBPaymentEvent.HandleOverlayEffect -&gt; currentSof?.let { sof -&gt;</b>
<b class="nc">&nbsp;                    handleOverlayEffect(it.effect, sof)</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        consentManager.consentInfo.filter { consent -&gt; consent.type != ConsentType.None }.onEach {</b>
<b class="nc">&nbsp;            navigator.showBottomSheet(buildJsonObject {</b>
<b class="nc">&nbsp;                put(&quot;type&quot;, &quot;payx_consent&quot;)</b>
<b class="nc">&nbsp;                put(&quot;cancelable&quot;, false)</b>
<b class="nc">&nbsp;            }).launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun checkout() {
<b class="nc">&nbsp;        dispatch(SingleBillTransactionReducer.Action.SetLoading(true))</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
&nbsp;            try {
<b class="nc">&nbsp;                transactionManager.checkout(props).also { initData -&gt;</b>
<b class="nc">&nbsp;                    if (!initData.exception.isNoResponseErrorSB()) {</b>
<b class="nc">&nbsp;                        updateTransaction(initData.data)</b>
<b class="nc">&nbsp;                        sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                            initData.data.selectedSof,</b>
<b class="nc">&nbsp;                            null</b>
&nbsp;                        )
&nbsp;                    }
<b class="nc">&nbsp;                    trackScreenInteracted(</b>
<b class="nc">&nbsp;                        initTransaction = initData.data,</b>
<b class="nc">&nbsp;                        version,</b>
<b class="nc">&nbsp;                        checkoutGrafanaId = session.request.grafanaId?.checkout ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                        checkoutFlow = &quot;single&quot;</b>
&nbsp;                    )
<b class="nc">&nbsp;                    if (initData.isFailure) {</b>
<b class="nc">&nbsp;                        when (initData.exception) {</b>
<b class="nc">&nbsp;                            is SingleBillError.SofError -&gt; {</b>
<b class="nc">&nbsp;                                openSuggestSofBottomSheet(</b>
<b class="nc">&nbsp;                                    shouldSuggestFirstSof = true</b>
&nbsp;                                )
&nbsp;                            }
&nbsp;
<b class="nc">&nbsp;                            is SingleBillError.Voucher -&gt; {</b>
&nbsp;                                // TODO: Skip error
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;            } catch (exception: Exception) {
<b class="nc">&nbsp;                GrafanaTrace.stop(</b>
<b class="nc">&nbsp;                    session.request.grafanaId?.checkout ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                    SBUserEvent.ScreenInteracted.event,</b>
<b class="nc">&nbsp;                    false,</b>
<b class="nc">&nbsp;                    TraceParameter()</b>
&nbsp;                )
<b class="nc">&nbsp;                logger.e(&quot;Checkout failed: ${exception.safePrintStackTrace()}&quot;)</b>
<b class="nc">&nbsp;                navigator.dismiss()</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun changeSof(action: Effect.InitSofTransaction) {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            sofSlice.onUpdateTransaction()</b>
<b class="nc">&nbsp;            trackStartCallAPIChangeSof()</b>
<b class="nc">&nbsp;            state.value.invoice.firstOrNull()?.also { invoice -&gt;</b>
<b class="nc">&nbsp;                val vouchers = voucherRepository.getSelectedLocalVoucher()</b>
<b class="nc">&nbsp;                val firstSelectedVoucher =</b>
<b class="nc">&nbsp;                    state.value.promotion.promoDisplay.firstOrNull { it.promoType == PromotionType.MOMO_VOUCHER }?.promoId</b>
<b class="nc">&nbsp;                val appliedVouchers =</b>
<b class="nc">&nbsp;                    vouchers.find { it.ID == firstSelectedVoucher }</b>
<b class="nc">&nbsp;                        ?.let { listOf(it) }</b>
&nbsp;                try {
<b class="nc">&nbsp;                    transactionManager.update(</b>
<b class="nc">&nbsp;                        action.sof,</b>
<b class="nc">&nbsp;                        sofSlice.state.value.list,</b>
<b class="nc">&nbsp;                        invoice,</b>
<b class="nc">&nbsp;                        appliedVouchers,</b>
<b class="nc">&nbsp;                        discountCode = discountCode,</b>
<b class="nc">&nbsp;                        props.paymentInfo</b>
<b class="nc">&nbsp;                    ).collect { result -&gt;</b>
<b class="nc">&nbsp;                        if (!result.exception.isNoResponseErrorSB()) {</b>
<b class="nc">&nbsp;                            updateTransaction(result.data)</b>
&nbsp;                        }
<b class="nc">&nbsp;                        if (result.isFailure) {</b>
<b class="nc">&nbsp;                            handleInitError(result.exception, action.sof)</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                } catch (e: Throwable) {
<b class="nc">&nbsp;                    logger.e(&quot;[SBNative] Why response null: ${e.message}&quot;)</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun handleInitError(initError: Throwable, sof: SOFItem) {
<b class="nc">&nbsp;        when (val error = initError as SingleBillError) {</b>
<b class="nc">&nbsp;            is SingleBillError.DevError -&gt; TODO()</b>
<b class="nc">&nbsp;            is SingleBillError.QD2345, is SingleBillError.CustomPopupError -&gt; {</b>
<b class="nc">&nbsp;                val data = (when (error) {</b>
<b class="nc">&nbsp;                    is SingleBillError.QD2345 -&gt; error.overlay.toPayXBottomSheet()</b>
<b class="nc">&nbsp;                    is SingleBillError.CustomPopupError -&gt; {</b>
<b class="nc">&nbsp;                        trackErrorPopup(error.code, version)</b>
<b class="nc">&nbsp;                        error.dialog.copy(</b>
<b class="nc">&nbsp;                            flowType = &quot;single&quot;,</b>
<b class="nc">&nbsp;                            tagName = version.name,</b>
&nbsp;                        )
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    else -&gt; null</b>
&nbsp;                })!!
<b class="nc">&nbsp;                handleOverlayEffect(SBOverlay(navigator, data).handle(), sof)</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            is SingleBillError.SofError -&gt; openSuggestSofBottomSheet(</b>
<b class="nc">&nbsp;                shouldSuggestFirstSof = true</b>
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            is SingleBillError.SplitBill -&gt; TODO()</b>
&nbsp;
&nbsp;            else -&gt; {}
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleOverlayEffect(effect: OverlayEffect?, sof: SOFItem) {
<b class="nc">&nbsp;        when (effect) {</b>
<b class="nc">&nbsp;            null -&gt; Unit</b>
<b class="nc">&nbsp;            OverlayEffect.AddSof -&gt; addSof()</b>
<b class="nc">&nbsp;            OverlayEffect.OpenSof -&gt; openSuggestSofBottomSheet(</b>
<b class="nc">&nbsp;                shouldSuggestFirstSof = true</b>
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            OverlayEffect.ReinitTransaction -&gt; changeSof(</b>
<b class="nc">&nbsp;                Effect.InitSofTransaction(</b>
<b class="nc">&nbsp;                    sof = sof, actor = ChangeSofActor.Overlay</b>
&nbsp;                )
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            OverlayEffect.CashIn -&gt; sofSlice.onCashIn(</b>
<b class="nc">&nbsp;                targetAmount = state.value.amount.total.value,</b>
<b class="nc">&nbsp;                targetSource = sof.moneySource</b>
&nbsp;            )
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun updateTransaction(data: SBTransaction) {
<b class="nc">&nbsp;        dispatch(SingleBillTransactionReducer.Action.SetTransaction(data))</b>
<b class="nc">&nbsp;        sofSlice.dispatch(</b>
<b class="nc">&nbsp;            Action.SetSofList(</b>
<b class="nc">&nbsp;                list = data.sofList,</b>
<b class="nc">&nbsp;                selected = data.selectedSof,</b>
&nbsp;            )
&nbsp;        )
<b class="nc">&nbsp;        if (data.isEmptySof) {</b>
<b class="nc">&nbsp;            sofSlice.refetchSof()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun goBack() {
<b class="nc">&nbsp;        trackGoBack(version)</b>
<b class="nc">&nbsp;        navigator.dismiss()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun enableConfirm() {
<b class="nc">&nbsp;        dispatch(SingleBillTransactionReducer.Action.SetEnableConfirm(true))</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun handleSplitBill(bottomSheet: PayXBottomSheet) {
<b class="nc">&nbsp;        navigator.showBottomSheet(buildJsonObject {</b>
<b class="nc">&nbsp;            put(&quot;type&quot;, &quot;customContent&quot;)</b>
<b class="nc">&nbsp;            put(</b>
<b class="nc">&nbsp;                &quot;props&quot;, ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;                    CustomContentBottomSheetProps.serializer(),</b>
<b class="nc">&nbsp;                    CustomContentBottomSheetProps(data = bottomSheet, shouldDismiss = false)</b>
<b class="nc">&nbsp;                ) ?: emptyJsonObject()</b>
&nbsp;            )
<b class="nc">&nbsp;        }).onEach { data -&gt;</b>
<b class="nc">&nbsp;            val index = data[&quot;index&quot;]?.jsonPrimitive?.int</b>
<b class="nc">&nbsp;            val button = index?.let { bottomSheet.buttons?.getOrNull(index) }</b>
<b class="nc">&nbsp;            when (button?.action) {</b>
<b class="nc">&nbsp;                &quot;REDIRECT_TO_REFID&quot; -&gt; navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;                    button.refId ?: &quot;&quot;, button.refParams ?: emptyJsonObject()</b>
&nbsp;                )
&nbsp;
<b class="nc">&nbsp;                &quot;RETRY_WITH_REMAIN_AMOUNT&quot; -&gt; {</b>
<b class="nc">&nbsp;                    val remainAmount = button.refParams?.get(&quot;remainAmount&quot;)?.jsonPrimitive?.double</b>
<b class="nc">&nbsp;                    reInitWithNewAmount(remainAmount)</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun reInitWithNewAmount(amount: Double?) {
<b class="nc">&nbsp;        sofSlice.onUpdateTransaction()</b>
<b class="nc">&nbsp;        state.value.invoice.firstOrNull()?.let { invoice -&gt;</b>
<b class="nc">&nbsp;            currentSof?.let { sof -&gt;</b>
<b class="nc">&nbsp;                transactionManager.reInitWithNewAmount(</b>
<b class="nc">&nbsp;                    amount, sof, sofSlice.state.value.list, invoice, props.paymentInfo</b>
<b class="nc">&nbsp;                ).onEach { result -&gt;</b>
<b class="nc">&nbsp;                    if (!result.exception.isNoResponseErrorSB()) {</b>
<b class="nc">&nbsp;                        updateTransaction(result.data)</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if (result.isFailure) {</b>
<b class="nc">&nbsp;                        handleInitError(result.exception, sof)</b>
&nbsp;                    }
<b class="nc">&nbsp;                }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun processConfirm() {
<b class="nc">&nbsp;        dispatch(SingleBillTransactionReducer.Action.SetEnableConfirm(false))</b>
<b class="nc">&nbsp;        tracker.trackTriggerConfirm(state.value, currentSof, version)</b>
&nbsp;
<b class="nc">&nbsp;        val bottomSheet = sbConfirmFactory.shouldHandleSplitBill()</b>
<b class="nc">&nbsp;        if (bottomSheet != null) {</b>
<b class="nc">&nbsp;            tracker.trackBottomSheetConfirmDisplayed()</b>
<b class="nc">&nbsp;            handleSplitBill(bottomSheet)</b>
&nbsp;        } else {
<b class="nc">&nbsp;            trackStartRedirect()</b>
<b class="nc">&nbsp;            sbConfirmFactory.requestPinKey().onEach {</b>
<b class="nc">&nbsp;                when (it.status) {</b>
&nbsp;                    &quot;SUCCESS&quot;, &quot;ALREADY_EXISTS&quot; -&gt; {
<b class="nc">&nbsp;                        trackAuthenticationSuccess()</b>
<b class="nc">&nbsp;                        state.value.invoice.firstOrNull()?.let { invoice -&gt;</b>
<b class="nc">&nbsp;                            sbConfirmFactory.execute(</b>
<b class="nc">&nbsp;                                SBConfirmParams(</b>
<b class="nc">&nbsp;                                    msgType = props.confirmMsgType ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                                    bankOtp = null,</b>
<b class="nc">&nbsp;                                    currentSof = currentSof,</b>
<b class="nc">&nbsp;                                    tranType = props.tranType,</b>
<b class="nc">&nbsp;                                    currentInvoice = invoice,</b>
<b class="nc">&nbsp;                                    amount = state.value.amount.total.value,</b>
<b class="nc">&nbsp;                                    currentPaymentInfo = props.paymentInfo</b>
&nbsp;                                )
<b class="nc">&nbsp;                            ).onEach { data -&gt;</b>
<b class="nc">&nbsp;                                when (data) {</b>
<b class="nc">&nbsp;                                    is SBConfirmResponse.ToPaymentResult -&gt; {</b>
<b class="nc">&nbsp;                                        sbHandleConfirmResponse(</b>
<b class="nc">&nbsp;                                            data.response, GrafanaTrace.getTraceIds(</b>
<b class="nc">&nbsp;                                                listOf(</b>
<b class="nc">&nbsp;                                                    SBUserEvent.E2ECheckoutToResult.event,</b>
<b class="nc">&nbsp;                                                    SBUserEvent.RedirectPaymentResult.event</b>
&nbsp;                                                )
<b class="nc">&nbsp;                                            ).filterNotNull()</b>
&nbsp;                                        )
<b class="nc">&nbsp;                                        voucherRepository.clearSelectedVouchers()</b>
&nbsp;                                    }
&nbsp;
<b class="nc">&nbsp;                                    is SBConfirmResponse.Retry -&gt; {</b>
<b class="nc">&nbsp;                                        trackRedirectFail()</b>
<b class="nc">&nbsp;                                        enableConfirm()</b>
&nbsp;                                    }
&nbsp;
<b class="nc">&nbsp;                                    is SBConfirmResponse.Suspend -&gt; {}</b>
&nbsp;                                }
&nbsp;                            }
<b class="nc">&nbsp;                                .catch { err -&gt;</b>
<b class="nc">&nbsp;                                    trackRedirectFail()</b>
&nbsp;                                    throw err
&nbsp;                                }
<b class="nc">&nbsp;                                .handleSingleBillError().launchIn(viewModelScope)</b>
<b class="nc">&nbsp;                        }</b>
&nbsp;                    }
&nbsp;
&nbsp;                    &quot;BACK_PRESS&quot;, &quot;CLOSE&quot; -&gt; {
<b class="nc">&nbsp;                        trackRedirectFail()</b>
<b class="nc">&nbsp;                        trackAuthenticationFail()</b>
<b class="nc">&nbsp;                        enableConfirm()</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }.launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onClickShowAll() {
<b class="nc">&nbsp;        trackClickShowAllSof(version)</b>
<b class="nc">&nbsp;        openSuggestSofBottomSheet(false)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun openSuggestSofBottomSheet(shouldSuggestFirstSof: Boolean) {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            if (shouldSuggestFirstSof) {</b>
<b class="nc">&nbsp;                GrafanaTrace.count(SBUserEvent.SuggestFirstSofBts.event)</b>
&nbsp;            }
<b class="nc">&nbsp;            navigator.showBottomSheet(buildJsonObject {</b>
<b class="nc">&nbsp;                put(&quot;type&quot;, &quot;suggestedSof&quot;)</b>
<b class="nc">&nbsp;                put(</b>
<b class="nc">&nbsp;                    &quot;props&quot;, ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;                        SuggestedSofBottomSheetProps.serializer(), SuggestedSofBottomSheetProps(</b>
<b class="nc">&nbsp;                            isAllowAddSOF = true,</b>
<b class="nc">&nbsp;                            isAllowAddCard = false,</b>
<b class="nc">&nbsp;                            shouldSuggestFirstSof,</b>
<b class="nc">&nbsp;                            transactionAmount = state.value.amount.total.value,</b>
<b class="nc">&nbsp;                            koinId = koinId,</b>
<b class="nc">&nbsp;                            suggestedSofType = SuggestedSofType.Single.name</b>
&nbsp;                        )
<b class="nc">&nbsp;                    ) ?: emptyJsonObject()</b>
&nbsp;                )
<b class="nc">&nbsp;                put(&quot;cancelable&quot;, true)</b>
<b class="nc">&nbsp;            }).launchIn(this)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun addSof() {
<b class="nc">&nbsp;        sofSlice.trackItemSofClicked(&quot;add_sof&quot;, version)</b>
<b class="nc">&nbsp;        val serviceId = session.request.reqMomoMsg?.serviceId</b>
<b class="nc">&nbsp;        sofSlice.addBankToSof(serviceId, isFromCashIn = true)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    fun addCard() {}</b>
&nbsp;
&nbsp;    fun onToggleCartDetail(newState: String) {
<b class="nc">&nbsp;        trackCartDetailTriggered(value = newState, version)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun cancelPromotion() {
<b class="nc">&nbsp;        onChangePromotion()</b>
<b class="nc">&nbsp;        voucherRepository.clearSelectedVouchers()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun navigateChoosePromotion() {
<b class="nc">&nbsp;        val promotions = state.value.promotion.promoDisplay</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            val params = generateChoosePromotionUseCase(promotions, discountCode)</b>
<b class="nc">&nbsp;            trackChoosePromotion(null, version)</b>
<b class="nc">&nbsp;            navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;                &quot;select_promotion&quot;, params, ChoosePromotionCallbackData.serializer()</b>
<b class="nc">&nbsp;            ).onEach { callbackData -&gt;</b>
<b class="nc">&nbsp;                logger.i(&quot;[PayX-SB] - select_vouchers: $callbackData&quot;)</b>
<b class="nc">&nbsp;                callbackData?.let {</b>
<b class="nc">&nbsp;                    if (it.onPromotionChanged) {</b>
<b class="nc">&nbsp;                        val selectedVouchers =</b>
<b class="nc">&nbsp;                            voucherRepository.storedVoucherToLocal(it.selectedVouchers)</b>
<b class="nc">&nbsp;                        trackChoosePromotionSuccess()</b>
<b class="nc">&nbsp;                        onChangePromotion(</b>
<b class="nc">&nbsp;                            selectedVouchers, it.discountCode</b>
&nbsp;                        )
&nbsp;                    } else {
<b class="nc">&nbsp;                        trackChoosePromotionFail()</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }.launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun navigateChoosePromotionV2(status: PromotionStatus) {
<b class="nc">&nbsp;        when (status.trackStatus) {</b>
<b class="nc">&nbsp;            TrackStatusValue.EMPTY.id -&gt; tracker.trackChoosePromotionSB()</b>
<b class="nc">&nbsp;            TrackStatusValue.AT_LEAST_ONE_INVALID.id -&gt; {</b>
<b class="nc">&nbsp;                tracker.trackClearPromotionSB()</b>
<b class="nc">&nbsp;                onChangePromotion(emptyList(), discountCode)</b>
&nbsp;                return
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            TrackStatusValue.ALL_SUCCESS.id -&gt; tracker.trackChangePromotionSB()</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        navigateChoosePromotion()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun onChangePromotion(
<b class="nc">&nbsp;        selectedVouchers: List&lt;VoucherItemLocal&gt;? = null, discountCode: String? = null,</b>
&nbsp;    ) {
<b class="nc">&nbsp;        sofSlice.onUpdateTransaction()</b>
<b class="nc">&nbsp;        trackChangePromotion()</b>
<b class="nc">&nbsp;        state.value.invoice.firstOrNull()?.let { invoice -&gt;</b>
<b class="nc">&nbsp;            currentSof?.let { sof -&gt;</b>
<b class="nc">&nbsp;                transactionManager.update(</b>
<b class="nc">&nbsp;                    sof,</b>
<b class="nc">&nbsp;                    sofSlice.state.value.list,</b>
<b class="nc">&nbsp;                    invoice,</b>
<b class="nc">&nbsp;                    selectedVouchers,</b>
<b class="nc">&nbsp;                    discountCode,</b>
<b class="nc">&nbsp;                    props.paymentInfo</b>
<b class="nc">&nbsp;                ).onEach { result -&gt;</b>
<b class="nc">&nbsp;                    if (!result.exception.isNoResponseErrorSB()) {</b>
<b class="nc">&nbsp;                        updateTransaction(result.data)</b>
&nbsp;                    }
<b class="nc">&nbsp;                    trackChangeSofFinished(result)</b>
<b class="nc">&nbsp;                    if (result.isFailure) {</b>
<b class="nc">&nbsp;                        handleInitError(result.exception, sof)</b>
&nbsp;                    }
<b class="nc">&nbsp;                }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun getVersion(tag: String?) {
<b class="nc">&nbsp;        val isBlocked = session.request.isBlockRevamp()</b>
<b class="nc">&nbsp;        val version = if (tag == &quot;treatment_1&quot; &amp;&amp; !isBlocked) 2 else 1</b>
<b class="nc">&nbsp;        sofSlice.dispatch(</b>
<b class="nc">&nbsp;            Action.UpdateVersion(UiVersion(code = version, name = tag ?: &quot;control&quot;))</b>
&nbsp;        )
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-22 16:30</div>
</div>
</body>
</html>
