


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > SBConfirmFactory</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.singleBill.domain.useCases.confirm</a>
</div>

<h1>Coverage Summary for Class: SBConfirmFactory (vn.momo.compose.payment.singleBill.domain.useCases.confirm)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">SBConfirmFactory</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/37)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/224)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SBConfirmFactory$execute$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$execute$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/94)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$execute$1$1$confirmJob$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/76)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$execute$1$1$confirmJob$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$execute$1$1$confirmJob$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/27)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$execute$1$1$mqttJob$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$execute$1$1$mqttJob$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$listenMqttP2P$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$listenMqttP2P$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$listenMqttP2P$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$requestPinKey$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$requestPinKey$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SBConfirmFactory$requestPinKey$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/506)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.singleBill.domain.useCases.confirm
&nbsp;
&nbsp;import kotlinx.coroutines.CoroutineScope
&nbsp;import kotlinx.coroutines.Dispatchers
&nbsp;import kotlinx.coroutines.IO
&nbsp;import kotlinx.coroutines.coroutineScope
&nbsp;import kotlinx.coroutines.flow.Flow
&nbsp;import kotlinx.coroutines.flow.launchIn
&nbsp;import kotlinx.coroutines.flow.MutableSharedFlow
&nbsp;import kotlinx.coroutines.flow.emitAll
&nbsp;import kotlinx.coroutines.flow.first
&nbsp;import kotlinx.coroutines.flow.flow
&nbsp;import kotlinx.coroutines.flow.map
&nbsp;import kotlinx.coroutines.flow.onEach
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.json.JsonObject
&nbsp;import kotlinx.serialization.json.buildJsonObject
&nbsp;import kotlinx.serialization.json.put
&nbsp;import org.koin.core.scope.Scope
&nbsp;import vn.momo.compose.payment.base.core.composeApi.ILogger
&nbsp;import vn.momo.compose.payment.base.core.composeApi.network.IRemoteService
&nbsp;import vn.momo.compose.payment.base.core.composeApi.network.model.PinKeySessionResponse
&nbsp;import vn.momo.compose.payment.base.domain.entities.SOFItem
&nbsp;import vn.momo.core.features.payment.model.EnumPaymentType
&nbsp;import vn.momo.compose.payment.payx.domain.entities.InvoiceItem
&nbsp;import vn.momo.compose.payment.base.domain.entities.overlayData.PayXBottomSheet
&nbsp;import vn.momo.compose.payment.singleBill.data.dataSource.dto.PaymentInfoDTO
&nbsp;import vn.momo.compose.payment.singleBill.data.dataSource.memory.SBSavedTransaction
&nbsp;import vn.momo.compose.payment.singleBill.data.repository.confirm.SBPaymentStatusRepository
&nbsp;import vn.momo.compose.payment.singleBill.domain.entities.SBConfirmResponse
&nbsp;import vn.momo.compose.payment.singleBill.domain.entities.error.SingleBillError
&nbsp;import vn.momo.compose.payment.singleBill.presentation.viewModel.controller.error.handleSingleBillError
&nbsp;import vn.momo.compose.utils.datamapping.emptyJsonObject
&nbsp;import vn.momo.core.features.sofManager.constants.MoneySource
&nbsp;
&nbsp;
&nbsp;data class SBConfirmParams(
&nbsp;    val msgType: String,
&nbsp;    val bankOtp: String?,
&nbsp;    val confirmExtras: JsonObject = emptyJsonObject(),
&nbsp;    val currentSof: SOFItem? = null,
&nbsp;    val ID: String? = null,
&nbsp;    val sofList: List&lt;SOFItem&gt; = emptyList(),
&nbsp;    val currentInvoice: InvoiceItem,
&nbsp;    val tranType: Int?,
&nbsp;    val amount: Long,
&nbsp;    val currentPaymentInfo: List&lt;PaymentInfoDTO&gt;
&nbsp;)
&nbsp;
&nbsp;interface SBConfirmUseCase {
&nbsp;    fun confirm(params: SBConfirmParams): Flow&lt;SBConfirmResponse&gt;
&nbsp;}
&nbsp;
<b class="nc">&nbsp;class SBConfirmFactory(</b>
<b class="nc">&nbsp;    private val koinScope: Scope,</b>
<b class="nc">&nbsp;    private val savedSingleBillData: SBSavedTransaction,</b>
<b class="nc">&nbsp;    private val pinKeyService: IRemoteService,</b>
<b class="nc">&nbsp;    private val sbPaymentStatusRepository: SBPaymentStatusRepository,</b>
<b class="nc">&nbsp;    private val logger: ILogger</b>
&nbsp;) {
&nbsp;    private fun create(tranType: Int?, currentSof: SOFItem?): SBConfirmUseCase {
<b class="nc">&nbsp;        val isCiCoOrRelated = listOf(</b>
<b class="nc">&nbsp;            EnumPaymentType.CashIn.id,</b>
<b class="nc">&nbsp;            EnumPaymentType.CashOut.id,</b>
<b class="nc">&nbsp;            EnumPaymentType.WithdrawFundGroup.id</b>
<b class="nc">&nbsp;        ).contains(tranType)</b>
<b class="nc">&nbsp;        val isCashOut = tranType == EnumPaymentType.CashOut.id</b>
<b class="nc">&nbsp;        return when (currentSof?.moneySource?.id) {</b>
<b class="nc">&nbsp;            MoneySource.Bank.id -&gt; handleBankSource(isCashOut)</b>
<b class="nc">&nbsp;            MoneySource.Card.id -&gt; handleCardSource(isCiCoOrRelated)</b>
<b class="nc">&nbsp;            MoneySource.Napas.id -&gt; handleNapasSource(isCiCoOrRelated, currentSof)</b>
<b class="nc">&nbsp;            else -&gt; koinScope.get&lt;SBDefaultConfirmUseCase&gt;()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleBankSource(isCashOut: Boolean): SBConfirmUseCase {
<b class="nc">&nbsp;        return if (isCashOut) {</b>
<b class="nc">&nbsp;            koinScope.get&lt;SBDefaultConfirmUseCase&gt;()</b>
&nbsp;        } else {
<b class="nc">&nbsp;            koinScope.get&lt;SBBankConfirmUseCase&gt;()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleCardSource(isCiCoOrRelated: Boolean): SBConfirmUseCase {
<b class="nc">&nbsp;        return if (isCiCoOrRelated) {</b>
<b class="nc">&nbsp;            koinScope.get&lt;SBCreditConfirmUseCase&gt;()</b>
&nbsp;        } else {
<b class="nc">&nbsp;            koinScope.get&lt;SBConfirmTwoStepUseCase&gt;()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleNapasSource(
&nbsp;        isCiCoOrRelated: Boolean,
&nbsp;        currentSof: SOFItem
&nbsp;    ): SBConfirmUseCase {
<b class="nc">&nbsp;        return if (isCiCoOrRelated) {</b>
<b class="nc">&nbsp;            if (currentSof.isNapasNotLinked) {</b>
<b class="nc">&nbsp;                koinScope.get&lt;SBNapasNotLinkedConfirmUseCase&gt;()</b>
&nbsp;            } else {
<b class="nc">&nbsp;                koinScope.get&lt;SBNapasLinkedConfirmUseCase&gt;()</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            koinScope.get&lt;SBConfirmTwoStepUseCase&gt;()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun listenMqttP2P(): Flow&lt;SBConfirmResponse&gt; {
<b class="nc">&nbsp;        return sbPaymentStatusRepository.listenMqtt().map {</b>
&nbsp;            return@map SBConfirmResponse.ToPaymentResult(it)
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    fun execute(params: SBConfirmParams): Flow&lt;SBConfirmResponse&gt; = flow {</b>
<b class="nc">&nbsp;        if (params.msgType != &quot;M2MU_CONFIRM&quot;) {</b>
<b class="nc">&nbsp;            emitAll(create(params.tranType, params.currentSof).confirm(params))</b>
&nbsp;            return@flow
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        coroutineScope {</b>
<b class="nc">&nbsp;            val resultFlow = MutableSharedFlow&lt;SBConfirmResponse&gt;(replay = 1)</b>
&nbsp;
&nbsp;            // Job listenMqtt
<b class="nc">&nbsp;            val mqttJob = launch {</b>
<b class="nc">&nbsp;                listenMqttP2P().collect {</b>
<b class="nc">&nbsp;                    resultFlow.emit(it)</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // Job confirmP2P
<b class="nc">&nbsp;            val confirmJob = launch {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    create(params.tranType, params.currentSof)</b>
<b class="nc">&nbsp;                        .confirm(params)</b>
<b class="nc">&nbsp;                        .collect { resultFlow.emit(it) }</b>
&nbsp;                } catch (err: Throwable) {
<b class="nc">&nbsp;                    logger.i(&quot;[PayX] ConfirmError.err: $err&quot;)</b>
<b class="nc">&nbsp;                    logger.i(&quot;[PayX] ConfirmError.params: $params&quot;)</b>
<b class="nc">&nbsp;                    if (err is SingleBillError.SystemError &amp;&amp; params.msgType == &quot;M2MU_CONFIRM&quot;) {</b>
<b class="nc">&nbsp;                        sbPaymentStatusRepository.getPaymentStatus()</b>
<b class="nc">&nbsp;                            .onEach {</b>
<b class="nc">&nbsp;                                logger.i(&quot;[PayX] getPaymentStatus.response: $it&quot;)</b>
<b class="nc">&nbsp;                                mqttJob.cancel()</b>
<b class="nc">&nbsp;                                resultFlow.emit(SBConfirmResponse.ToPaymentResult(it))</b>
&nbsp;                            }
<b class="nc">&nbsp;                            .handleSingleBillError().launchIn(CoroutineScope(Dispatchers.IO))</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        throw err</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            emit(resultFlow.first())</b>
<b class="nc">&nbsp;            confirmJob.cancel()</b>
<b class="nc">&nbsp;            mqttJob.cancel()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
<b class="nc">&nbsp;    fun requestPinKey(pinKey: String? = null): Flow&lt;PinKeySessionResponse&gt; {</b>
<b class="nc">&nbsp;        return pinKeyService.requestPinKey(pinKey, buildJsonObject {</b>
<b class="nc">&nbsp;            put(&quot;source&quot;, &quot;request_payment&quot;)</b>
<b class="nc">&nbsp;            put(</b>
<b class="nc">&nbsp;                &quot;service_code&quot;, savedSingleBillData.data?.serviceId ?: &quot;&quot;</b>
&nbsp;            )
<b class="nc">&nbsp;        }).map {</b>
&nbsp;            if (it?.status == &quot;SUCCESS&quot;) {
&nbsp;                savedSingleBillData.pinKeySessionId = it.pinKeySessionID ?: &quot;&quot;
&nbsp;            }
&nbsp;            it ?: PinKeySessionResponse(status = &quot;CLOSE&quot;)
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun shouldHandleSplitBill(): PayXBottomSheet? {
<b class="nc">&nbsp;        return savedSingleBillData.data?.tranHisMsg?.extras?.bottomSheetConfig?.toPayXBottomSheet()</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-22 16:30</div>
</div>
</body>
</html>
