


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > PaymentConfirmVM</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.payx.presentation.viewModel</a>
</div>

<h1>Coverage Summary for Class: PaymentConfirmVM (vn.momo.compose.payment.payx.presentation.viewModel)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">PaymentConfirmVM</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.5%
  </span>
  <span class="absValue">
    (1/182)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/387)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2692)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PaymentConfirmVM$changeSof$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$changeSof$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/109)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$changeSof$1$1$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$checkout$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/214)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$checkout$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/353)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$checkout$2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/42)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$checkout$2$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/74)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$confirmSkipLoading$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$confirmSkipLoading$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$confirmSkipLoading$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$confirmWithLoading$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$getAmountInfo$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleConfirmOtp$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleOnDirectDebit$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/64)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleOnDirectDebit$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleRegisterDirectDebit$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleServiceCartOverlay$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleShowDDToast$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/202)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleShowDDToast$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleShowDDToast$1$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$handleWebOtp$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/56)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$navigateChoosePromotion$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$navigateChoosePromotion$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/44)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onAddCart$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/97)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onAddCart$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/59)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onAddCart$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onChangePromotion$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onConfirm$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/121)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onConfirm$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/45)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onConfirm$2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onConfirm$2$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$combine$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$combine$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$combine$1$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$filter$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$filter$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$filter$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$10</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$11</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$12</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/125)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$13</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/89)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$14</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$15$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/43)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onCreate$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onFirstCheckoutResponse$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onFirstCheckoutResponse$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onFirstCheckoutResponse$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onRemoveCart$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/46)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onRemoveCart$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/73)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$onRemoveCart$1$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$open3DS$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$openInstallmentInstruction$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$openPaymentGateway$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$openSuggestSofBottomSheet$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/68)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$quickPayFallback$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$quickPayFallback$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$special$$inlined$inject$default$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$special$$inlined$inject$default$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$special$$inlined$inject$default$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$special$$inlined$inject$default$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$special$$inlined$inject$default$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$startBankOTPConfirm$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/122)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$startBankOTPConfirm$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$startNapasConfirm$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/151)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$startNapasConfirm$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$updateTransaction$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$updateTransaction$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$updateTransaction$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$verifyFraudData$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$verifyFraudData$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentConfirmVM$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/124)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0.3%
  </span>
  <span class="absValue">
    (1/355)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/809)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5672)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.payx.presentation.viewModel
&nbsp;
&nbsp;import kotlinx.coroutines.FlowPreview
&nbsp;import kotlinx.coroutines.TimeoutCancellationException
&nbsp;import kotlinx.coroutines.async
&nbsp;import kotlinx.coroutines.flow.asStateFlow
&nbsp;import kotlinx.coroutines.flow.catch
&nbsp;import kotlinx.coroutines.flow.combine
&nbsp;import kotlinx.coroutines.flow.distinctUntilChanged
&nbsp;import kotlinx.coroutines.flow.filter
&nbsp;import kotlinx.coroutines.flow.launchIn
&nbsp;import kotlinx.coroutines.flow.map
&nbsp;import kotlinx.coroutines.flow.onCompletion
&nbsp;import kotlinx.coroutines.flow.onEach
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.builtins.serializer
&nbsp;import kotlinx.serialization.json.JsonObject
&nbsp;import kotlinx.serialization.json.buildJsonObject
&nbsp;import kotlinx.serialization.json.put
&nbsp;import org.jetbrains.compose.resources.getString
&nbsp;import org.koin.core.parameter.parametersOf
&nbsp;import org.koin.core.scope.Scope
&nbsp;import vn.momo.compose.payment.base.core.composeApi.ILogger
&nbsp;import vn.momo.compose.payment.base.core.composeApi.INavigator
&nbsp;import vn.momo.compose.payment.base.core.composeApi.grafana.model.TraceParameter
&nbsp;import vn.momo.compose.payment.base.core.composeApi.observer.PayXObserver
&nbsp;import vn.momo.compose.payment.base.core.model.NavigatorErrorPopup
&nbsp;import vn.momo.compose.payment.base.core.model.blockRevamp
&nbsp;import vn.momo.compose.payment.base.core.service.trace.GrafanaTrace
&nbsp;import vn.momo.compose.payment.base.core.service.trace.journey.FirebaseTrace
&nbsp;import vn.momo.compose.payment.base.core.service.trace.model.TrackingErrorCode
&nbsp;import vn.momo.compose.payment.base.core.service.trace.model.grafana.PayXUserEvent
&nbsp;import vn.momo.compose.payment.base.core.service.trace.model.journey.ScreenDismissActor
&nbsp;import vn.momo.compose.payment.base.core.service.trace.model.journey.WebViewDismissed
&nbsp;import vn.momo.compose.payment.base.core.service.trace.model.journey.WebViewDisplayed
&nbsp;import vn.momo.compose.payment.base.core.service.trace.model.journey.WebViewScreen
&nbsp;import vn.momo.compose.payment.base.core.service.trace.userMetricTrace
&nbsp;import vn.momo.compose.payment.base.domain.entities.ChangeSofActor
&nbsp;import vn.momo.compose.payment.base.domain.entities.ChoosePromotionCallbackData
&nbsp;import vn.momo.compose.payment.base.domain.entities.ConsentInfo
&nbsp;import vn.momo.compose.payment.base.domain.entities.ConsentType
&nbsp;import vn.momo.compose.payment.base.domain.entities.EnumMoneySource
&nbsp;import vn.momo.compose.payment.base.domain.entities.NapasConfirmCallbackData
&nbsp;import vn.momo.compose.payment.base.domain.entities.NapasInfo
&nbsp;import vn.momo.compose.payment.base.domain.entities.SOFItem
&nbsp;import vn.momo.compose.payment.base.domain.entities.VoucherItemLocal
&nbsp;import vn.momo.compose.payment.base.domain.entities.transaction.TotalAmount
&nbsp;import vn.momo.compose.payment.base.domain.repository.ConsentManager
&nbsp;import vn.momo.compose.payment.base.domain.useCases.StartBankOtpNativeUseCase
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.delegate.ConfirmViewModelTracking
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.reducer.SofReducer.Action
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.reducer.SofReducer.Effect
&nbsp;import vn.momo.compose.payment.di.PaymentKoinScope
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.memory.PaymentSession
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.memory.SavedPaymentData
&nbsp;import vn.momo.compose.payment.payx.domain.entities.ConfirmRequest
&nbsp;import vn.momo.compose.payment.payx.domain.entities.ConfirmResponse
&nbsp;import vn.momo.compose.payment.payx.domain.entities.ConfirmType
&nbsp;import vn.momo.compose.payment.payx.domain.entities.ConfirmWithOtpRequest
&nbsp;import vn.momo.compose.payment.payx.domain.entities.DirectDebitAction
&nbsp;import vn.momo.compose.payment.payx.domain.entities.DirectDebitMsgType
&nbsp;import vn.momo.compose.payment.payx.domain.entities.InstallmentPackageState
&nbsp;import vn.momo.compose.payment.payx.domain.entities.PayXState
&nbsp;import vn.momo.compose.payment.payx.domain.entities.PayXTransaction
&nbsp;import vn.momo.compose.payment.payx.domain.entities.PromoDisplay
&nbsp;import vn.momo.compose.payment.payx.domain.entities.RedirectScreen
&nbsp;import vn.momo.compose.payment.payx.domain.entities.WebView3dsResponse
&nbsp;import vn.momo.compose.payment.payx.domain.entities.error.PaymentError
&nbsp;import vn.momo.compose.payment.payx.domain.entities.error.PaymentOtpType
&nbsp;import vn.momo.compose.payment.payx.domain.entities.error.isNoResponseError
&nbsp;import vn.momo.compose.payment.base.domain.entities.overlayData.VirtualBankBottomSheet
&nbsp;import vn.momo.compose.payment.base.domain.entities.uiKit.CheckBoxEffect
&nbsp;import vn.momo.compose.payment.base.presentation.uiKit.UIKitActionHandler
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.controller.paymentOverlay.OverlayEffect
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.controller.paymentOverlay.PayXActionHandler
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.controller.paymentOverlay.actionData.TransactionOverlayAction
&nbsp;import vn.momo.compose.payment.base.presentation.viewModel.state.PState
&nbsp;import vn.momo.compose.payment.payx.domain.entities.transactionresult.ConfirmNotifyEvent
&nbsp;import vn.momo.compose.payment.payx.domain.entities.xsale.XSaleError
&nbsp;import vn.momo.compose.payment.payx.domain.repositories.IApp2AppRepository
&nbsp;import vn.momo.compose.payment.payx.domain.repositories.IVerifyConfigErrorRepository
&nbsp;import vn.momo.compose.payment.payx.domain.repositories.confirm.IConfirmRepository
&nbsp;import vn.momo.compose.payment.payx.domain.repositories.directdebit.IDirectDebitRepository
&nbsp;import vn.momo.compose.payment.payx.domain.repositories.orderExtra.OrderExtraRepository
&nbsp;import vn.momo.compose.payment.payx.domain.repositories.voucher.IVoucherRepository
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.CheckoutUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.RequestOtpUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.ConfirmOtpWebViewUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.ConfirmUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.ConfirmWithOtpUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.GenerateOtpTypeUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.HandlePaymentResultUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.HandleSofOtpUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.OpenFraudOtpUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.StartNapasInputUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.confirm.StoreServiceInfoUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.directdebit.DirectDebitUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.mbUpdate.CartUseCase
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.mbUpdate.UpdateTransactionUseCases
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.recommendMoneyPay.PickInstallmentUseCases
&nbsp;import vn.momo.compose.payment.payx.domain.useCases.voucher.GenerateChoosePromotionUseCase
&nbsp;import vn.momo.compose.payment.payx.presentation.model.MBConfirmScreenProps
&nbsp;import vn.momo.compose.payment.payx.presentation.model.PaymentEvent
&nbsp;import vn.momo.compose.payment.payx.presentation.model.ProcessPayType.AUTHENTICATE_IMMEDIATELY
&nbsp;import vn.momo.compose.payment.payx.presentation.model.ProcessPayType.BY_PASS_AUTHENTICATE_IMMEDIATELY
&nbsp;import vn.momo.compose.payment.payx.presentation.model.ProcessPayType.SHOW_CONFIRM_DIALOG
&nbsp;import vn.momo.compose.payment.payx.presentation.model.SuggestedSofBottomSheetProps
&nbsp;import vn.momo.compose.payment.payx.presentation.model.SuggestedSofType
&nbsp;import vn.momo.compose.payment.payx.presentation.view.components.InfoContent
&nbsp;import vn.momo.compose.payment.payx.presentation.view.components.InfoRowContent
&nbsp;import vn.momo.compose.payment.payx.presentation.view.components.PromotionStatus
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.action.NapasCallBackType
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.controller.handlePaymentConfirmError
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.controller.handlePaymentError
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.controller.paymentOverlay.ServiceCartOverlayHandler
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.controller.paymentOverlay.TransactionOverlay
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.controller.paymentOverlay.handleConfirmOverlay
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.controller.paymentOverlay.handleOverlay
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.delegate.PayXConfirmTracker
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.reducers.AutoDebitReducer
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.reducers.PaymentQuickPayReducer
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.reducers.RewardReducer
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.reducers.TransactionReducer
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.reducers.UiVersion
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.reducers.XSaleReducer
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.AutoDebitSlice
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.PayXSofSlice
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.PaymentQuickPaySlice
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.ViewModel
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.XSaleSlice
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.orderExtra.RewardViewSlice
&nbsp;import vn.momo.compose.resources.Res
&nbsp;import vn.momo.compose.resources.conversionFee
&nbsp;import vn.momo.compose.resources.errorButtonDefault
&nbsp;import vn.momo.compose.resources.errorDefaultTitle
&nbsp;import vn.momo.compose.resources.errorToastDirectDebitTitle
&nbsp;import vn.momo.compose.resources.promoteSourceToastTitle
&nbsp;import vn.momo.compose.resources.purchaseErrorDesc
&nbsp;import vn.momo.compose.resources.retryDirectDebitTitle
&nbsp;import vn.momo.compose.resources.subTotalAmount
&nbsp;import vn.momo.compose.resources.successToastDirectDebitTitle
&nbsp;import vn.momo.compose.resources.totalFee
&nbsp;import vn.momo.compose.resources.xSaleFail
&nbsp;import vn.momo.compose.utils.datamapping.ModelConvertUtils
&nbsp;import vn.momo.compose.utils.datamapping.emptyJsonObject
&nbsp;import vn.momo.compose.utils.formatCurrency
&nbsp;import vn.momo.kits.const.Colors
&nbsp;
&nbsp;@OptIn(FlowPreview::class)
&nbsp;class PaymentConfirmVM(
<b class="nc">&nbsp;    private val koinScope: Scope,</b>
<b class="nc">&nbsp;    private val updateUseCases: UpdateTransactionUseCases,</b>
<b class="nc">&nbsp;    private val checkoutUseCase: CheckoutUseCase,</b>
<b class="nc">&nbsp;    private val voucherRepository: IVoucherRepository,</b>
<b class="nc">&nbsp;    private val startNapasInputUseCase: StartNapasInputUseCase,</b>
<b class="nc">&nbsp;    private val generateChoosePromotionUseCase: GenerateChoosePromotionUseCase,</b>
<b class="nc">&nbsp;    private val verifyConfigErrorRepository: IVerifyConfigErrorRepository,</b>
<b class="nc">&nbsp;    private val confirmUseCase: ConfirmUseCase,</b>
<b class="nc">&nbsp;    private val handlePaymentResultUseCase: HandlePaymentResultUseCase,</b>
<b class="nc">&nbsp;    private val requestOtpUseCase: RequestOtpUseCase,</b>
<b class="nc">&nbsp;    private val openFraudOtpUseCase: OpenFraudOtpUseCase,</b>
<b class="nc">&nbsp;    private val confirmRepository: IConfirmRepository,</b>
<b class="nc">&nbsp;    private val handleSofOtpUseCase: HandleSofOtpUseCase,</b>
<b class="nc">&nbsp;    private val generateOtpTypeUseCase: GenerateOtpTypeUseCase,</b>
<b class="nc">&nbsp;    private val confirmWithOtpUseCase: ConfirmWithOtpUseCase,</b>
<b class="nc">&nbsp;    private val storeServiceInfoUseCase: StoreServiceInfoUseCase,</b>
<b class="nc">&nbsp;    private val paymentSessionCenter: PaymentSession,</b>
<b class="nc">&nbsp;    private val navigator: INavigator,</b>
<b class="nc">&nbsp;    private val logger: ILogger,</b>
<b class="nc">&nbsp;    private val payXObserver: PayXObserver,</b>
<b class="nc">&nbsp;    private val app2appRepository: IApp2AppRepository,</b>
<b class="nc">&nbsp;    private val directDebitUseCase: DirectDebitUseCase,</b>
<b class="nc">&nbsp;    private val directDebitRepository: IDirectDebitRepository,</b>
<b class="nc">&nbsp;    private val pickInstallmentUseCases: PickInstallmentUseCases,</b>
<b class="nc">&nbsp;    private val confirmOtpWebViewUseCase: ConfirmOtpWebViewUseCase,</b>
<b class="nc">&nbsp;    private val cartUseCase: CartUseCase,</b>
<b class="nc">&nbsp;    private val consentManager: ConsentManager,</b>
<b class="nc">&nbsp;    private val savedPaymentData: SavedPaymentData,</b>
<b class="nc">&nbsp;    private val payXTracker: PayXConfirmTracker,</b>
<b class="nc">&nbsp;    private val orderExtraRepository: OrderExtraRepository,</b>
<b class="nc">&nbsp;    private val startBankOtpNativeUseCase: StartBankOtpNativeUseCase,</b>
<b class="nc">&nbsp;    private val uiKitActionHandler: UIKitActionHandler</b>
<b class="nc">&nbsp;) : ViewModel&lt;TransactionReducer.State, TransactionReducer.Action, TransactionReducer.Effect&gt;(</b>
<b class="nc">&nbsp;    initialState = TransactionReducer.State(), reducer = TransactionReducer()</b>
&nbsp;), ConfirmViewModelTracking by payXTracker {
<b class="nc">&nbsp;    lateinit var props: MBConfirmScreenProps</b>
<b class="nc">&nbsp;    val sofSlice by koinScope.inject&lt;PayXSofSlice&gt; { parametersOf(viewModelScope) }</b>
&nbsp;
<b class="nc">&nbsp;    val xSaleSlice by koinScope.inject&lt;XSaleSlice&gt; { parametersOf(viewModelScope) }</b>
<b class="nc">&nbsp;    val autoDebitSlice by koinScope.inject&lt;AutoDebitSlice&gt; { parametersOf(viewModelScope) }</b>
<b class="nc">&nbsp;    val rewardSlice by koinScope.inject&lt;RewardViewSlice&gt; { parametersOf(viewModelScope) }</b>
&nbsp;
<b class="nc">&nbsp;    private val quickPaySlice by koinScope.inject&lt;PaymentQuickPaySlice&gt; {</b>
<b class="nc">&nbsp;        parametersOf(</b>
<b class="nc">&nbsp;            viewModelScope</b>
&nbsp;        )
&nbsp;    }
<b class="nc">&nbsp;    private val checkBoxState = PState(viewModelScope, true)</b>
&nbsp;
&nbsp;    override fun onCleared() {
<b class="nc">&nbsp;        PaymentKoinScope.end(koinScope.id)</b>
<b class="nc">&nbsp;        super.onCleared()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onCreate(params: Map&lt;String, Any?&gt;) {
<b class="nc">&nbsp;        props = ModelConvertUtils.decode(MBConfirmScreenProps.serializer(), params) ?: props</b>
<b class="nc">&nbsp;        getVersion(props.versionTag)</b>
<b class="nc">&nbsp;        trackScreenDisplay(version = sofSlice.state.value.version)</b>
<b class="nc">&nbsp;        logger.i(&quot;[PayX][onCreate] params - ${ModelConvertUtils.encodeToJson(params)}&quot;)</b>
<b class="nc">&nbsp;        navigator.hideLoading() // hide loading if it is shown before</b>
<b class="nc">&nbsp;        sofSlice.getHideBalanceConfig()</b>
<b class="nc">&nbsp;        xSaleSlice.effect.onEach {</b>
<b class="nc">&nbsp;            when (it) {</b>
<b class="nc">&nbsp;                is XSaleReducer.XSaleEffect.AddCart -&gt; onAddCart(it.itemId, it.payload)</b>
<b class="nc">&nbsp;                is XSaleReducer.XSaleEffect.RemoveCart -&gt; onRemoveCart(it.itemId)</b>
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;
<b class="nc">&nbsp;        autoDebitSlice.effect.onEach {</b>
<b class="nc">&nbsp;            when (it) {</b>
<b class="nc">&nbsp;                is AutoDebitReducer.AutoDebitEffect.OnClickTnC -&gt; navigator.openAppBrowser(</b>
<b class="nc">&nbsp;                    it.title, it.url</b>
&nbsp;                )
&nbsp;
<b class="nc">&nbsp;                is AutoDebitReducer.AutoDebitEffect.OnConfigUpdate -&gt; savedPaymentData.updateExtraServiceInfo(</b>
<b class="nc">&nbsp;                    it.serviceInfo</b>
&nbsp;                )
&nbsp;
<b class="nc">&nbsp;                is AutoDebitReducer.AutoDebitEffect.OnSkipLoadingUpdate -&gt; dispatch(</b>
<b class="nc">&nbsp;                    TransactionReducer.Action.SetSkipLoading(it.skipLoading)</b>
&nbsp;                )
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;</b>
<b class="nc">&nbsp;        sofSlice.effect.onEach {</b>
<b class="nc">&nbsp;            when (it) {</b>
<b class="nc">&nbsp;                is Effect.InitSofTransaction -&gt; changeSof(it)</b>
<b class="nc">&nbsp;                Effect.SyncReward -&gt; sofSlice.dispatch(Action.UpdateReward(rewardSlice.state.value.coins))</b>
&nbsp;                else -&gt; {}
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        rewardSlice.effect.onEach {</b>
<b class="nc">&nbsp;            when (it) {</b>
<b class="nc">&nbsp;                is RewardReducer.RewardEffect.UpdateCoinToSof -&gt; {</b>
<b class="nc">&nbsp;                    sofSlice.dispatch(</b>
<b class="nc">&nbsp;                        Action.UpdateReward(it.reward)</b>
&nbsp;                    )
<b class="nc">&nbsp;                    sofSlice.trackShowSofsReward(it.reward)</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        checkout()</b>
<b class="nc">&nbsp;        if (props.getProcessPayType() == SHOW_CONFIRM_DIALOG) {</b>
<b class="nc">&nbsp;            quickPaySlice.openQuickPayBottomSheet(navigator, viewModelScope)</b>
<b class="nc">&nbsp;            quickPaySlice.effect.onEach {</b>
<b class="nc">&nbsp;                when (it) {</b>
<b class="nc">&nbsp;                    is PaymentQuickPayReducer.QuickPayEffect.RequestConfirmPayment -&gt; {</b>
<b class="nc">&nbsp;                        onConfirm()</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    is PaymentQuickPayReducer.QuickPayEffect.ShowDismissConfirmScreenPopup -&gt; {</b>
<b class="nc">&nbsp;                        quickPayFallback()</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    is PaymentQuickPayReducer.QuickPayEffect.DismissConfirmScreen -&gt; {</b>
<b class="nc">&nbsp;                        goBack()</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }.launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            consentManager.getConfig()</b>
&nbsp;        }
<b class="nc">&nbsp;        combine(</b>
<b class="nc">&nbsp;            state.map { currentState -&gt;</b>
&nbsp;                currentState.isLoading
<b class="nc">&nbsp;            }.distinctUntilChanged(), consentManager.consentInfo.asStateFlow()</b>
&nbsp;        ) { (loading, consent) -&gt;
&nbsp;            Pair(loading, consent)
<b class="nc">&nbsp;        }.filter {</b>
&nbsp;            val loading = it.first as? Boolean ?: true
&nbsp;            val consent = it.second as? ConsentInfo
&nbsp;            return@filter !loading &amp;&amp; consent?.type != null &amp;&amp; consent.type != ConsentType.None
<b class="nc">&nbsp;        }.onEach {</b>
<b class="nc">&nbsp;            navigator.showBottomSheet(buildJsonObject {</b>
<b class="nc">&nbsp;                put(&quot;type&quot;, &quot;payx_consent&quot;)</b>
<b class="nc">&nbsp;                put(&quot;cancelable&quot;, false)</b>
<b class="nc">&nbsp;            }).launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        paymentSessionCenter.overlayEvent.onEach {</b>
<b class="nc">&nbsp;            koinScope.getOrNull&lt;TransactionOverlay&gt; { parametersOf(it) }?.handle()</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;
<b class="nc">&nbsp;        paymentSessionCenter.paymentEvent.onEach {</b>
<b class="nc">&nbsp;            when (it) {</b>
<b class="nc">&nbsp;                is PaymentEvent.OpenPopUpSof -&gt; {</b>
<b class="nc">&nbsp;                    openSuggestSofBottomSheet(true)</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                is PaymentEvent.CashIn -&gt; {</b>
<b class="nc">&nbsp;                    sofSlice.onCashIn(</b>
<b class="nc">&nbsp;                        targetAmount = state.value.amount.total.value.toLong(),</b>
<b class="nc">&nbsp;                        targetSource = EnumMoneySource.MoMo</b>
&nbsp;                    )
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                is PaymentEvent.CallbackToMiniApp -&gt; handleCallbackToMiniApp(it.data, it.state)</b>
&nbsp;
<b class="nc">&nbsp;                is PaymentEvent.ToTransactionResult -&gt; handlePaymentResultUseCase(it.data)</b>
&nbsp;
<b class="nc">&nbsp;                is PaymentEvent.RegisterDirectDebit -&gt; handleRegisterDirectDebit()</b>
<b class="nc">&nbsp;                is PaymentEvent.OnDirectDebit -&gt; handleOnDirectDebit()</b>
<b class="nc">&nbsp;                is PaymentEvent.ChangeSourceDirectDebit -&gt; handleChangeSourceDirectDebit()</b>
<b class="nc">&nbsp;                is PaymentEvent.AllowToConfirm -&gt; {</b>
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        TransactionReducer.Action.SetEnableConfirm(</b>
<b class="nc">&nbsp;                            true</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                is PaymentEvent.ForceReInit -&gt; forceReinitTransaction()</b>
&nbsp;
<b class="nc">&nbsp;                is PaymentEvent.AddBank -&gt; sofSlice.addBankToSof()</b>
<b class="nc">&nbsp;                is PaymentEvent.ConfirmPayment -&gt; onConfirm()</b>
<b class="nc">&nbsp;                is PaymentEvent.RequestClose -&gt; goBack()</b>
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;
<b class="nc">&nbsp;        uiKitActionHandler.uiEvent.onEach {</b>
<b class="nc">&nbsp;            val action = it?.let { cta -&gt; TransactionOverlayAction().createAction(cta) }</b>
<b class="nc">&nbsp;            when (PayXActionHandler(action)) {</b>
<b class="nc">&nbsp;                OverlayEffect.AddSof -&gt; sofSlice.addBankToSof()</b>
<b class="nc">&nbsp;                OverlayEffect.CashIn -&gt; sofSlice.onCashIn(</b>
<b class="nc">&nbsp;                    targetAmount = state.value.amount.total.value,</b>
<b class="nc">&nbsp;                    targetSource = EnumMoneySource.MoMo</b>
&nbsp;                )
&nbsp;
<b class="nc">&nbsp;                OverlayEffect.OpenSof -&gt; openSuggestSofBottomSheet(true)</b>
<b class="nc">&nbsp;                OverlayEffect.ReinitTransaction -&gt; forceReinitTransaction()</b>
&nbsp;
&nbsp;                else -&gt; {
<b class="nc">&nbsp;                    logger.i(&quot;[PayX] have no effect: $action&quot;)</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;
<b class="nc">&nbsp;        uiKitActionHandler.checkBoxEvent.onEach {</b>
<b class="nc">&nbsp;            when (it.effect) {</b>
<b class="nc">&nbsp;                CheckBoxEffect.ConfirmButton.id -&gt; checkBoxState.update(it.data)</b>
&nbsp;                else -&gt; {
<b class="nc">&nbsp;                    logger.i(&quot;[PayX] have no checkbox effect: $it&quot;)</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;
<b class="nc">&nbsp;        storeServiceInfoUseCase(props.smartWidget?.data)</b>
<b class="nc">&nbsp;        props.smartWidget?.observerKey?.let {</b>
<b class="nc">&nbsp;            payXObserver.observe(it.lowercase(), JsonObject.serializer()).onEach { serviceInfo -&gt;</b>
<b class="nc">&nbsp;                storeServiceInfoUseCase(serviceInfo)</b>
<b class="nc">&nbsp;            }.launchIn(viewModelScope)</b>
&nbsp;        }
<b class="nc">&nbsp;        checkShowTid()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun forceReinitTransaction() {
<b class="nc">&nbsp;        sofSlice.state.value.selected?.let { currentSof -&gt;</b>
<b class="nc">&nbsp;            changeSof(</b>
<b class="nc">&nbsp;                Effect.InitSofTransaction(</b>
<b class="nc">&nbsp;                    sof = currentSof,</b>
<b class="nc">&nbsp;                    ChangeSofActor.UserClick</b>
&nbsp;                )
&nbsp;            )
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    fun goBack() {
<b class="nc">&nbsp;        trackGoBack(version = sofSlice.state.value.version)</b>
<b class="nc">&nbsp;        navigator.dismiss(buildJsonObject { put(&quot;payXState&quot;, PayXState.USER_CANCEL.name) })</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun checkShowTid() {
<b class="nc">&nbsp;        paymentSessionCenter.requestPayXData.let {</b>
<b class="nc">&nbsp;            if (it.visibleTidServices != null &amp;&amp; it.serviceCode != null) {</b>
<b class="nc">&nbsp;                dispatch(TransactionReducer.Action.SetShowTid(it.visibleTidServices.contains(it.serviceCode)))</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    suspend fun quickPayFallback() {
<b class="nc">&nbsp;        navigator.showDialog(</b>
<b class="nc">&nbsp;            title = getString(Res.string.errorDefaultTitle),</b>
<b class="nc">&nbsp;            body = &quot;Checkout error&quot;,</b>
<b class="nc">&nbsp;            buttons = listOf(</b>
<b class="nc">&nbsp;                getString(Res.string.errorButtonDefault)</b>
&nbsp;            )
<b class="nc">&nbsp;        ).onEach {</b>
<b class="nc">&nbsp;            goBack()</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun checkout() {
<b class="nc">&nbsp;        dispatch(TransactionReducer.Action.SetLoading(true))</b>
<b class="nc">&nbsp;        quickPaySlice.dispatch(PaymentQuickPayReducer.QuickPayAction.BeginCheckout)</b>
<b class="nc">&nbsp;        checkoutUseCase().onEach { response -&gt;</b>
<b class="nc">&nbsp;            val version = sofSlice.state.value.version</b>
<b class="nc">&nbsp;            val initTransaction = response.data</b>
<b class="nc">&nbsp;            if (response.isSuccess) {</b>
<b class="nc">&nbsp;                onFirstCheckoutResponse(initTransaction)</b>
<b class="nc">&nbsp;                trackScreenInteracted(</b>
<b class="nc">&nbsp;                    initTransaction,</b>
<b class="nc">&nbsp;                    version,</b>
<b class="nc">&nbsp;                    checkoutGrafanaId = paymentSessionCenter.requestPayXData.grafanaId.checkout,</b>
<b class="nc">&nbsp;                    checkoutFlow = paymentSessionCenter.requestPayXData.checkoutFlow</b>
&nbsp;                )
<b class="nc">&nbsp;                sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                    initTransaction.selectedSof,</b>
<b class="nc">&nbsp;                    initTransaction.purchaseId,</b>
<b class="nc">&nbsp;                    initTransaction.serviceType</b>
&nbsp;                )
<b class="nc">&nbsp;                handleServiceCartOverlay(initTransaction)</b>
<b class="nc">&nbsp;                initTransaction.overlayData?.let {</b>
<b class="nc">&nbsp;                    koinScope.getOrNull&lt;TransactionOverlay&gt; { parametersOf(it) }?.handle()</b>
<b class="nc">&nbsp;                }</b>
&nbsp;
&nbsp;            } else {
<b class="nc">&nbsp;                val requestData = paymentSessionCenter.requestPayXData</b>
<b class="nc">&nbsp;                payXTracker.trackCheckoutBackToService(</b>
<b class="nc">&nbsp;                    requestData.grafanaId.checkout,</b>
<b class="nc">&nbsp;                    requestData.checkoutFlow,</b>
<b class="nc">&nbsp;                    initTransaction.errorCode</b>
&nbsp;                )
<b class="nc">&nbsp;                handleCallbackToMiniApp(buildJsonObject {</b>
<b class="nc">&nbsp;                    put(&quot;payXMetaData&quot;, buildJsonObject {</b>
<b class="nc">&nbsp;                        put(&quot;errorType&quot;, &quot;PayXError&quot;)</b>
<b class="nc">&nbsp;                        put(&quot;errorCode&quot;, initTransaction.errorCode)</b>
<b class="nc">&nbsp;                        put(&quot;errorDesc&quot;, &quot;&quot;)</b>
<b class="nc">&nbsp;                    })</b>
<b class="nc">&nbsp;                }, PayXState.CHECKOUT)</b>
<b class="nc">&nbsp;                initTransaction.overlayData?.let {</b>
<b class="nc">&nbsp;                    koinScope.getOrNull&lt;TransactionOverlay&gt; { parametersOf(it) }?.handle()</b>
&nbsp;                }
<b class="nc">&nbsp;                quickPaySlice.dispatch(PaymentQuickPayReducer.QuickPayAction.ErrorAddCart)</b>
&nbsp;            }
<b class="nc">&nbsp;        }.catch { error -&gt;</b>
<b class="nc">&nbsp;            val requestData = paymentSessionCenter.requestPayXData</b>
<b class="nc">&nbsp;            when (error) {</b>
<b class="nc">&nbsp;                is PaymentError.SystemError -&gt; {</b>
<b class="nc">&nbsp;                    payXTracker.trackCheckoutBackToService(</b>
<b class="nc">&nbsp;                        requestData.grafanaId.checkout, requestData.checkoutFlow, error.code</b>
&nbsp;                    )
<b class="nc">&nbsp;                    handleCallbackToMiniApp(buildJsonObject {</b>
<b class="nc">&nbsp;                        put(&quot;payXMetaData&quot;, buildJsonObject {</b>
<b class="nc">&nbsp;                            put(&quot;errorType&quot;, &quot;SystemError&quot;)</b>
<b class="nc">&nbsp;                            put(&quot;errorCode&quot;, error.code)</b>
<b class="nc">&nbsp;                            put(&quot;errorDesc&quot;, error.message)</b>
<b class="nc">&nbsp;                        })</b>
<b class="nc">&nbsp;                    }, PayXState.CHECKOUT)</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                is PaymentError.UnknownError -&gt; {</b>
<b class="nc">&nbsp;                    payXTracker.trackCheckoutBackToService(</b>
<b class="nc">&nbsp;                        requestData.grafanaId.checkout, requestData.checkoutFlow, error.code</b>
&nbsp;                    )
<b class="nc">&nbsp;                    navigator.showErrorPopup(</b>
<b class="nc">&nbsp;                        NavigatorErrorPopup(</b>
<b class="nc">&nbsp;                            title = getString(Res.string.errorDefaultTitle),</b>
<b class="nc">&nbsp;                            bodyContent = error.message ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                            errorCode = error.code.toString(),</b>
<b class="nc">&nbsp;                            errorMessage = error.message,</b>
<b class="nc">&nbsp;                            primaryButton = getString(Res.string.errorButtonDefault),</b>
<b class="nc">&nbsp;                            cancelable = false,</b>
<b class="nc">&nbsp;                            showCloseIcon = false</b>
&nbsp;                        )
<b class="nc">&nbsp;                    ).onEach {</b>
<b class="nc">&nbsp;                        handleCallbackToMiniApp(buildJsonObject {</b>
<b class="nc">&nbsp;                            put(&quot;payXMetaData&quot;, buildJsonObject {</b>
<b class="nc">&nbsp;                                put(&quot;errorType&quot;, &quot;PayXError&quot;)</b>
<b class="nc">&nbsp;                                put(&quot;errorCode&quot;, error.code)</b>
<b class="nc">&nbsp;                                put(&quot;errorDesc&quot;, error.message)</b>
<b class="nc">&nbsp;                            })</b>
<b class="nc">&nbsp;                        }, PayXState.CHECKOUT)</b>
<b class="nc">&nbsp;                    }.launchIn(viewModelScope)</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                is TimeoutCancellationException -&gt; {</b>
<b class="nc">&nbsp;                    payXTracker.trackCheckoutBackToService(</b>
<b class="nc">&nbsp;                        requestData.grafanaId.checkout,</b>
<b class="nc">&nbsp;                        requestData.checkoutFlow,</b>
<b class="nc">&nbsp;                        TrackingErrorCode.ObserveTimeout.code</b>
&nbsp;                    )
<b class="nc">&nbsp;                    navigator.showErrorPopup(</b>
<b class="nc">&nbsp;                        NavigatorErrorPopup(</b>
<b class="nc">&nbsp;                            title = getString(Res.string.errorDefaultTitle),</b>
<b class="nc">&nbsp;                            bodyContent = getString(Res.string.purchaseErrorDesc),</b>
<b class="nc">&nbsp;                            errorCode = &quot;-2&quot;,</b>
<b class="nc">&nbsp;                            errorMessage = error.message,</b>
<b class="nc">&nbsp;                            primaryButton = getString(Res.string.errorButtonDefault),</b>
<b class="nc">&nbsp;                            cancelable = false,</b>
<b class="nc">&nbsp;                            showCloseIcon = false</b>
&nbsp;                        )
<b class="nc">&nbsp;                    ).onEach {</b>
<b class="nc">&nbsp;                        handleCallbackToMiniApp(buildJsonObject {</b>
<b class="nc">&nbsp;                            put(&quot;payXMetaData&quot;, buildJsonObject {</b>
<b class="nc">&nbsp;                                put(&quot;errorType&quot;, &quot;MaxAPI.observer error&quot;)</b>
<b class="nc">&nbsp;                                put(&quot;errorCode&quot;, TrackingErrorCode.ObserveTimeout.code)</b>
<b class="nc">&nbsp;                                put(&quot;errorDesc&quot;, getString(Res.string.purchaseErrorDesc))</b>
<b class="nc">&nbsp;                            })</b>
<b class="nc">&nbsp;                        }, PayXState.CHECKOUT)</b>
<b class="nc">&nbsp;                    }.launchIn(viewModelScope)</b>
&nbsp;                }
&nbsp;
&nbsp;                else -&gt; {
<b class="nc">&nbsp;                    payXTracker.trackCheckoutBackToService(</b>
<b class="nc">&nbsp;                        requestData.grafanaId.checkout,</b>
<b class="nc">&nbsp;                        requestData.checkoutFlow,</b>
<b class="nc">&nbsp;                        TrackingErrorCode.Unknown.code</b>
&nbsp;                    )
<b class="nc">&nbsp;                    handleCallbackToMiniApp(buildJsonObject {</b>
<b class="nc">&nbsp;                        put(&quot;payXMetaData&quot;, buildJsonObject {</b>
<b class="nc">&nbsp;                            put(&quot;errorType&quot;, &quot;PayXError&quot;)</b>
<b class="nc">&nbsp;                            put(&quot;errorCode&quot;, TrackingErrorCode.Unknown.code)</b>
<b class="nc">&nbsp;                            put(&quot;errorDesc&quot;, error.message)</b>
<b class="nc">&nbsp;                        })</b>
<b class="nc">&nbsp;                    }, PayXState.CHECKOUT)</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun handleServiceCartOverlay(initTransaction: PayXTransaction) {
<b class="nc">&nbsp;        initTransaction.serviceCartData?.also {</b>
<b class="nc">&nbsp;            koinScope.getOrNull&lt;ServiceCartOverlayHandler&gt; { parametersOf(it) }?.handle()</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    fun showToastMessage(sourceMessage: String?) {
<b class="nc">&nbsp;        if (sourceMessage?.isNotEmpty() == true) {</b>
<b class="nc">&nbsp;            navigator.showToast(</b>
<b class="nc">&nbsp;                buildJsonObject {</b>
<b class="nc">&nbsp;                    put(&quot;title&quot;, sourceMessage)</b>
<b class="nc">&nbsp;                    put(&quot;type&quot;, &quot;success&quot;)</b>
<b class="nc">&nbsp;                    put(</b>
<b class="nc">&nbsp;                        &quot;icon&quot;,</b>
<b class="nc">&nbsp;                        &quot;https://img.mservice.io/momo_app_v2/new_version/img/appx_icon/48_notifications_icon48_info.png&quot;</b>
&nbsp;                    )
<b class="nc">&nbsp;                    put(&quot;duration&quot;, 3000)</b>
<b class="nc">&nbsp;                }, String.serializer()</b>
<b class="nc">&nbsp;            ).launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleCallbackToMiniApp(data: JsonObject, state: PayXState) {
<b class="nc">&nbsp;        navigator.dismiss(JsonObject(data + buildJsonObject { put(&quot;payXState&quot;, state.name) }))</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun changeSof(action: Effect.InitSofTransaction) {
<b class="nc">&nbsp;        val sof = action.sof</b>
<b class="nc">&nbsp;        val actor = action.actor</b>
<b class="nc">&nbsp;        sofSlice.onUpdateTransaction()</b>
<b class="nc">&nbsp;        trackStartCallAPIChangeSof()</b>
<b class="nc">&nbsp;        dispatch(TransactionReducer.Action.SetEnableConfirm(false))</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            updateUseCases.changeSof(</b>
<b class="nc">&nbsp;                sof, invoiceItem = state.value.invoices, sofSlice.state.value.list</b>
<b class="nc">&nbsp;            ).handleOverlay().onEach { result -&gt;</b>
<b class="nc">&nbsp;                if (!result.exception.isNoResponseError()) {</b>
<b class="nc">&nbsp;                    updateTransaction(result.data)</b>
<b class="nc">&nbsp;                    when (actor) {</b>
&nbsp;                        ChangeSofActor.MoneyPay -&gt; {
<b class="nc">&nbsp;                            navigator.showToast(buildJsonObject {</b>
<b class="nc">&nbsp;                                put(</b>
<b class="nc">&nbsp;                                    &quot;title&quot;,</b>
<b class="nc">&nbsp;                                    getString(Res.string.promoteSourceToastTitle, sof.shortName)</b>
&nbsp;                                )
<b class="nc">&nbsp;                                put(&quot;type&quot;, &quot;success&quot;)</b>
<b class="nc">&nbsp;                            }, String.serializer()).launchIn(this)</b>
&nbsp;                        }
&nbsp;
&nbsp;                        ChangeSofActor.ActiveSof -&gt; {
<b class="nc">&nbsp;                            sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                                result.data.selectedSof,</b>
<b class="nc">&nbsp;                                result.data.purchaseId,</b>
<b class="nc">&nbsp;                                result.data.serviceType</b>
&nbsp;                            )
&nbsp;                        }
&nbsp;
&nbsp;                        else -&gt; {}
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                trackChangeSofFinished&lt;PayXTransaction&gt;(result)</b>
<b class="nc">&nbsp;                if (result.isFailure) {</b>
<b class="nc">&nbsp;                    throw result.exception</b>
&nbsp;                }
<b class="nc">&nbsp;            }.handlePaymentError().launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun onAddCart(id: String, payload: JsonObject) {
<b class="nc">&nbsp;        sofSlice.state.value.selected?.let { sof -&gt;</b>
<b class="nc">&nbsp;            sofSlice.onUpdateTransaction()</b>
<b class="nc">&nbsp;            sofSlice.dispatch(Action.ResetPromoteSof)</b>
<b class="nc">&nbsp;            navigator.showLoading()</b>
<b class="nc">&nbsp;            cartUseCase.addCart(</b>
<b class="nc">&nbsp;                oldXSaleId = xSaleSlice.state.value.selected?.id,</b>
<b class="nc">&nbsp;                newXSaleId = id,</b>
<b class="nc">&nbsp;                payload = payload,</b>
<b class="nc">&nbsp;                source = sof,</b>
<b class="nc">&nbsp;                invoices = state.value.invoices</b>
<b class="nc">&nbsp;            ).handleOverlay().onEach { response -&gt;</b>
<b class="nc">&nbsp;                if (response.isSuccess) {</b>
<b class="nc">&nbsp;                    xSaleSlice.dispatch(XSaleReducer.XSaleAction.Highlight(id))</b>
<b class="nc">&nbsp;                    updateTransaction(response.data)</b>
<b class="nc">&nbsp;                    sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                        response.data.selectedSof,</b>
<b class="nc">&nbsp;                        response.data.purchaseId,</b>
<b class="nc">&nbsp;                        response.data.serviceType</b>
&nbsp;                    )
&nbsp;                    return@onEach
&nbsp;                }
<b class="nc">&nbsp;                if (response.exception is XSaleError) {</b>
<b class="nc">&nbsp;                    viewModelScope.launch {</b>
<b class="nc">&nbsp;                        navigator.showToast(buildJsonObject {</b>
<b class="nc">&nbsp;                            put(</b>
<b class="nc">&nbsp;                                &quot;title&quot;, getString(Res.string.xSaleFail)</b>
&nbsp;                            )
<b class="nc">&nbsp;                            put(&quot;type&quot;, &quot;warning&quot;)</b>
<b class="nc">&nbsp;                            put(&quot;duration&quot;, 4000)</b>
<b class="nc">&nbsp;                        }, String.serializer()).launchIn(this)</b>
&nbsp;                    }
&nbsp;                    return@onEach
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (!response.exception.isNoResponseError()) {</b>
<b class="nc">&nbsp;                    xSaleSlice.dispatch(XSaleReducer.XSaleAction.Highlight(id))</b>
<b class="nc">&nbsp;                    updateTransaction(response.data)</b>
<b class="nc">&nbsp;                    sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                        response.data.selectedSof,</b>
<b class="nc">&nbsp;                        response.data.purchaseId,</b>
<b class="nc">&nbsp;                        response.data.serviceType</b>
&nbsp;                    )
&nbsp;                }
<b class="nc">&nbsp;                if (response.isFailure) {</b>
<b class="nc">&nbsp;                    throw response.exception</b>
&nbsp;                }
<b class="nc">&nbsp;            }.handlePaymentError().onCompletion { navigator.hideLoading() }.launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun onRemoveCart(id: String) {
<b class="nc">&nbsp;        sofSlice.state.value.selected?.let { sof -&gt;</b>
<b class="nc">&nbsp;            sofSlice.onUpdateTransaction()</b>
<b class="nc">&nbsp;            sofSlice.dispatch(Action.ResetPromoteSof)</b>
<b class="nc">&nbsp;            navigator.showLoading()</b>
<b class="nc">&nbsp;            viewModelScope.launch {</b>
<b class="nc">&nbsp;                cartUseCase.removeCart(id, sof, state.value.invoices).handleOverlay()</b>
<b class="nc">&nbsp;                    .onEach { response -&gt;</b>
<b class="nc">&nbsp;                        if (response.isSuccess) {</b>
<b class="nc">&nbsp;                            xSaleSlice.dispatch(XSaleReducer.XSaleAction.Deselect)</b>
<b class="nc">&nbsp;                            updateTransaction(response.data)</b>
<b class="nc">&nbsp;                            sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                                response.data.selectedSof,</b>
<b class="nc">&nbsp;                                response.data.purchaseId,</b>
<b class="nc">&nbsp;                                response.data.serviceType</b>
&nbsp;                            )
&nbsp;                            return@onEach
&nbsp;                        }
<b class="nc">&nbsp;                        if (!response.exception.isNoResponseError() &amp;&amp; response.exception !is XSaleError) {</b>
<b class="nc">&nbsp;                            xSaleSlice.dispatch(XSaleReducer.XSaleAction.Deselect)</b>
<b class="nc">&nbsp;                            updateTransaction(response.data)</b>
<b class="nc">&nbsp;                            sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                                response.data.selectedSof,</b>
<b class="nc">&nbsp;                                response.data.purchaseId,</b>
<b class="nc">&nbsp;                                response.data.serviceType</b>
&nbsp;                            )
&nbsp;                        }
<b class="nc">&nbsp;                        if (response.isFailure) {</b>
<b class="nc">&nbsp;                            throw response.exception</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }.handlePaymentError().onCompletion { navigator.hideLoading() }</b>
<b class="nc">&nbsp;                    .launchIn(viewModelScope)</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onConfirm() {
<b class="nc">&nbsp;        if (!checkBoxState._value) {</b>
<b class="nc">&nbsp;            navigator.showToast(</b>
<b class="nc">&nbsp;                buildJsonObject {</b>
<b class="nc">&nbsp;                    put(&quot;title&quot;, &quot;Vui lòng xác nhận điều khoản để tiếp tục giao dịch&quot;)</b>
<b class="nc">&nbsp;                    put(&quot;type&quot;, &quot;warning&quot;)</b>
<b class="nc">&nbsp;                    put(&quot;duration&quot;, 3000)</b>
<b class="nc">&nbsp;                }, String.serializer()</b>
<b class="nc">&nbsp;            ).launchIn(viewModelScope)</b>
&nbsp;            return
&nbsp;        }
<b class="nc">&nbsp;        payXTracker.trackTriggerConfirm(</b>
<b class="nc">&nbsp;            state = state.value,</b>
<b class="nc">&nbsp;            sofState = sofSlice.state.value,</b>
<b class="nc">&nbsp;            xSaleState = xSaleSlice.state.value,</b>
<b class="nc">&nbsp;            initPurchaseId = paymentSessionCenter.requestPayXData.initialPurchaseId,</b>
<b class="nc">&nbsp;            version = sofSlice.state.value.version,</b>
<b class="nc">&nbsp;            missionIds = rewardSlice.state.value.missionId</b>
&nbsp;        )
<b class="nc">&nbsp;        dispatch(TransactionReducer.Action.SetEnableConfirm(false))</b>
<b class="nc">&nbsp;        if (isSkipAuth &amp;&amp; props.pinKeySessionId.isNotEmpty()) {</b>
<b class="nc">&nbsp;            savedPaymentData.setPinKeySession(props.pinKeySessionId)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        confirmRepository.requestPinKey(props.pinKeySessionId).onEach { response -&gt;</b>
<b class="nc">&nbsp;            when (response.status) {</b>
&nbsp;                &quot;SUCCESS&quot;, &quot;ALREADY_EXISTS&quot; -&gt; {
<b class="nc">&nbsp;                    GrafanaTrace.success(PayXUserEvent.ConfirmAuthenticate.event)</b>
<b class="nc">&nbsp;                    val currentSof = sofSlice.state.value.selected</b>
<b class="nc">&nbsp;                    if (currentSof?.moneySource == EnumMoneySource.Napas &amp;&amp; currentSof.info.rowCardId.isNullOrEmpty()) {</b>
<b class="nc">&nbsp;                        startNapasInputUseCase(currentSof).onEach { napasInfo -&gt;</b>
<b class="nc">&nbsp;                            if (napasInfo != null) {</b>
<b class="nc">&nbsp;                                verifyFraudData(napasInfo)</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                dispatch(TransactionReducer.Action.SetEnableConfirm(true))</b>
<b class="nc">&nbsp;                                GrafanaTrace.fail(</b>
<b class="nc">&nbsp;                                    PayXUserEvent.UserConfirm.event,</b>
<b class="nc">&nbsp;                                    TraceParameter(errorCode = TrackingErrorCode.NapasInput.code.toDouble())</b>
&nbsp;                                )
&nbsp;                            }
<b class="nc">&nbsp;                        }.launchIn(viewModelScope)</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        viewModelScope.launch {</b>
<b class="nc">&nbsp;                            verifyFraudData(null)</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;
&nbsp;                &quot;BACK_PRESS&quot;, &quot;CLOSE&quot; -&gt; {
<b class="nc">&nbsp;                    GrafanaTrace.fail(PayXUserEvent.ConfirmAuthenticate.event)</b>
<b class="nc">&nbsp;                    dispatch(TransactionReducer.Action.SetEnableConfirm(true))</b>
<b class="nc">&nbsp;                    when (props.getProcessPayType()) {</b>
&nbsp;                        SHOW_CONFIRM_DIALOG,
&nbsp;                        AUTHENTICATE_IMMEDIATELY,
&nbsp;                        BY_PASS_AUTHENTICATE_IMMEDIATELY,
&nbsp;                            -&gt; {
<b class="nc">&nbsp;                            goBack()</b>
&nbsp;                        }
&nbsp;
&nbsp;                        else -&gt; {}
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun trackPressPaymentInfoDetail() {
<b class="nc">&nbsp;        payXTracker.trackPressDetailPaymentInfo()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun trackPaymentInfoBottomSheetDisplayed() {
<b class="nc">&nbsp;        payXTracker.trackPaymentInfoBottomSheetDisplayed()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun trackClosePaymentInfoBottomSheet(buttonName: String) {
<b class="nc">&nbsp;        payXTracker.trackClosePaymentInfoBottomSheet(buttonName)</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun verifyFraudData(napasInfo: NapasInfo?) {
<b class="nc">&nbsp;        GrafanaTrace.start(PayXUserEvent.VerifyFraudData.event)</b>
<b class="nc">&nbsp;        val fraudError = verifyConfigErrorRepository.verifyFraudInfo()</b>
<b class="nc">&nbsp;        GrafanaTrace.fail(</b>
<b class="nc">&nbsp;            PayXUserEvent.VerifyFraudData.event,</b>
<b class="nc">&nbsp;            TraceParameter(errorCode = fraudError?.code?.toDouble() ?: 0.0)</b>
&nbsp;        )
<b class="nc">&nbsp;        when (fraudError) {</b>
<b class="nc">&nbsp;            is PaymentError.FraudOTPError -&gt; {</b>
<b class="nc">&nbsp;                requestOtpUseCase().catch { //TODO: tracking</b>
<b class="nc">&nbsp;                    println(it.message)</b>
<b class="nc">&nbsp;                }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;                openFraudOtpUseCase(null).launchIn(viewModelScope)</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            null -&gt; {</b>
<b class="nc">&nbsp;                if (state.value.skipLoading == true) {</b>
<b class="nc">&nbsp;                    confirmSkipLoading(napasInfo)</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    confirmWithLoading(napasInfo)</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            is PaymentError.CustomPopupError -&gt; {</b>
<b class="nc">&nbsp;                koinScope.getOrNull&lt;TransactionOverlay&gt; { parametersOf(fraudError.dialog) }</b>
<b class="nc">&nbsp;                    ?.handle()</b>
&nbsp;            }
&nbsp;
&nbsp;            else -&gt; {
<b class="nc">&nbsp;                fraudError.handlePaymentError()</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private val isSkipAuth: Boolean get() = props.getProcessPayType() == BY_PASS_AUTHENTICATE_IMMEDIATELY</b>
&nbsp;
&nbsp;    private fun confirmWithLoading(
&nbsp;        napasInfo: NapasInfo?,
&nbsp;    ) {
<b class="nc">&nbsp;        confirmUseCase(</b>
<b class="nc">&nbsp;            ConfirmRequest(null, napasInfo),</b>
<b class="nc">&nbsp;            ConfirmType.ConfirmWithLoading,</b>
<b class="nc">&nbsp;            tagName = sofSlice.state.value.version.name,</b>
<b class="nc">&nbsp;            hasADConfig = autoDebitSlice.state.value.items.isNotEmpty(),</b>
<b class="nc">&nbsp;            turnOnAD = savedPaymentData.hasExtraServiceInfo()</b>
<b class="nc">&nbsp;        ).userMetricTrace(PayXUserEvent.RedirectWithLoading.event).onEach {</b>
<b class="nc">&nbsp;            if (it.isFailure) {</b>
<b class="nc">&nbsp;                openPaymentGateway(it.exception, it.data)</b>
&nbsp;            } else {
<b class="nc">&nbsp;                handlePaymentResultUseCase(it.data)</b>
&nbsp;            }
<b class="nc">&nbsp;        }.handlePaymentConfirmError().launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun confirmSkipLoading(napasInfo: NapasInfo?) {
&nbsp;        try { // convert response from init to confirm response that can display on payment result
<b class="nc">&nbsp;            val confirmResponse = confirmRepository.convertInitToResponseData()</b>
<b class="nc">&nbsp;            handlePaymentResultUseCase(confirmResponse)</b>
<b class="nc">&nbsp;            confirmUseCase(</b>
<b class="nc">&nbsp;                ConfirmRequest(null, napasInfo),</b>
<b class="nc">&nbsp;                ConfirmType.ConfirmSkipLoading,</b>
<b class="nc">&nbsp;                tagName = sofSlice.state.value.version.name,</b>
<b class="nc">&nbsp;                hasADConfig = autoDebitSlice.state.value.items.isNotEmpty(),</b>
<b class="nc">&nbsp;                turnOnAD = savedPaymentData.hasExtraServiceInfo()</b>
<b class="nc">&nbsp;            ).userMetricTrace(PayXUserEvent.RedirectSkipLoading.event).onEach {</b>
<b class="nc">&nbsp;                val shouldRetry =</b>
<b class="nc">&nbsp;                    it.isFailure &amp;&amp; it.exception is PaymentError.SystemError &amp;&amp; (it.exception as PaymentError.SystemError).code == 40000</b>
<b class="nc">&nbsp;                if (shouldRetry) {</b>
<b class="nc">&nbsp;                    val retryConfirmRequest = ConfirmRequest(</b>
<b class="nc">&nbsp;                        null, napasInfo</b>
&nbsp;                    )
<b class="nc">&nbsp;                    confirmRepository.retryConfirm(</b>
<b class="nc">&nbsp;                        retryConfirmRequest.otp,</b>
<b class="nc">&nbsp;                        retryConfirmRequest.napasInfo,</b>
<b class="nc">&nbsp;                        ConfirmType.RetryConfirm</b>
<b class="nc">&nbsp;                    ).catch { retryErr -&gt;</b>
<b class="nc">&nbsp;                        logger.i(&quot;[PayX retryConfirm fail: $retryErr]&quot;)</b>
<b class="nc">&nbsp;                    }.launchIn(viewModelScope)</b>
&nbsp;                }
<b class="nc">&nbsp;            }.onCompletion {</b>
<b class="nc">&nbsp;                payXObserver.notify(ConfirmNotifyEvent, buildJsonObject {</b>
<b class="nc">&nbsp;                    put(&quot;isConfirmFinished&quot;, true)</b>
<b class="nc">&nbsp;                })</b>
<b class="nc">&nbsp;            }.launchIn(viewModelScope)</b>
&nbsp;        } catch (err: PaymentError) {
<b class="nc">&nbsp;            err.handlePaymentError()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun openPaymentGateway(error: Throwable, data: ConfirmResponse) {
<b class="nc">&nbsp;        when (error) {</b>
<b class="nc">&nbsp;            is PaymentError.Payment3DSError -&gt; open3DS(data)</b>
<b class="nc">&nbsp;            is PaymentError.FraudOTPError -&gt; openFraudOtpUseCase(data).launchIn(viewModelScope)</b>
<b class="nc">&nbsp;            is PaymentError.SofOTPError -&gt; handleSofOtp(data)</b>
&nbsp;            else -&gt; {
<b class="nc">&nbsp;                if (data.overlayData != null &amp;&amp; data.momoMsg?.redirectScreen == RedirectScreen.PAYMENT_REVISION.id) {</b>
<b class="nc">&nbsp;                    if (data.overlayData is VirtualBankBottomSheet) {</b>
<b class="nc">&nbsp;                        navigator.showBottomSheet(buildJsonObject {</b>
<b class="nc">&nbsp;                            put(&quot;type&quot;, &quot;payxAppToApp&quot;)</b>
<b class="nc">&nbsp;                            put(&quot;cancelable&quot;, true)</b>
<b class="nc">&nbsp;                            ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;                                VirtualBankBottomSheet.serializer(), data.overlayData</b>
<b class="nc">&nbsp;                            )?.let { put(&quot;props&quot;, it) }</b>
<b class="nc">&nbsp;                        }).onEach { dispatch(TransactionReducer.Action.SetEnableConfirm(true)) }</b>
<b class="nc">&nbsp;                            .launchIn(viewModelScope)</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        paymentSessionCenter.overlayEvent.tryEmit(data.overlayData)</b>
&nbsp;                    }
&nbsp;                } else {
&nbsp;                    throw error
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun open3DS(response: ConfirmResponse) {
<b class="nc">&nbsp;        val songbirdSetupAction =</b>
<b class="nc">&nbsp;            response.momoMsg?.purchaseInfo?.bundleSof?.get(0)?.songbirdSetupAction ?: &quot;&quot;</b>
&nbsp;
<b class="nc">&nbsp;        if (songbirdSetupAction.isNotEmpty()) {</b>
<b class="nc">&nbsp;            val params = buildJsonObject {</b>
<b class="nc">&nbsp;                put(&quot;songbirdSetupAction&quot;, songbirdSetupAction)</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            FirebaseTrace.track(WebViewDisplayed(webView = WebViewScreen.TDS_OTP))</b>
<b class="nc">&nbsp;            navigator.navigateFeatureCode(&quot;payment_3ds&quot;, params, WebView3dsResponse.serializer())</b>
<b class="nc">&nbsp;                .onEach {</b>
<b class="nc">&nbsp;                    FirebaseTrace.track(</b>
<b class="nc">&nbsp;                        WebViewDismissed(</b>
<b class="nc">&nbsp;                            actor = it?.actor ?: ScreenDismissActor.MANUAL.id,</b>
<b class="nc">&nbsp;                            webView = WebViewScreen.TDS_OTP</b>
&nbsp;                        )
&nbsp;                    )
<b class="nc">&nbsp;                }.launchIn(viewModelScope)</b>
&nbsp;        } else {
<b class="nc">&nbsp;            handlePaymentResultUseCase(response)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleSofOtp(confirmResponse: ConfirmResponse?) {
<b class="nc">&nbsp;        when (val otpType = generateOtpTypeUseCase(</b>
<b class="nc">&nbsp;            confirmResponse?.momoMsg, sofSlice.state.value.selected?.moneySource?.id</b>
&nbsp;        )) {
<b class="nc">&nbsp;            is PaymentOtpType.NapasOtp -&gt; startNapasConfirm(otpType.webViewOtp, otpType.purchaseId)</b>
<b class="nc">&nbsp;            is PaymentOtpType.BankOtp -&gt; {</b>
<b class="nc">&nbsp;                startBankOTPConfirm(</b>
<b class="nc">&nbsp;                    otpType.bankAuthType,</b>
<b class="nc">&nbsp;                    otpType.confirmExtras ?: emptyJsonObject(),</b>
<b class="nc">&nbsp;                    confirmResponse?.momoMsg?.referenceKey ?: &quot;&quot;</b>
&nbsp;                )
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            is PaymentOtpType.AppToAppOtp -&gt; startApp2AppConfirm(</b>
<b class="nc">&nbsp;                sofSlice.state.value.selected, confirmResponse, otpType.confirmExtras</b>
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            is PaymentOtpType.WebViewOtp -&gt; {</b>
<b class="nc">&nbsp;                handleWebOtp(</b>
<b class="nc">&nbsp;                    otpType.confirmExtras,</b>
<b class="nc">&nbsp;                    confirmResponse?.momoMsg?.referenceKey ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                    sofSlice.state.value.selected</b>
&nbsp;                )
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    private fun handleWebOtp(
&nbsp;        confirmExtras: JsonObject?,
&nbsp;        referenceKey: String,
<b class="nc">&nbsp;        selectedSof: SOFItem? = null,</b>
&nbsp;    ) {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            val callbackData = confirmOtpWebViewUseCase.startWebOtp(confirmExtras, selectedSof)</b>
<b class="nc">&nbsp;            if (callbackData?.isContinuous == true) {</b>
<b class="nc">&nbsp;                confirmOtpWebViewUseCase.onContinueConfirm()</b>
<b class="nc">&nbsp;                handleConfirmOtp(</b>
<b class="nc">&nbsp;                    ConfirmWithOtpRequest(</b>
<b class="nc">&nbsp;                        callbackData.otp, &quot;PAYMENT&quot;, referenceKey</b>
<b class="nc">&nbsp;                    ), ConfirmType.ConfirmOtpWebView</b>
&nbsp;                )
&nbsp;            } else {
<b class="nc">&nbsp;                confirmOtpWebViewUseCase.onCancelConfirm()</b>
<b class="nc">&nbsp;                dispatch(TransactionReducer.Action.SetEnableConfirm(true))</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleConfirmOtp(
&nbsp;        confirmWithOtpRequest: ConfirmWithOtpRequest,
&nbsp;        confirmType: ConfirmType,
&nbsp;    ) {
<b class="nc">&nbsp;        confirmWithOtpUseCase(confirmWithOtpRequest, confirmType).handleConfirmOverlay().onEach {</b>
<b class="nc">&nbsp;            if (it.isFailure) {</b>
<b class="nc">&nbsp;                throw it.exception</b>
&nbsp;            }
<b class="nc">&nbsp;            handlePaymentResultUseCase(it.data)</b>
<b class="nc">&nbsp;        }.handlePaymentConfirmError().launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun startNapasConfirm(webViewUrl: String, purchaseId: String) {
<b class="nc">&nbsp;        val params = buildJsonObject {</b>
<b class="nc">&nbsp;            put(&quot;webViewUrl&quot;, webViewUrl)</b>
<b class="nc">&nbsp;            put(&quot;shouldHandleOnDone&quot;, true)</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        FirebaseTrace.track(WebViewDisplayed(webView = WebViewScreen.NAPAS_OTP))</b>
<b class="nc">&nbsp;        GrafanaTrace.start(PayXUserEvent.NapasOtp.event)</b>
<b class="nc">&nbsp;        navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;            &quot;payment_confirm_napas&quot;, params, NapasConfirmCallbackData.serializer()</b>
<b class="nc">&nbsp;        ).onEach {</b>
<b class="nc">&nbsp;            FirebaseTrace.track(WebViewDismissed(webView = WebViewScreen.NAPAS_OTP))</b>
<b class="nc">&nbsp;            it?.let { callbackData -&gt;</b>
<b class="nc">&nbsp;                when (callbackData.type) {</b>
<b class="nc">&nbsp;                    NapasCallBackType.ON_DONE_OTP.type -&gt; {</b>
<b class="nc">&nbsp;                        GrafanaTrace.success(PayXUserEvent.NapasOtp.event)</b>
<b class="nc">&nbsp;                        FirebaseTrace.track(</b>
<b class="nc">&nbsp;                            WebViewDismissed(</b>
<b class="nc">&nbsp;                                webView = WebViewScreen.NAPAS_OTP,</b>
<b class="nc">&nbsp;                                actor = ScreenDismissActor.SYSTEM.id</b>
&nbsp;                            )
&nbsp;                        )
<b class="nc">&nbsp;                        val referenceKey = handleSofOtpUseCase.buildReferenceKey(</b>
<b class="nc">&nbsp;                            callbackData.transaction, purchaseId</b>
&nbsp;                        )
<b class="nc">&nbsp;                        confirmWithOtpUseCase(</b>
<b class="nc">&nbsp;                            ConfirmWithOtpRequest(</b>
<b class="nc">&nbsp;                                null, &quot;PAYMENT&quot;, referenceKey</b>
<b class="nc">&nbsp;                            ), ConfirmType.ConfirmOtpNapas</b>
<b class="nc">&nbsp;                        ).handleConfirmOverlay().onEach { otpResponse -&gt;</b>
<b class="nc">&nbsp;                            if (otpResponse.isFailure) {</b>
<b class="nc">&nbsp;                                throw otpResponse.exception</b>
&nbsp;                            }
<b class="nc">&nbsp;                            handlePaymentResultUseCase(otpResponse.data)</b>
<b class="nc">&nbsp;                        }.handlePaymentConfirmError().launchIn(viewModelScope)</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    NapasCallBackType.ON_BACK_OTP.type -&gt; {</b>
<b class="nc">&nbsp;                        TransactionReducer.Action.SetEnableConfirm(true)</b>
<b class="nc">&nbsp;                        GrafanaTrace.fail(PayXUserEvent.NapasOtp.event)</b>
<b class="nc">&nbsp;                        FirebaseTrace.track(</b>
<b class="nc">&nbsp;                            WebViewDismissed(</b>
<b class="nc">&nbsp;                                webView = WebViewScreen.NAPAS_OTP,</b>
<b class="nc">&nbsp;                                actor = ScreenDismissActor.MANUAL.id</b>
&nbsp;                            )
&nbsp;                        )
<b class="nc">&nbsp;                        GrafanaTrace.fail(</b>
<b class="nc">&nbsp;                            PayXUserEvent.UserConfirm.event,</b>
<b class="nc">&nbsp;                            TraceParameter(errorCode = TrackingErrorCode.NapasOtpCancel.code.toDouble())</b>
&nbsp;                        )
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun startBankOTPConfirm(
&nbsp;        bankAuthType: String, confirmExtras: JsonObject, referenceKey: String,
&nbsp;    ) {
<b class="nc">&nbsp;        GrafanaTrace.start(PayXUserEvent.BankLinkedOtp.event)</b>
<b class="nc">&nbsp;        FirebaseTrace.track(WebViewDisplayed(webView = WebViewScreen.BANK_OTP))</b>
<b class="nc">&nbsp;        startBankOtpNativeUseCase(</b>
<b class="nc">&nbsp;            bankAuthType, confirmExtras, sofSlice.state.value.selected, &quot;multi&quot;</b>
<b class="nc">&nbsp;        ).onEach {</b>
<b class="nc">&nbsp;            FirebaseTrace.track(WebViewDismissed(webView = WebViewScreen.BANK_OTP))</b>
<b class="nc">&nbsp;            it?.let { callbackData -&gt;</b>
<b class="nc">&nbsp;                if (callbackData.onPressBack) {</b>
<b class="nc">&nbsp;                    GrafanaTrace.fail(</b>
<b class="nc">&nbsp;                        PayXUserEvent.UserConfirm.event,</b>
<b class="nc">&nbsp;                        TraceParameter(errorCode = TrackingErrorCode.BankOtpCancel.code.toDouble())</b>
&nbsp;                    )
<b class="nc">&nbsp;                    GrafanaTrace.fail(PayXUserEvent.BankLinkedOtp.event)</b>
<b class="nc">&nbsp;                    FirebaseTrace.track(</b>
<b class="nc">&nbsp;                        WebViewDismissed(</b>
<b class="nc">&nbsp;                            webView = WebViewScreen.BANK_OTP, actor = ScreenDismissActor.MANUAL.id</b>
&nbsp;                        )
&nbsp;                    )
<b class="nc">&nbsp;                    dispatch(TransactionReducer.Action.SetEnableConfirm(true))</b>
<b class="nc">&nbsp;                } else if (callbackData.onInputOTP) {</b>
<b class="nc">&nbsp;                    GrafanaTrace.success(PayXUserEvent.BankLinkedOtp.event)</b>
<b class="nc">&nbsp;                    confirmWithOtpUseCase(</b>
<b class="nc">&nbsp;                        ConfirmWithOtpRequest(</b>
<b class="nc">&nbsp;                            callbackData.otp, &quot;PAYMENT&quot;, referenceKey</b>
<b class="nc">&nbsp;                        ), ConfirmType.ConfirmOtpBankLinked</b>
<b class="nc">&nbsp;                    ).handleConfirmOverlay().onEach { confirmResponse -&gt;</b>
<b class="nc">&nbsp;                        if (confirmResponse.isFailure) {</b>
<b class="nc">&nbsp;                            throw confirmResponse.exception</b>
&nbsp;                        }
<b class="nc">&nbsp;                        handlePaymentResultUseCase(confirmResponse.data)</b>
<b class="nc">&nbsp;                    }.handlePaymentConfirmError().launchIn(viewModelScope)</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun startApp2AppConfirm(
&nbsp;        currentSof: SOFItem?, confirmResponse: ConfirmResponse?, confirmExtras: JsonObject?,
&nbsp;    ) {
<b class="nc">&nbsp;        val purchaseId = state.value.purchaseId</b>
<b class="nc">&nbsp;        val tidBank = confirmResponse?.momoMsg?.purchaseInfo?.bundleSof?.get(0)?.sofTid</b>
<b class="nc">&nbsp;        val bankCode = currentSof?.info?.bankCode ?: &quot;&quot;</b>
&nbsp;
<b class="nc">&nbsp;        app2appRepository.saveOTPInfo(</b>
<b class="nc">&nbsp;            purchaseId,</b>
<b class="nc">&nbsp;            tidBank?.toLong()?.toString(),</b>
<b class="nc">&nbsp;            paymentSessionCenter.requestPayXData.miniAppWidgetId</b>
&nbsp;        )
<b class="nc">&nbsp;        navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;            &quot;wait_otp_bank_in_app&quot;, buildJsonObject {</b>
<b class="nc">&nbsp;                put(&quot;typeScreen&quot;, &quot;BANK_PAYMENT&quot;)</b>
<b class="nc">&nbsp;                put(&quot;bankCode&quot;, bankCode)</b>
<b class="nc">&nbsp;                if (confirmExtras != null) {</b>
<b class="nc">&nbsp;                    put(&quot;extras&quot;, confirmExtras)</b>
&nbsp;                }
<b class="nc">&nbsp;            }, String.serializer()</b>
<b class="nc">&nbsp;        ).launchIn(viewModelScope)</b>
<b class="nc">&nbsp;        GrafanaTrace.success(PayXUserEvent.UserConfirm.event)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun navigateChoosePromotion(status: PromotionStatus) {
<b class="nc">&nbsp;        trackChoosePromotion(status, sofSlice.state.value.version)</b>
<b class="nc">&nbsp;        val moneySource = sofSlice.state.value.selected?.moneySource?.id</b>
<b class="nc">&nbsp;        val promotions = state.value.promotion.promoDisplay</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            val params =</b>
<b class="nc">&nbsp;                generateChoosePromotionUseCase(moneySource, promotions, sofSlice.state.value.list)</b>
<b class="nc">&nbsp;            navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;                &quot;choose_promotion_v2&quot;, params, ChoosePromotionCallbackData.serializer()</b>
<b class="nc">&nbsp;            ).onEach {</b>
<b class="nc">&nbsp;                logger.i(&quot;[PayX] - select_promotion: $it&quot;)</b>
<b class="nc">&nbsp;                it?.let { callbackData -&gt;</b>
<b class="nc">&nbsp;                    if (callbackData.onPromotionChanged) {</b>
<b class="nc">&nbsp;                        val selectedVouchers =</b>
<b class="nc">&nbsp;                            voucherRepository.storedVoucherToLocal(callbackData.selectedVouchers)</b>
<b class="nc">&nbsp;                        trackChoosePromotionSuccess()</b>
<b class="nc">&nbsp;                        onChangePromotion(</b>
<b class="nc">&nbsp;                            selectedVouchers, discountCode = callbackData.discountCode ?: &quot;&quot;</b>
&nbsp;                        )
&nbsp;                    } else {
<b class="nc">&nbsp;                        trackChoosePromotionFail()</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }.launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun onChangePromotion(
&nbsp;        selectedVouchers: List&lt;VoucherItemLocal&gt;, discountCode: String,
&nbsp;    ) {
<b class="nc">&nbsp;        trackChangePromotion()</b>
<b class="nc">&nbsp;        val currentSof = sofSlice.state.value.selected</b>
<b class="nc">&nbsp;        val invoiceList = state.value.invoices.map { it.copy() }</b>
<b class="nc">&nbsp;        val sofList = sofSlice.state.value.list</b>
<b class="nc">&nbsp;        val discountCodes = if (discountCode.isNotEmpty()) listOf(discountCode) else emptyList()</b>
<b class="nc">&nbsp;        currentSof?.let { sof -&gt;</b>
<b class="nc">&nbsp;            sofSlice.onUpdateTransaction()</b>
<b class="nc">&nbsp;            updateUseCases.changePromotion(</b>
<b class="nc">&nbsp;                invoiceList, sof, sofList, selectedVouchers, discountCodes</b>
<b class="nc">&nbsp;            ).handleOverlay().onEach {</b>
<b class="nc">&nbsp;                if (!it.exception.isNoResponseError()) {</b>
<b class="nc">&nbsp;                    val data = it.data</b>
<b class="nc">&nbsp;                    updateTransaction(data)</b>
<b class="nc">&nbsp;                    sofSlice.callRecommendMoneyPay(</b>
<b class="nc">&nbsp;                        data.selectedSof, data.purchaseId, data.serviceType</b>
&nbsp;                    )
&nbsp;                }
<b class="nc">&nbsp;                trackChangePromotionFinished(it)</b>
<b class="nc">&nbsp;                if (it.isFailure) {</b>
<b class="nc">&nbsp;                    throw it.exception</b>
&nbsp;                }
<b class="nc">&nbsp;            }.handlePaymentError().launchIn(viewModelScope)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun updateTransaction(updatedData: PayXTransaction) {
<b class="nc">&nbsp;        updateUi(updatedData)</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            async { orderExtraRepository.updateConfig() }</b>
<b class="nc">&nbsp;            async { rewardSlice.refetchConfig(updatedData.sofList) }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun onFirstCheckoutResponse(updatedData: PayXTransaction) {
<b class="nc">&nbsp;        updateUi(updatedData)</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            async { orderExtraRepository.getCheckoutConfig() }</b>
<b class="nc">&nbsp;            async { rewardSlice.refetchConfig(updatedData.sofList) }</b>
&nbsp;        }
<b class="nc">&nbsp;        xSaleSlice.getDisplayConfig(updatedData.purchaseId)</b>
<b class="nc">&nbsp;        if (sofSlice.state.value.version.code == 1) {</b>
<b class="nc">&nbsp;            autoDebitSlice.getConfig(sofSlice.state.value.version.name)</b>
&nbsp;        }
<b class="nc">&nbsp;        if (updatedData.serviceCartData?.dialog != null) {</b>
<b class="nc">&nbsp;            quickPaySlice.dispatch(PaymentQuickPayReducer.QuickPayAction.ErrorCheckout)</b>
&nbsp;            return
&nbsp;        }
<b class="nc">&nbsp;        quickPaySlice.dispatch(PaymentQuickPayReducer.QuickPayAction.OnCheckoutSuccess)</b>
<b class="nc">&nbsp;        when (props.getProcessPayType()) {</b>
&nbsp;            AUTHENTICATE_IMMEDIATELY,
&nbsp;            BY_PASS_AUTHENTICATE_IMMEDIATELY,
<b class="nc">&nbsp;                -&gt; onConfirm()</b>
&nbsp;
&nbsp;            else -&gt; {}
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun updateUi(updatedData: PayXTransaction) {
<b class="nc">&nbsp;        dispatch(</b>
<b class="nc">&nbsp;            TransactionReducer.Action.SetTransaction(</b>
<b class="nc">&nbsp;                TransactionReducer.State(</b>
<b class="nc">&nbsp;                    enableConfirm = updatedData.enableConfirm,</b>
<b class="nc">&nbsp;                    skipLoading = updatedData.skipLoading,</b>
<b class="nc">&nbsp;                    fraudInfo = updatedData.fraudInfo,</b>
<b class="nc">&nbsp;                    promotion = updatedData.promotion,</b>
<b class="nc">&nbsp;                    purchaseId = updatedData.purchaseId,</b>
<b class="nc">&nbsp;                    sourceMessage = updatedData.sourceMessage,</b>
<b class="nc">&nbsp;                    invoices = updatedData.invoiceList,</b>
<b class="nc">&nbsp;                    amount = updatedData.totalAmount,</b>
<b class="nc">&nbsp;                    inlineMessage = updatedData.inlineMessage,</b>
<b class="nc">&nbsp;                    hideAmount = updatedData.hideAmount == true,</b>
<b class="nc">&nbsp;                    serviceCartData = updatedData.serviceCartData</b>
&nbsp;                )
&nbsp;            )
&nbsp;        )
<b class="nc">&nbsp;        sofSlice.updateSof(</b>
<b class="nc">&nbsp;            updatedData.sofList, updatedData.selectedSof, updatedData.totalAmount.total.value</b>
&nbsp;        )
<b class="nc">&nbsp;        if (updatedData.isEmptySof || sofSlice.state.value.cta.isNotEmpty()) {</b>
<b class="nc">&nbsp;            sofSlice.refetchSof()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onClickShowAll() {
<b class="nc">&nbsp;        trackClickShowAllSof(sofSlice.state.value.version)</b>
<b class="nc">&nbsp;        openSuggestSofBottomSheet(false)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun openSuggestSofBottomSheet(shouldSuggestFirstSof: Boolean) {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            if (shouldSuggestFirstSof) {</b>
<b class="nc">&nbsp;                GrafanaTrace.count(PayXUserEvent.SuggestFirstSofBts.event)</b>
&nbsp;            }
<b class="nc">&nbsp;            navigator.showBottomSheet(buildJsonObject {</b>
<b class="nc">&nbsp;                put(&quot;type&quot;, &quot;suggestedSof&quot;)</b>
<b class="nc">&nbsp;                put(</b>
<b class="nc">&nbsp;                    &quot;props&quot;, ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;                        SuggestedSofBottomSheetProps.serializer(), SuggestedSofBottomSheetProps(</b>
<b class="nc">&nbsp;                            props.isAllowAddSource,</b>
<b class="nc">&nbsp;                            isAllowAddCard = true,</b>
<b class="nc">&nbsp;                            shouldSuggestFirstSof,</b>
<b class="nc">&nbsp;                            transactionAmount = state.value.amount.total.value,</b>
<b class="nc">&nbsp;                            koinId = koinScope.id,</b>
<b class="nc">&nbsp;                            suggestedSofType = SuggestedSofType.Multi.name</b>
&nbsp;                        )
<b class="nc">&nbsp;                    ) ?: emptyJsonObject()</b>
&nbsp;                )
<b class="nc">&nbsp;                put(&quot;cancelable&quot;, true)</b>
<b class="nc">&nbsp;            }).launchIn(this)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun selectInstallmentPackage(installmentPackageState: InstallmentPackageState) {
<b class="nc">&nbsp;        sofSlice.trackPressInstallment(sofSlice.state.value.version)</b>
<b class="nc">&nbsp;        pickInstallmentUseCases.convertToSofItem(installmentPackageState)?.let {</b>
<b class="nc">&nbsp;            sofSlice.dispatch(Action.MoveOrAddSofToFirst(it))</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    fun openInstallmentInstruction() {
<b class="nc">&nbsp;        viewModelScope.launch { pickInstallmentUseCases.onPressReadMore() }</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun handleRegisterDirectDebit() {
<b class="nc">&nbsp;        directDebitUseCase().onEach { newSof -&gt;</b>
<b class="nc">&nbsp;            newSof?.let {</b>
<b class="nc">&nbsp;                sofSlice.dispatch(Action.ChangeSof(newSof))</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun handleShowDDToast(type: String?) {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            if (type == &quot;success&quot;) {</b>
<b class="nc">&nbsp;                navigator.showToast(</b>
<b class="nc">&nbsp;                    buildJsonObject {</b>
<b class="nc">&nbsp;                        put(&quot;title&quot;, getString(Res.string.successToastDirectDebitTitle))</b>
<b class="nc">&nbsp;                        put(&quot;type&quot;, &quot;success&quot;)</b>
<b class="nc">&nbsp;                        put(&quot;duration&quot;, 3000)</b>
<b class="nc">&nbsp;                    }, String.serializer()</b>
<b class="nc">&nbsp;                ).collect {}</b>
&nbsp;            } else {
<b class="nc">&nbsp;                navigator.showToast(</b>
<b class="nc">&nbsp;                    buildJsonObject {</b>
<b class="nc">&nbsp;                        put(&quot;title&quot;, getString(Res.string.errorToastDirectDebitTitle))</b>
<b class="nc">&nbsp;                        put(&quot;undoTitle&quot;, getString(Res.string.retryDirectDebitTitle))</b>
<b class="nc">&nbsp;                        put(&quot;type&quot;, &quot;warning&quot;)</b>
<b class="nc">&nbsp;                        put(&quot;duration&quot;, 5000)</b>
<b class="nc">&nbsp;                    }, String.serializer()</b>
<b class="nc">&nbsp;                ).onEach {</b>
<b class="nc">&nbsp;                    if (it == &quot;action&quot;) {</b>
<b class="nc">&nbsp;                        handleOnDirectDebit()</b>
&nbsp;                    }
<b class="nc">&nbsp;                }.launchIn(this)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun handleOnDirectDebit() {
<b class="nc">&nbsp;        val currentSofInfo = sofSlice.state.value.selected?.info</b>
<b class="nc">&nbsp;        directDebitRepository.handleOnDirectDebit(</b>
<b class="nc">&nbsp;            bankCode = currentSofInfo?.bankCode,</b>
<b class="nc">&nbsp;            action = DirectDebitAction.REGISTER.action,</b>
<b class="nc">&nbsp;            serviceId = &quot;direct_debit&quot;,</b>
<b class="nc">&nbsp;            msgType = DirectDebitMsgType.REG_UNREG.type</b>
<b class="nc">&nbsp;        ).onEach { data -&gt;</b>
<b class="nc">&nbsp;            if (data.errorCode == 0) {</b>
<b class="nc">&nbsp;                handleShowDDToast(&quot;success&quot;)</b>
<b class="nc">&nbsp;                data.sourceToken?.let {</b>
<b class="nc">&nbsp;                    sofSlice.findSof(data.sourceToken, null)?.let { sof -&gt;</b>
<b class="nc">&nbsp;                        sofSlice.dispatch(Action.ChangeSof(sof))</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            } else {
<b class="nc">&nbsp;                handleShowDDToast(&quot;fail&quot;)</b>
<b class="nc">&nbsp;                dispatch(TransactionReducer.Action.SetEnableConfirm(false))</b>
&nbsp;            }
<b class="nc">&nbsp;        }.catch {</b>
<b class="nc">&nbsp;            handleShowDDToast(&quot;fail&quot;)</b>
<b class="nc">&nbsp;            dispatch(TransactionReducer.Action.SetEnableConfirm(false))</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun handleChangeSourceDirectDebit() {
<b class="nc">&nbsp;        openSuggestSofBottomSheet(false)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onToggleCartDetail(newState: String) {
<b class="nc">&nbsp;        trackCartDetailTriggered(newState, version = sofSlice.state.value.version)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun addSof() {
<b class="nc">&nbsp;        sofSlice.trackItemSofClicked(&quot;add_sof&quot;, sofSlice.state.value.version)</b>
<b class="nc">&nbsp;        sofSlice.addBankToSof()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun addCard() {
<b class="nc">&nbsp;        sofSlice.trackItemSofClicked(&quot;add_tqt&quot;, sofSlice.state.value.version)</b>
<b class="nc">&nbsp;        sofSlice.navigateAddInternationalCard()</b>
&nbsp;    }
&nbsp;
&nbsp;    suspend fun getAmountInfo(
&nbsp;        amount: TotalAmount, promoDisplay: List&lt;PromoDisplay&gt;,
&nbsp;    ): List&lt;InfoRowContent&gt; {
<b class="nc">&nbsp;        val amountInfo = mutableListOf&lt;InfoRowContent&gt;()</b>
<b class="nc">&nbsp;        if (amount.subTotalAmount.isShow) {</b>
<b class="nc">&nbsp;            amountInfo.add(</b>
<b class="nc">&nbsp;                InfoRowContent(</b>
<b class="nc">&nbsp;                    key = InfoContent(data = getString(Res.string.subTotalAmount)),</b>
<b class="nc">&nbsp;                    value = InfoContent(data = amount.subTotalAmount.format)</b>
&nbsp;                )
&nbsp;            )
&nbsp;        }
<b class="nc">&nbsp;        if (amount.fee.isShow) {</b>
<b class="nc">&nbsp;            amountInfo.add(</b>
<b class="nc">&nbsp;                InfoRowContent(</b>
<b class="nc">&nbsp;                    key = InfoContent(data = getString(Res.string.totalFee)),</b>
<b class="nc">&nbsp;                    value = InfoContent(data = amount.fee.format)</b>
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (amount.conversionFee.isShow) {</b>
<b class="nc">&nbsp;            amountInfo.add(</b>
<b class="nc">&nbsp;                InfoRowContent(</b>
<b class="nc">&nbsp;                    key = InfoContent(data = getString(Res.string.conversionFee)),</b>
<b class="nc">&nbsp;                    value = InfoContent(data = amount.conversionFee.format)</b>
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        promoDisplay.forEach {</b>
<b class="nc">&nbsp;            val value = it.amount?.toDouble()?.formatCurrency() ?: &quot;&quot;</b>
<b class="nc">&nbsp;            if (it.valid) {</b>
<b class="nc">&nbsp;                amountInfo.add(</b>
<b class="nc">&nbsp;                    InfoRowContent(</b>
<b class="nc">&nbsp;                        key = InfoContent(data = it.name),</b>
<b class="nc">&nbsp;                        value = InfoContent(</b>
<b class="nc">&nbsp;                            data = if (it.isCashBack) value else &quot;-$value&quot;, color = Colors.green_03</b>
&nbsp;                        ),
&nbsp;                    )
&nbsp;                )
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        return amountInfo.toList()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun getVersion(tag: String?) {
<b class="nc">&nbsp;        val isBlocked = paymentSessionCenter.requestPayXData.blockRevamp()</b>
<b class="nc">&nbsp;        val version = if (tag == &quot;treatment_1&quot; &amp;&amp; !isBlocked) 2 else 1</b>
<b class="nc">&nbsp;        sofSlice.dispatch(</b>
<b class="nc">&nbsp;            Action.UpdateVersion(UiVersion(code = version, name = tag ?: &quot;control&quot;))</b>
&nbsp;        )
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-22 15:26</div>
</div>
</body>
</html>
