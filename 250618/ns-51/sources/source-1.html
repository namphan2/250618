


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > NapasInputVM</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.napas.presentation.viewmodel</a>
</div>

<h1>Coverage Summary for Class: NapasInputVM (vn.momo.compose.payment.napas.presentation.viewmodel)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">NapasInputVM</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/65)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/144)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1507)
  </span>
</td>
</tr>
  <tr>
    <td class="name">NapasInputVM$getCustomErrorMessageByCardType$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">NapasInputVM$getValidatorByField$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">NapasInputVM$handleSubmitError$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">NapasInputVM$onCreate$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/62)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/566)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">NapasInputVM$onSubmit$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/131)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">NapasInputVM$onSubmit$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/137)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">NapasInputVM$onSubmit$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">NapasInputVM$showDateSelection$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">NapasInputVM$showInstruction$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/187)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">NapasInputVM$showInstruction$1$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">NapasInputVM$WhenMappings</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/159)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/263)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2574)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.napas.presentation.viewmodel
&nbsp;
&nbsp;import kotlinx.coroutines.flow.catch
&nbsp;import kotlinx.coroutines.flow.launchIn
&nbsp;import kotlinx.coroutines.flow.onEach
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.json.buildJsonObject
&nbsp;import kotlinx.serialization.json.jsonObject
&nbsp;import kotlinx.serialization.json.jsonPrimitive
&nbsp;import kotlinx.serialization.json.put
&nbsp;import org.jetbrains.compose.resources.getString
&nbsp;import vn.momo.compose.payment.base.core.composeApi.ILogger
&nbsp;import vn.momo.compose.payment.base.core.composeApi.INavigator
&nbsp;import vn.momo.compose.payment.base.core.composeApi.route.IRouteApi
&nbsp;import vn.momo.compose.payment.base.core.model.NavigatorErrorPopup
&nbsp;import vn.momo.compose.payment.base.domain.entities.ENapasExpectedTypeCallback
&nbsp;import vn.momo.compose.payment.base.domain.entities.error.DevError
&nbsp;import vn.momo.compose.payment.napas.domain.entities.CardSubmitParams
&nbsp;import vn.momo.compose.payment.napas.domain.entities.NapasInputResponseError
&nbsp;import vn.momo.compose.payment.napas.domain.repositories.INapasInputRepository
&nbsp;import vn.momo.compose.payment.napas.presentation.utils.extension.FormValidator
&nbsp;import vn.momo.compose.payment.napas.presentation.utils.extension.ValidateType
&nbsp;import vn.momo.compose.payment.napas.presentation.utils.extension.removeInvalidChar
&nbsp;import vn.momo.compose.payment.napas.presentation.view.model.ConfirmNapasCallbackData
&nbsp;import vn.momo.compose.payment.napas.presentation.view.model.FieldData
&nbsp;import vn.momo.compose.payment.napas.presentation.view.model.FormField
&nbsp;import vn.momo.compose.payment.napas.presentation.view.model.NapasInputProps
&nbsp;import vn.momo.compose.payment.napas.presentation.view.model.NapasType
&nbsp;import vn.momo.compose.payment.napas.presentation.viewmodel.reducer.InputFieldState
&nbsp;import vn.momo.compose.payment.napas.presentation.viewmodel.reducer.NapasInputReducer
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.ViewModel
&nbsp;import vn.momo.compose.resources.Res
&nbsp;import vn.momo.compose.resources.cardErrorMessage
&nbsp;import vn.momo.compose.resources.cardErrorMessage2
&nbsp;import vn.momo.compose.resources.cardErrorMessage3
&nbsp;import vn.momo.compose.resources.cardExpireDateTitle
&nbsp;import vn.momo.compose.resources.cardIssueDateTitle
&nbsp;import vn.momo.compose.resources.customRegexMsg
&nbsp;import vn.momo.compose.resources.customRegexMsg2
&nbsp;import vn.momo.compose.resources.errorDefaultTitle
&nbsp;import vn.momo.compose.resources.holderNameErrorMessage1
&nbsp;import vn.momo.compose.resources.holderNameErrorMessage2
&nbsp;import vn.momo.compose.resources.holderNameTitle
&nbsp;import vn.momo.compose.resources.identifyErrorMessage1
&nbsp;import vn.momo.compose.resources.identifyErrorMessage2
&nbsp;import vn.momo.compose.resources.messageBankLinkResultMapSuccess
&nbsp;import vn.momo.compose.resources.titleCardNumber
&nbsp;import vn.momo.compose.resources.cardDesc
&nbsp;import vn.momo.compose.resources.holderNameDesc
&nbsp;import vn.momo.compose.resources.cardIssueDateDesc
&nbsp;import vn.momo.compose.resources.cardExpireDateDesc
&nbsp;import vn.momo.compose.utils.datamapping.ModelConvertUtils
&nbsp;import vn.momo.compose.utils.emptyJsonObject
&nbsp;import vn.momo.compose.utils.toJsonElement
&nbsp;import vn.momo.compose.utils.tryGetString
&nbsp;import vn.momo.compose.utils.tryGetStringNullable
&nbsp;import vn.momo.core.features.sofManager.constants.MoneySource
&nbsp;
&nbsp;class NapasInputVM(
<b class="nc">&nbsp;    val repository: INapasInputRepository,</b>
<b class="nc">&nbsp;    val navigator: INavigator,</b>
<b class="nc">&nbsp;    val routeApi: IRouteApi,</b>
<b class="nc">&nbsp;    val logger: ILogger,</b>
&nbsp;) :
<b class="nc">&nbsp;    ViewModel&lt;NapasInputReducer.State, NapasInputReducer.Action, NapasInputReducer.Effect&gt;(</b>
<b class="nc">&nbsp;        NapasInputReducer.State(),</b>
<b class="nc">&nbsp;        NapasInputReducer()</b>
&nbsp;    ) {
&nbsp;
<b class="nc">&nbsp;    lateinit var props: NapasInputProps</b>
&nbsp;
<b class="nc">&nbsp;    private val logName = &quot;NAPAS_INPUT_VM&quot;</b>
<b class="nc">&nbsp;    val formFieldData: MutableMap&lt;FormField, FieldData&gt; = mutableMapOf(</b>
<b class="nc">&nbsp;        FormField.CARD_NUMBER to FieldData(</b>
<b class="nc">&nbsp;            popupImage = &quot;https://i.imgur.com/8NwX8zx.png&quot;,</b>
<b class="nc">&nbsp;            validationRegex = &quot;^[0-9]{4} [0-9]{4} [0-9]{4} [0-9]{4}&quot;</b>
&nbsp;        ),
<b class="nc">&nbsp;        FormField.CARD_FULL_NAME to FieldData(</b>
<b class="nc">&nbsp;            popupImage = &quot;https://i.imgur.com/gk8VY1x.png&quot;,</b>
<b class="nc">&nbsp;            validationRegex = &quot;^([a-zA-Z.-]+\\s?)+\\s*\$&quot;</b>
&nbsp;        ),
<b class="nc">&nbsp;        FormField.CARD_ISSUE_DATE to FieldData(</b>
<b class="nc">&nbsp;            popupImage = &quot;https://i.imgur.com/qB9WNqq.png&quot;,</b>
<b class="nc">&nbsp;            validationRegex = &quot;.*&quot;</b>
&nbsp;        ),
<b class="nc">&nbsp;        FormField.CARD_EXPIRE_DATE to FieldData(</b>
<b class="nc">&nbsp;            popupImage = &quot;https://i.imgur.com/qB9WNqq.png&quot;,</b>
<b class="nc">&nbsp;            validationRegex = &quot;.*&quot;</b>
&nbsp;        ),
<b class="nc">&nbsp;        FormField.PERSONAL_ID to FieldData(</b>
<b class="nc">&nbsp;            validationRegex = &quot;^[0-9a-zA-Z]{8,12}\$&quot;</b>
&nbsp;        )
&nbsp;    )
&nbsp;
&nbsp;    fun onCreate(params: Map&lt;String, Any?&gt;) {
<b class="nc">&nbsp;        props = ModelConvertUtils.decode(NapasInputProps.serializer(), params) ?: NapasInputProps()</b>
<b class="nc">&nbsp;        logger.i(&quot;$logName props: $props $params&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            val profileData = repository.getProfileData()</b>
<b class="nc">&nbsp;            val nameKyc = profileData?.nameKyc?.removeInvalidChar()?.uppercase() ?: &quot;&quot;</b>
<b class="nc">&nbsp;            val personalId = profileData?.bankVerifyPersonalid ?: &quot;&quot;</b>
<b class="nc">&nbsp;            val isExpireDateForm = props.expiredCardTypes?.contains(props.cardType) ?: false</b>
<b class="nc">&nbsp;            val isHideCardIssueDate = props.hideCardIssueDates?.contains(props.cardType) ?: false</b>
<b class="nc">&nbsp;            val isDisableKyc = nameKyc.isNotEmpty()</b>
<b class="nc">&nbsp;            val isHidePersonalId = personalId.isNotEmpty()</b>
<b class="nc">&nbsp;            logger.i(&quot;$logName profileData: $profileData&quot;)</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;            if (isHideCardIssueDate) {</b>
<b class="nc">&nbsp;                formFieldData[FormField.CARD_ISSUE_DATE]?.let { fieldData -&gt;</b>
<b class="nc">&nbsp;                    formFieldData[FormField.CARD_ISSUE_DATE] = fieldData.copy(isHide = true)</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                formFieldData[FormField.CARD_EXPIRE_DATE]?.let { field -&gt;</b>
<b class="nc">&nbsp;                    formFieldData[FormField.CARD_EXPIRE_DATE] = field.copy(isHide = true)</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            } else {
<b class="nc">&nbsp;                if (isExpireDateForm) {</b>
<b class="nc">&nbsp;                    formFieldData[FormField.CARD_ISSUE_DATE]?.let { fieldData -&gt;</b>
<b class="nc">&nbsp;                        formFieldData[FormField.CARD_ISSUE_DATE] = fieldData.copy(isHide = true)</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    formFieldData[FormField.CARD_EXPIRE_DATE]?.let { fieldData -&gt;</b>
<b class="nc">&nbsp;                        formFieldData[FormField.CARD_EXPIRE_DATE] = fieldData.copy(isHide = true)</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (isDisableKyc) {</b>
<b class="nc">&nbsp;                formFieldData[FormField.CARD_FULL_NAME]?.let { fieldData -&gt;</b>
<b class="nc">&nbsp;                    formFieldData[FormField.CARD_FULL_NAME] = fieldData.copy(isDisable = true)</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (isHidePersonalId) {</b>
<b class="nc">&nbsp;                formFieldData[FormField.PERSONAL_ID]?.let {</b>
<b class="nc">&nbsp;                    formFieldData[FormField.PERSONAL_ID] = it.copy(isHide = true)</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;            props.cardType?.let {</b>
<b class="nc">&nbsp;                formFieldData[FormField.CARD_NUMBER]?.let { fieldData -&gt;</b>
<b class="nc">&nbsp;                    formFieldData[FormField.CARD_NUMBER] = fieldData.copy(</b>
<b class="nc">&nbsp;                        validationRegex = getCustomRegexByCardType(it)</b>
<b class="nc">&nbsp;                            ?: &quot;^[0-9]{4}\\s?[0-9]{4}\\s?[0-9]{4}\\s?[0-9]{4}$&quot;,</b>
<b class="nc">&nbsp;                        errMsg = getCustomErrorMessageByCardType(it) ?: &quot;&quot;</b>
&nbsp;                    )
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;            val initialState: Map&lt;FormField, InputFieldState&gt; =</b>
<b class="nc">&nbsp;                formFieldData</b>
<b class="nc">&nbsp;                    .filterValues { it.isHide != true }</b>
<b class="nc">&nbsp;                    .mapValues { (field, fieldData) -&gt;</b>
<b class="nc">&nbsp;                    val defaultValue =</b>
<b class="nc">&nbsp;                        if (fieldData.isDisable == true &amp;&amp; field == FormField.CARD_FULL_NAME &amp;&amp; nameKyc.isNotEmpty()) nameKyc</b>
<b class="nc">&nbsp;                        else if (field == FormField.PERSONAL_ID &amp;&amp; personalId.isNotEmpty()) personalId</b>
<b class="nc">&nbsp;                        else &quot;&quot;</b>
<b class="nc">&nbsp;                    InputFieldState(</b>
<b class="nc">&nbsp;                        value = defaultValue,</b>
<b class="nc">&nbsp;                        validator = getValidatorByField(field, fieldData)</b>
<b class="nc">&nbsp;                    )</b>
&nbsp;                }
<b class="nc">&nbsp;            dispatch(NapasInputReducer.Action.InitFormState(initialState))</b>
<b class="nc">&nbsp;            logger.i(&quot;$logName formFieldData: $formFieldData&quot;)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun getValidatorByField(
&nbsp;        field: FormField,
&nbsp;        fieldData: FieldData,
&nbsp;    ): FormValidator? {
<b class="nc">&nbsp;        return when (field) {</b>
<b class="nc">&nbsp;            FormField.CARD_NUMBER -&gt; FormValidator(</b>
<b class="nc">&nbsp;                listOf(</b>
<b class="nc">&nbsp;                    ValidateType.Required(getString(Res.string.cardErrorMessage)),</b>
<b class="nc">&nbsp;                    ValidateType.MatchRegex(</b>
<b class="nc">&nbsp;                        Regex(&quot;^9704.*&quot;),</b>
<b class="nc">&nbsp;                        getString(Res.string.cardErrorMessage2),</b>
&nbsp;                    ),
<b class="nc">&nbsp;                    ValidateType.MatchRegex(</b>
<b class="nc">&nbsp;                        fieldData.validationRegex.toRegex(),</b>
<b class="nc">&nbsp;                        fieldData.errMsg ?: &quot;&quot;,</b>
&nbsp;                    )
&nbsp;                )
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            FormField.CARD_FULL_NAME -&gt; FormValidator(</b>
<b class="nc">&nbsp;                listOf(</b>
<b class="nc">&nbsp;                    ValidateType.Required(</b>
<b class="nc">&nbsp;                        getString(Res.string.holderNameErrorMessage1)</b>
&nbsp;                    ),
<b class="nc">&nbsp;                    ValidateType.MatchRegex(</b>
<b class="nc">&nbsp;                        fieldData.validationRegex.toRegex(),</b>
<b class="nc">&nbsp;                        getString(Res.string.holderNameErrorMessage2),</b>
&nbsp;                    )
&nbsp;                )
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            FormField.PERSONAL_ID -&gt; FormValidator(</b>
<b class="nc">&nbsp;                listOf(</b>
<b class="nc">&nbsp;                    ValidateType.Required(</b>
<b class="nc">&nbsp;                        getString(Res.string.identifyErrorMessage1)</b>
&nbsp;                    ),
<b class="nc">&nbsp;                    ValidateType.Length(</b>
<b class="nc">&nbsp;                        8,</b>
<b class="nc">&nbsp;                        getString(Res.string.identifyErrorMessage2)</b>
&nbsp;                    ),
&nbsp;                )
&nbsp;            )
&nbsp;
<b class="nc">&nbsp;            FormField.CARD_ISSUE_DATE -&gt; FormValidator(listOf(ValidateType.Required(&quot;&quot;)))</b>
&nbsp;
<b class="nc">&nbsp;            FormField.CARD_EXPIRE_DATE -&gt; FormValidator(listOf(ValidateType.Required(&quot;&quot;)))</b>
&nbsp;
<b class="nc">&nbsp;            else -&gt; null</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    fun onSubmit() {
<b class="nc">&nbsp;        val cardParams = CardSubmitParams(</b>
<b class="nc">&nbsp;            amount = props.amount,</b>
<b class="nc">&nbsp;            serviceId = props.tranHisMsg?.tryGetStringNullable(&quot;serviceId&quot;),</b>
<b class="nc">&nbsp;            merchantId = props.tranHisMsg?.tryGetStringNullable(&quot;merchantId&quot;),</b>
<b class="nc">&nbsp;            partnerCode = &quot;napas_cashin_tokenization&quot;,</b>
<b class="nc">&nbsp;            extras = ModelConvertUtils.encodeToString(</b>
<b class="nc">&nbsp;                buildJsonObject {</b>
<b class="nc">&nbsp;                    val extras =</b>
<b class="nc">&nbsp;                        ModelConvertUtils.encodeToJson(props.tranHisMsg?.tryGetString(&quot;extras&quot;))</b>
<b class="nc">&nbsp;                    val paymentInfo = extras?.jsonObject?.get(&quot;paymentInfo&quot;)?.jsonPrimitive?.content</b>
<b class="nc">&nbsp;                    put(&quot;paymentTranType&quot;, props.tranHisMsg?.tryGetString(&quot;tranType&quot;))</b>
<b class="nc">&nbsp;                    put(&quot;ID&quot;, props.tranHisMsg?.tryGetString(&quot;ID&quot;))</b>
<b class="nc">&nbsp;                    put(&quot;paymentInfo&quot;, paymentInfo)</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            ),
<b class="nc">&nbsp;            cardNumber = state.value.formState[FormField.CARD_NUMBER]?.value?.replace(&quot; &quot;, &quot;&quot;),</b>
<b class="nc">&nbsp;            cardIssueDate = state.value.formState[FormField.CARD_EXPIRE_DATE]?.value ?: state.value.formState[FormField.CARD_ISSUE_DATE]?.value,</b>
<b class="nc">&nbsp;            cardFullName = state.value.formState[FormField.CARD_FULL_NAME]?.value,</b>
<b class="nc">&nbsp;            personalId = state.value.formState[FormField.PERSONAL_ID]?.value,</b>
<b class="nc">&nbsp;            isLinkCard = props.isMapNapas,</b>
<b class="nc">&nbsp;            isSaveToken = state.value.checkedCardNextTime</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        when {</b>
<b class="nc">&nbsp;            props.onPressNext is Function&lt;*&gt; -&gt; {</b>
<b class="nc">&nbsp;                props.onPressNext?.invoke(cardParams.toJsonElement().jsonObject)</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            props.expectedType == ENapasExpectedTypeCallback.FORM -&gt; {</b>
<b class="nc">&nbsp;                val dismissParams = buildJsonObject {</b>
<b class="nc">&nbsp;                    put(&quot;onSubmit&quot;, true)</b>
<b class="nc">&nbsp;                    put(</b>
<b class="nc">&nbsp;                        &quot;card&quot;,</b>
<b class="nc">&nbsp;                        ModelConvertUtils.encodeToJson(CardSubmitParams.serializer(), cardParams)</b>
<b class="nc">&nbsp;                            ?: emptyJsonObject()</b>
&nbsp;                    )
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                navigator.dismiss(dismissParams)</b>
&nbsp;            }
&nbsp;
&nbsp;            else -&gt; {
<b class="nc">&nbsp;                repository.submit(cardParams).onEach {</b>
<b class="nc">&nbsp;                    logger.i(&quot;$logName - submit response $it&quot;)</b>
<b class="nc">&nbsp;                    if (props.expectedType == ENapasExpectedTypeCallback.URL) {</b>
<b class="nc">&nbsp;                        val dismissData = buildJsonObject {</b>
<b class="nc">&nbsp;                            put(&quot;onSubmit&quot;, true)</b>
<b class="nc">&nbsp;                            put(&quot;confirmOtpUrl&quot;, it.url)</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        navigator.dismiss(dismissData)</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        val params = buildJsonObject {</b>
<b class="nc">&nbsp;                            put(&quot;webViewUrl&quot;, it.url)</b>
<b class="nc">&nbsp;                            put(&quot;orderId&quot;, it.orderId)</b>
<b class="nc">&nbsp;                            put(&quot;bankCode&quot;, props.multiBankData?.tryGetString(&quot;bankCode&quot;))</b>
<b class="nc">&nbsp;                            put(&quot;cardType&quot;, props.cardType)</b>
<b class="nc">&nbsp;                            put(&quot;moneySource&quot;, MoneySource.Napas.id)</b>
<b class="nc">&nbsp;                            put(&quot;shouldHandleOnBack&quot;, true)</b>
<b class="nc">&nbsp;                            put(&quot;shouldHandleOnDone&quot;, true)</b>
<b class="nc">&nbsp;                            put(&quot;isSaveToken&quot;, state.value.checkedCardNextTime)</b>
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                        navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;                            &quot;payment_confirm_napas&quot;,</b>
<b class="nc">&nbsp;                            params,</b>
<b class="nc">&nbsp;                            ConfirmNapasCallbackData.serializer()</b>
<b class="nc">&nbsp;                        ).onEach { responseData -&gt;</b>
<b class="nc">&nbsp;                            logger.i(&quot;$logName responseData submit - $responseData&quot;)</b>
<b class="nc">&nbsp;                            navigator.dismiss()</b>
<b class="nc">&nbsp;                            responseData?.let {</b>
<b class="nc">&nbsp;                                val error =</b>
<b class="nc">&nbsp;                                    it.transaction?.tryGetStringNullable(&quot;error&quot;)</b>
<b class="nc">&nbsp;                                val desc =</b>
<b class="nc">&nbsp;                                    it.transaction?.tryGetStringNullable(&quot;desc&quot;)</b>
<b class="nc">&nbsp;                                navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;                                    &quot;map_bank_result&quot;,</b>
<b class="nc">&nbsp;                                    buildJsonObject {</b>
<b class="nc">&nbsp;                                        val isSuccess = error == &quot;0&quot;</b>
<b class="nc">&nbsp;                                        put(</b>
<b class="nc">&nbsp;                                            &quot;headerTitle&quot;,</b>
<b class="nc">&nbsp;                                            if (isSuccess) getString(Res.string.messageBankLinkResultMapSuccess) else &quot;&quot;</b>
&nbsp;                                        )
<b class="nc">&nbsp;                                        put(&quot;errorDesc&quot;, desc)</b>
<b class="nc">&nbsp;                                        put(&quot;success&quot;, isSuccess)</b>
<b class="nc">&nbsp;                                        put(&quot;errorCode&quot;, error)</b>
<b class="nc">&nbsp;                                    })</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;
<b class="nc">&nbsp;                        }.launchIn(viewModelScope)</b>
&nbsp;                    }
<b class="nc">&nbsp;                }.catch { e -&gt;</b>
<b class="nc">&nbsp;                    handleSubmitError(e)</b>
<b class="nc">&nbsp;                }.launchIn(viewModelScope)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onBackPress() {
<b class="nc">&nbsp;        navigator.dismiss()</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun handleSubmitError(e: Throwable) {
<b class="nc">&nbsp;        logger.i(&quot;$logName handleSubmit error $e&quot;)</b>
<b class="nc">&nbsp;        val errorPopupParams = when (e) {</b>
<b class="nc">&nbsp;            is NapasInputResponseError.CustomPopupError -&gt; NavigatorErrorPopup(</b>
<b class="nc">&nbsp;                errorMessage = e.message,</b>
<b class="nc">&nbsp;                errorCode = e.code.toString(),</b>
<b class="nc">&nbsp;                bodyContent = e.message,</b>
&nbsp;            )
&nbsp;
&nbsp;            else -&gt; {
<b class="nc">&nbsp;                NavigatorErrorPopup(</b>
<b class="nc">&nbsp;                    errorCode = DevError.NoResponse.code.toString(),</b>
<b class="nc">&nbsp;                    errorMessage = e.message,</b>
<b class="nc">&nbsp;                    bodyContent = e.message,</b>
&nbsp;                )
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        navigator.showErrorPopup(</b>
<b class="nc">&nbsp;            errorPopupParams.copy(</b>
<b class="nc">&nbsp;                title = getString(Res.string.errorDefaultTitle),</b>
<b class="nc">&nbsp;                cancelable = true,</b>
<b class="nc">&nbsp;                showCloseIcon = true,</b>
<b class="nc">&nbsp;                isShowErrorInfo = true,</b>
&nbsp;            )
<b class="nc">&nbsp;        ).launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun getCustomRegexByCardType(cardType: String): String? {
<b class="nc">&nbsp;        val customNapasRegex: Map&lt;NapasType, String&gt; = mapOf(</b>
<b class="nc">&nbsp;            NapasType.GPB to &quot;^970408\\d{10}$&quot;,</b>
<b class="nc">&nbsp;            NapasType.LPB to &quot;^970449(\\d{10}|\\d{13})$&quot;,</b>
<b class="nc">&nbsp;            NapasType.NCB to &quot;^970419\\d{10}$&quot;,</b>
<b class="nc">&nbsp;            NapasType.PBVN to &quot;^970439(\\d{10}|\\d{13})$&quot;,</b>
<b class="nc">&nbsp;            NapasType.PGB to &quot;^970430\\d{10}$&quot;,</b>
<b class="nc">&nbsp;            NapasType.UOB to &quot;^970458\\d{10}$&quot;,</b>
<b class="nc">&nbsp;            NapasType.VAB to &quot;^970427\\d{10}$&quot;,</b>
<b class="nc">&nbsp;            NapasType.WOO to &quot;^970457\\d{10}$&quot;</b>
&nbsp;        )
<b class="nc">&nbsp;        val napasType = enumValues&lt;NapasType&gt;().find { it.name == cardType }</b>
<b class="nc">&nbsp;        return napasType?.let { customNapasRegex[it] }</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun getCustomErrorMessageByCardType(cardType: String): String? {
<b class="nc">&nbsp;        val customNapasErrorMessage: Map&lt;NapasType, String&gt; = mapOf(</b>
<b class="nc">&nbsp;            NapasType.GPB to getString(Res.string.customRegexMsg).replace(&quot;{number}&quot;, &quot;9704 08&quot;),</b>
<b class="nc">&nbsp;            NapasType.LPB to getString(Res.string.customRegexMsg2).replace(&quot;{number}&quot;, &quot;9704 49&quot;),</b>
<b class="nc">&nbsp;            NapasType.NCB to getString(Res.string.customRegexMsg).replace(&quot;{number}&quot;, &quot;9704 19&quot;),</b>
<b class="nc">&nbsp;            NapasType.PBVN to getString(Res.string.customRegexMsg2).replace(&quot;{number}&quot;, &quot;9704 39&quot;),</b>
<b class="nc">&nbsp;            NapasType.PGB to getString(Res.string.customRegexMsg).replace(&quot;{number}&quot;, &quot;9704 30&quot;),</b>
<b class="nc">&nbsp;            NapasType.UOB to getString(Res.string.customRegexMsg).replace(&quot;{number}&quot;, &quot;9704 58&quot;),</b>
<b class="nc">&nbsp;            NapasType.VAB to getString(Res.string.customRegexMsg).replace(&quot;{number}&quot;, &quot;9704 27&quot;),</b>
<b class="nc">&nbsp;            NapasType.WOO to getString(Res.string.customRegexMsg).replace(&quot;{number}&quot;, &quot;9704 57&quot;)</b>
&nbsp;        )
<b class="nc">&nbsp;        val napasType = enumValues&lt;NapasType&gt;().find { it.name == cardType }</b>
<b class="nc">&nbsp;        return napasType?.let { customNapasErrorMessage[it] }</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onChangeForm(formName: FormField, value: String) {
<b class="nc">&nbsp;        logger.i(&quot;$logName onChangeForm: $formName - $value&quot;)</b>
<b class="nc">&nbsp;        dispatch(NapasInputReducer.Action.ChangeFormValue(formName, value))</b>
&nbsp;    }
&nbsp;
&nbsp;    fun showInstruction(field: FormField) {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            val title = when (field) {</b>
<b class="nc">&nbsp;                FormField.CARD_NUMBER -&gt; getString(Res.string.titleCardNumber)</b>
<b class="nc">&nbsp;                FormField.CARD_FULL_NAME -&gt; getString(Res.string.holderNameTitle)</b>
<b class="nc">&nbsp;                FormField.CARD_ISSUE_DATE -&gt; getString(Res.string.cardIssueDateTitle)</b>
<b class="nc">&nbsp;                FormField.CARD_EXPIRE_DATE -&gt; getString(Res.string.cardExpireDateTitle)</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            }
<b class="nc">&nbsp;            val description = when (field) {</b>
<b class="nc">&nbsp;                FormField.CARD_NUMBER -&gt; getString(Res.string.cardDesc)</b>
<b class="nc">&nbsp;                FormField.CARD_FULL_NAME -&gt; getString(Res.string.holderNameDesc)</b>
<b class="nc">&nbsp;                FormField.CARD_ISSUE_DATE -&gt; getString(Res.string.cardIssueDateDesc)</b>
<b class="nc">&nbsp;                FormField.CARD_EXPIRE_DATE -&gt; getString(Res.string.cardExpireDateDesc)</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            }
<b class="nc">&nbsp;            if (title != null &amp;&amp; description != null) {</b>
<b class="nc">&nbsp;                navigator.showBottomSheet(</b>
<b class="nc">&nbsp;                    buildJsonObject {</b>
<b class="nc">&nbsp;                        put(&quot;type&quot;, &quot;napas_input_instruction&quot;)</b>
<b class="nc">&nbsp;                        put(&quot;title&quot;, title)</b>
<b class="nc">&nbsp;                        put(&quot;image&quot;, formFieldData[field]?.popupImage)</b>
<b class="nc">&nbsp;                        put(&quot;description&quot;, description)</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                ).launchIn(viewModelScope)</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun showDateSelection(field: FormField) {
<b class="nc">&nbsp;        navigator.showBottomSheet(</b>
<b class="nc">&nbsp;            buildJsonObject {</b>
<b class="nc">&nbsp;                put(&quot;type&quot;, &quot;napas_date_picker&quot;)</b>
<b class="nc">&nbsp;                put(&quot;field&quot;, field.name)</b>
<b class="nc">&nbsp;                put(&quot;defaultValue&quot;, state.value.formState[field]?.value)</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        ).onEach { data -&gt;</b>
<b class="nc">&nbsp;            val date = data[&quot;date&quot;]?.jsonPrimitive?.content</b>
<b class="nc">&nbsp;            date?.let {</b>
<b class="nc">&nbsp;                onChangeForm(field, date)</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onBlurForm(field: FormField) {
<b class="nc">&nbsp;        logger.i(&quot;$logName onBlur $field&quot;)</b>
<b class="nc">&nbsp;        dispatch(NapasInputReducer.Action.ValidateField(field))</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onToggleSaveCardNextTime(value: Boolean) {
<b class="nc">&nbsp;        dispatch(NapasInputReducer.Action.ToggleSaveCardNextTime(value))</b>
&nbsp;    }
&nbsp;
&nbsp;    fun checkEnableConfirm(): Boolean {
<b class="nc">&nbsp;        return state.value.formState.values.all { it.isValid() }</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-06-18 18:24</div>
</div>
</body>
</html>
