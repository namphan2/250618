


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > ChoosePromotionVM</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.promotion.presentation.viewModel</a>
</div>

<h1>Coverage Summary for Class: ChoosePromotionVM (vn.momo.compose.payment.promotion.presentation.viewModel)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ChoosePromotionVM</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/184)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/256)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1590)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ChoosePromotionVM$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$1$invokeSuspend$$inlined$flatMapLatest$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$1$invokeSuspend$lambda$6$$inlined$combine$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$1$invokeSuspend$lambda$6$$inlined$combine$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$1$invokeSuspend$lambda$6$$inlined$combine$1$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$checkAutoPickedVouchers$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$checkAutoPickedVouchers$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/43)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$displayVouchersState$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$displayVouchersState$1$invokeSuspend$$inlined$sortedByDescending$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$footerButtonProps$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/127)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/102)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1$1$2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/100)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1$1$2$2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1$1$2$2$emit$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1$1$2$emit$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$observeRecommendVoucherQueryState$1$1$emit$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$onCreate$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$onCreate$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/50)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$onToggleVoucherSelect$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/66)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$onVoucherClick$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$special$$inlined$inject$default$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$special$$inlined$inject$default$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$special$$inlined$inject$default$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionVM$VoucherState</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/238)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/375)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2290)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.promotion.presentation.viewModel
&nbsp;
&nbsp;import kotlinx.coroutines.ExperimentalCoroutinesApi
&nbsp;import kotlinx.coroutines.delay
&nbsp;import kotlinx.coroutines.flow.MutableStateFlow
&nbsp;import kotlinx.coroutines.flow.SharingStarted
&nbsp;import kotlinx.coroutines.flow.StateFlow
&nbsp;import kotlinx.coroutines.flow.combine
&nbsp;import kotlinx.coroutines.flow.flatMapLatest
&nbsp;import kotlinx.coroutines.flow.launchIn
&nbsp;import kotlinx.coroutines.flow.onEach
&nbsp;import kotlinx.coroutines.flow.stateIn
&nbsp;import kotlinx.coroutines.flow.take
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.json.jsonObject
&nbsp;import kotlinx.serialization.serializer
&nbsp;import org.koin.core.parameter.parametersOf
&nbsp;import org.koin.core.scope.Scope
&nbsp;import vn.momo.compose.payment.base.core.composeApi.ILogger
&nbsp;import vn.momo.compose.payment.base.core.composeApi.INavigator
&nbsp;import vn.momo.compose.payment.base.domain.entities.ChoosePromotionCallbackData
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.ViewModel
&nbsp;import vn.momo.compose.payment.promotion.core.model.PromotionSourceScreen
&nbsp;import vn.momo.compose.payment.promotion.core.model.toTrackingParams
&nbsp;import vn.momo.compose.payment.promotion.core.utils.InfiniteQuery
&nbsp;import vn.momo.compose.payment.promotion.core.utils.InfiniteQueryState
&nbsp;import vn.momo.compose.payment.promotion.core.utils.createInfiniteQuery
&nbsp;import vn.momo.compose.payment.promotion.data.constants.MatrixGroupAvailability
&nbsp;import vn.momo.compose.payment.promotion.data.constants.StackingVoucherGroups
&nbsp;import vn.momo.compose.payment.promotion.data.constants.TrackingConst
&nbsp;import vn.momo.compose.payment.promotion.data.constants.VoucherPathType
&nbsp;import vn.momo.compose.payment.promotion.data.dto.CheckPromoCodeParams
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toPromoCodeRequestDTO
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toPromoCodeSBRequestDTO
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toVoucherBase
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toVoucherDTO
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.ChoosePromotionSource
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.IVoucherBase
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.IVoucherCoin
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherBase
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherDetailCallbackData
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherDetailParams
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherGroup
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherLocalType
&nbsp;import vn.momo.compose.payment.promotion.domain.repositories.IVoucherDetailRepository
&nbsp;import vn.momo.compose.payment.promotion.domain.repositories.IVoucherRepository
&nbsp;import vn.momo.compose.payment.promotion.presentation.model.ChoosePromotionScreenProps
&nbsp;import vn.momo.compose.payment.promotion.presentation.model.FooterButtonProps
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.ValidationUtils
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.distinctById
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.flattenToGroups
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.getFooterButtonPropsUtil
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.delegate.IPromotionVMTracking
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.reducers.ChoosePromotionReducer
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.CollectVoucherSlice
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.PromoCodeSlice
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.VoucherCoinSlice
&nbsp;import vn.momo.compose.utils.TimeUtils
&nbsp;import vn.momo.compose.utils.datamapping.ModelConvertUtils
&nbsp;import vn.momo.compose.utils.emptyJsonObject
&nbsp;
&nbsp;@OptIn(ExperimentalCoroutinesApi::class)
&nbsp;class ChoosePromotionVM(
<b class="nc">&nbsp;    private val koinScope: Scope,</b>
<b class="nc">&nbsp;    private val navigator: INavigator,</b>
<b class="nc">&nbsp;    private val logger: ILogger,</b>
<b class="nc">&nbsp;    private val voucherRepository: IVoucherRepository,</b>
<b class="nc">&nbsp;    private val voucherDetailRepository: IVoucherDetailRepository,</b>
<b class="nc">&nbsp;    private val screenProps: Map&lt;String, Any?&gt;? = null,</b>
<b class="nc">&nbsp;    private val promotionTracer: IPromotionVMTracking,</b>
<b class="nc">&nbsp;) : ViewModel&lt;ChoosePromotionReducer.State, ChoosePromotionReducer.Action, ChoosePromotionReducer.Effect&gt;(</b>
<b class="nc">&nbsp;    ChoosePromotionReducer.State(),</b>
<b class="nc">&nbsp;    ChoosePromotionReducer()</b>
&nbsp;), IPromotionVMTracking by promotionTracer {
<b class="nc">&nbsp;    val params = ChoosePromotionScreenProps.fromMap(screenProps) ?: ChoosePromotionScreenProps()</b>
<b class="nc">&nbsp;    private val isMultiBillFlow = params.isSingleBillFlow != true</b>
<b class="nc">&nbsp;    private val sourceScreen = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;        PromotionSourceScreen.MULTI_BILL</b>
&nbsp;    } else {
<b class="nc">&nbsp;        PromotionSourceScreen.SINGLE_BILL</b>
&nbsp;    }
&nbsp;    private var initialMountTime: Long = 0L
&nbsp;    private var hasTrackedScreenInteracted: Boolean = false
&nbsp;
&nbsp;    private val _defaultSelectedVouchers =
<b class="nc">&nbsp;        MutableStateFlow(params.selectedVouchers?.map { it.toVoucherBase() } ?: emptyList())</b>
<b class="nc">&nbsp;    private val defaultSelectedVouchers: StateFlow&lt;List&lt;IVoucherBase&gt;&gt; = _defaultSelectedVouchers</b>
&nbsp;    private fun updateDefaultSelectedVouchers(vouchers: List&lt;IVoucherBase&gt;) {
<b class="nc">&nbsp;        _defaultSelectedVouchers.value = vouchers</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    val promoCodeSlice by koinScope.inject&lt;PromoCodeSlice&gt; { parametersOf(viewModelScope) }</b>
<b class="nc">&nbsp;    val voucherCoinSlice by koinScope.inject&lt;VoucherCoinSlice&gt; {</b>
<b class="nc">&nbsp;        parametersOf(</b>
<b class="nc">&nbsp;            viewModelScope,</b>
<b class="nc">&nbsp;            params</b>
&nbsp;        )
&nbsp;    }
<b class="nc">&nbsp;    val collectVoucherSlice by koinScope.inject&lt;CollectVoucherSlice&gt; { parametersOf(viewModelScope) }</b>
&nbsp;
&nbsp;    private var recommendVoucherQuery: InfiniteQuery&lt;IVoucherBase&gt;? = null
&nbsp;    private var validCollectVoucherQuery: InfiniteQuery&lt;IVoucherBase&gt;? = null
&nbsp;    private var invalidCollectVoucherQuery: InfiniteQuery&lt;IVoucherBase&gt;? = null
&nbsp;    private var invalidVoucherQuery: InfiniteQuery&lt;IVoucherBase&gt;? = null
&nbsp;
&nbsp;    private var activeVoucherQuery: InfiniteQuery&lt;IVoucherBase&gt;? = null
&nbsp;    private val queryStatesFlow =
<b class="nc">&nbsp;        MutableStateFlow&lt;List&lt;StateFlow&lt;InfiniteQueryState&lt;IVoucherBase&gt;&gt;&gt;&gt;(emptyList())</b>
&nbsp;
&nbsp;    fun onCreate() {
<b class="nc">&nbsp;        logger.i(&quot;[ChoosePromotion] onCreate ${params.toDebugString()}&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        initialMountTime = TimeUtils.getCurrentTimeMillis()</b>
<b class="nc">&nbsp;        trackVoucherScreenDisplayed(sourceScreen)</b>
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            delay(TrackingConst.SCREEN_VIEWED_LENGTH)</b>
<b class="nc">&nbsp;            trackVoucherScreenViewed(sourceScreen)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (defaultSelectedVouchers.value.isNotEmpty()) {</b>
<b class="nc">&nbsp;            logger.i(&quot;[ChoosePromotion] defaultSelectedVouchers: ${defaultSelectedVouchers.value.size} invalids: ${this.params.selectedVouchers?.filter { it.isInValid == true }?.size}&quot;)</b>
<b class="nc">&nbsp;            dispatch(ChoosePromotionReducer.Action.SetSelectedVouchers(defaultSelectedVouchers.value))</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;            checkAutoPickedVouchers()</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            val recommendPathType = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;                VoucherPathType.MultiBillRecommend</b>
&nbsp;            } else {
<b class="nc">&nbsp;                VoucherPathType.SingleBillRecommend</b>
&nbsp;            }
<b class="nc">&nbsp;            recommendVoucherQuery = createInfiniteQuery(</b>
<b class="nc">&nbsp;                queryKey = recommendPathType.toString(),</b>
&nbsp;                queryFn = { page -&gt;
<b class="nc">&nbsp;                    voucherRepository.getVoucherList(</b>
<b class="nc">&nbsp;                        recommendPathType,</b>
<b class="nc">&nbsp;                        page,</b>
<b class="nc">&nbsp;                        params</b>
&nbsp;                    )
&nbsp;                },
&nbsp;            )
<b class="nc">&nbsp;            activeVoucherQuery = recommendVoucherQuery</b>
<b class="nc">&nbsp;            updateQueryStates()</b>
&nbsp;
<b class="nc">&nbsp;            observeRecommendVoucherQueryState()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    data class VoucherState(</b>
<b class="nc">&nbsp;        val vouchers: List&lt;IVoucherBase&gt;,</b>
<b class="nc">&nbsp;        val isFetching: Boolean,</b>
<b class="nc">&nbsp;        val isRefetching: Boolean,</b>
<b class="nc">&nbsp;        val hasNextPage: Boolean,</b>
&nbsp;    )
&nbsp;
<b class="nc">&nbsp;    init {</b>
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            queryStatesFlow</b>
<b class="nc">&nbsp;                .flatMapLatest { queryStates -&gt;</b>
&nbsp;                    logger.i(&quot;[ChoosePromotionVM] queryStates: ${queryStates.size}&quot;)
&nbsp;                    combine(queryStates) { results -&gt;
&nbsp;                        val vouchers = results
&nbsp;                            .flatMap { it.pages }
&nbsp;                            .flatMap { it.records }
&nbsp;                            .distinctById()
&nbsp;                        val isFetching = results.any { it.isFetching }
&nbsp;                        val isRefetching = results.any { it.isRefetching }
&nbsp;                        val hasNextPage = results.any { it.hasNextPage() }
&nbsp;                        logger.i(&quot;[ChoosePromotionVM] vouchers: ${vouchers.size} isFetching: $isFetching isRefetching: $isRefetching hasNextPage: $hasNextPage&quot;)
&nbsp;
&nbsp;                        VoucherState(
&nbsp;                            vouchers = vouchers,
&nbsp;                            isFetching = isFetching,
&nbsp;                            isRefetching = isRefetching,
&nbsp;                            hasNextPage = hasNextPage
&nbsp;                        )
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                .collect { results -&gt;</b>
<b class="nc">&nbsp;                    logger.i(&quot;[ChoosePromotionVM] voucher state: $results&quot;)</b>
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                            vouchers = results.vouchers,</b>
<b class="nc">&nbsp;                            isFetching = results.isFetching,</b>
<b class="nc">&nbsp;                            isRefetching = results.isRefetching,</b>
<b class="nc">&nbsp;                            hasNextPage = results.hasNextPage,</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private fun checkAutoPickedVouchers() {
&nbsp;        /**
&nbsp;         * Auto picked vouchers are passed in from voucherInfo
&nbsp;         * but have not cached in selectedVouchers yet
&nbsp;         */
<b class="nc">&nbsp;        if (defaultSelectedVouchers.value.isEmpty()) {</b>
<b class="nc">&nbsp;            val autoPickedVoucherIds = params.billData?.giftId</b>
<b class="nc">&nbsp;                ?.split(&quot;,&quot;)</b>
<b class="nc">&nbsp;                ?.filter { it.isNotBlank() }</b>
&nbsp;
<b class="nc">&nbsp;            logger.i(&quot;[ChoosePromotionVM] autoPickedVoucherIds: $autoPickedVoucherIds&quot;)</b>
&nbsp;
<b class="nc">&nbsp;            if (!autoPickedVoucherIds.isNullOrEmpty()) {</b>
<b class="nc">&nbsp;                viewModelScope.launch {</b>
<b class="nc">&nbsp;                    voucherDetailRepository</b>
<b class="nc">&nbsp;                        .getVoucherDetails(autoPickedVoucherIds)</b>
<b class="nc">&nbsp;                        .take(1)</b>
<b class="nc">&nbsp;                        .onEach {</b>
<b class="nc">&nbsp;                            val autoPickedVouchers = it?.filter { voucher -&gt;</b>
<b class="nc">&nbsp;                                voucher.ID in autoPickedVoucherIds</b>
<b class="nc">&nbsp;                            } ?: emptyList()</b>
&nbsp;
<b class="nc">&nbsp;                            logger.i(&quot;[ChoosePromotionVM] fetched ${autoPickedVouchers.size} auto picked vouchers&quot;)</b>
&nbsp;
<b class="nc">&nbsp;                            if (autoPickedVouchers.isNotEmpty()) {</b>
<b class="nc">&nbsp;                                updateDefaultSelectedVouchers(autoPickedVouchers)</b>
<b class="nc">&nbsp;                                dispatch(</b>
<b class="nc">&nbsp;                                    ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                                        autoPickedVouchers</b>
&nbsp;                                    )
&nbsp;                                )
&nbsp;                            }
<b class="nc">&nbsp;                        }.launchIn(this)</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private fun updateQueryStates() {
<b class="nc">&nbsp;        queryStatesFlow.value = listOfNotNull(</b>
<b class="nc">&nbsp;            recommendVoucherQuery?.state,</b>
<b class="nc">&nbsp;            validCollectVoucherQuery?.state,</b>
<b class="nc">&nbsp;            invalidCollectVoucherQuery?.state,</b>
<b class="nc">&nbsp;            invalidVoucherQuery?.state,</b>
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun observeRecommendVoucherQueryState() {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            recommendVoucherQuery?.state?.collect { recommendVoucherState -&gt;</b>
<b class="nc">&nbsp;                logger.i(&quot;[ChoosePromotionVM] recommendVoucherQuery pages: ${recommendVoucherState.pages.size}&quot;)</b>
<b class="nc">&nbsp;                if (!hasTrackedScreenInteracted &amp;&amp; recommendVoucherState.isFetched) {</b>
<b class="nc">&nbsp;                    hasTrackedScreenInteracted = true</b>
<b class="nc">&nbsp;                    val duration = TimeUtils.getCurrentTimeMillis() - initialMountTime</b>
<b class="nc">&nbsp;                    trackVoucherScreenInteracted(sourceScreen, duration)</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                if (recommendVoucherState.isFetched &amp;&amp; !recommendVoucherState.hasNextPage()) {</b>
<b class="nc">&nbsp;                    logger.i(&quot;[ChoosePromotionVM] recommendVoucherQuery is fully fetched&quot;)</b>
<b class="nc">&nbsp;                    val giftMaskPathType = if (params.isSingleBillFlow != true) {</b>
<b class="nc">&nbsp;                        VoucherPathType.MultiBillGiftMask</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        VoucherPathType.SingleBillGiftMask</b>
&nbsp;                    }
<b class="nc">&nbsp;                    validCollectVoucherQuery = createInfiniteQuery(</b>
<b class="nc">&nbsp;                        queryKey = giftMaskPathType.toString(),</b>
&nbsp;                        queryFn = { page -&gt;
<b class="nc">&nbsp;                            voucherRepository.getVoucherList(</b>
<b class="nc">&nbsp;                                giftMaskPathType,</b>
<b class="nc">&nbsp;                                page,</b>
<b class="nc">&nbsp;                                params,</b>
&nbsp;                            )
&nbsp;                        },
&nbsp;                    )
<b class="nc">&nbsp;                    activeVoucherQuery = validCollectVoucherQuery</b>
<b class="nc">&nbsp;                    updateQueryStates()</b>
&nbsp;
<b class="nc">&nbsp;                    validCollectVoucherQuery?.state?.collect { validCollectVoucherState -&gt;</b>
<b class="nc">&nbsp;                        logger.i(&quot;[ChoosePromotionVM] validCollectVoucherQuery pages: ${validCollectVoucherState.pages.size}&quot;)</b>
<b class="nc">&nbsp;                        if (validCollectVoucherState.isFetched &amp;&amp; !validCollectVoucherState.hasNextPage()) {</b>
<b class="nc">&nbsp;                            logger.i(&quot;[ChoosePromotionVM] validCollectVoucherQuery is fully fetched&quot;)</b>
<b class="nc">&nbsp;                            val invalidGiftMaskPathType = if (params.isSingleBillFlow != true) {</b>
<b class="nc">&nbsp;                                VoucherPathType.MultiBillInvalidGiftMask</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                VoucherPathType.SingleBillInvalidGiftMask</b>
&nbsp;                            }
<b class="nc">&nbsp;                            invalidCollectVoucherQuery = createInfiniteQuery(</b>
<b class="nc">&nbsp;                                queryKey = invalidGiftMaskPathType.toString(),</b>
&nbsp;                                queryFn = { page -&gt;
<b class="nc">&nbsp;                                    voucherRepository.getVoucherList(</b>
<b class="nc">&nbsp;                                        invalidGiftMaskPathType,</b>
<b class="nc">&nbsp;                                        page,</b>
<b class="nc">&nbsp;                                        params,</b>
&nbsp;                                    )
&nbsp;                                },
&nbsp;                            )
<b class="nc">&nbsp;                            activeVoucherQuery = invalidCollectVoucherQuery</b>
<b class="nc">&nbsp;                            updateQueryStates()</b>
&nbsp;
<b class="nc">&nbsp;                            invalidCollectVoucherQuery?.state?.collect { invalidCollectVoucherState -&gt;</b>
<b class="nc">&nbsp;                                logger.i(&quot;[ChoosePromotionVM] invalidCollectVoucherQuery pages: ${invalidCollectVoucherState.pages.size}&quot;)</b>
<b class="nc">&nbsp;                                if (invalidCollectVoucherState.isFetched &amp;&amp; !invalidCollectVoucherState.hasNextPage()) {</b>
<b class="nc">&nbsp;                                    logger.i(&quot;[ChoosePromotionVM] invalidCollectVoucherQuery is fully fetched&quot;)</b>
<b class="nc">&nbsp;                                    val invalidPathType = if (params.isSingleBillFlow != true) {</b>
<b class="nc">&nbsp;                                        VoucherPathType.MultiBillInvalid</b>
&nbsp;                                    } else {
<b class="nc">&nbsp;                                        VoucherPathType.SingleBillInvalid</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                    invalidVoucherQuery = createInfiniteQuery(</b>
<b class="nc">&nbsp;                                        queryKey = invalidPathType.toString(),</b>
&nbsp;                                        queryFn = { page -&gt;
<b class="nc">&nbsp;                                            voucherRepository.getVoucherList(</b>
<b class="nc">&nbsp;                                                invalidPathType,</b>
<b class="nc">&nbsp;                                                page,</b>
<b class="nc">&nbsp;                                                params,</b>
&nbsp;                                            )
&nbsp;                                        },
&nbsp;                                    )
<b class="nc">&nbsp;                                    activeVoucherQuery = invalidVoucherQuery</b>
<b class="nc">&nbsp;                                    updateQueryStates()</b>
&nbsp;
<b class="nc">&nbsp;                                    invalidVoucherQuery?.state?.collect { invalidVoucherState -&gt;</b>
<b class="nc">&nbsp;                                        logger.i(&quot;[ChoosePromotionVM] invalidVoucherQuery pages: ${invalidVoucherState.pages.size}&quot;)</b>
<b class="nc">&nbsp;                                        if (invalidVoucherState.isFetched &amp;&amp; !invalidVoucherState.hasNextPage()) {</b>
<b class="nc">&nbsp;                                            logger.i(&quot;[ChoosePromotionVM] invalidVoucherQuery is fully fetched&quot;)</b>
&nbsp;                                        }
&nbsp;                                    }
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Combine selected vouchers and vouchers state
&nbsp;     * Put selected vouchers at the top of the list
&nbsp;     * Distinct by ID or extra.collectId
&nbsp;     */
<b class="nc">&nbsp;    val displayVouchersState = combine(</b>
<b class="nc">&nbsp;        promoCodeSlice.state,</b>
<b class="nc">&nbsp;        voucherCoinSlice.state,</b>
<b class="nc">&nbsp;        state</b>
&nbsp;    ) { promoCodeState, voucherCoinState, currentState -&gt;
<b class="nc">&nbsp;        (promoCodeState.generatedPromoVouchers</b>
<b class="nc">&nbsp;                + voucherCoinState.claimedVouchers</b>
<b class="nc">&nbsp;                + defaultSelectedVouchers.value</b>
<b class="nc">&nbsp;                + currentState.vouchers)</b>
<b class="nc">&nbsp;            .sortedByDescending { it.generatedAt }</b>
<b class="nc">&nbsp;            .distinctById()</b>
<b class="nc">&nbsp;    }.stateIn(</b>
<b class="nc">&nbsp;        viewModelScope,</b>
<b class="nc">&nbsp;        SharingStarted.WhileSubscribed(5000),</b>
<b class="nc">&nbsp;        emptyList()</b>
&nbsp;    )
&nbsp;
&nbsp;    fun onRefetch() {
<b class="nc">&nbsp;        activeVoucherQuery = recommendVoucherQuery</b>
<b class="nc">&nbsp;        activeVoucherQuery?.onRefetch?.invoke()</b>
&nbsp;
<b class="nc">&nbsp;        observeRecommendVoucherQueryState()</b>
&nbsp;
<b class="nc">&nbsp;        voucherCoinSlice.voucherCoinQuery.onRefetch.invoke()</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onFetchNextPage() {
<b class="nc">&nbsp;        activeVoucherQuery?.onFetchNextPage?.invoke()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun handleVoucherDetailCallback(
&nbsp;        voucher: IVoucherBase,
&nbsp;        index: Int,
&nbsp;        callbackData: VoucherDetailCallbackData?
&nbsp;    ) {
<b class="nc">&nbsp;        if (callbackData?.shouldClearSelectedVouchers == true) {</b>
<b class="nc">&nbsp;            dispatch(ChoosePromotionReducer.Action.SetSelectedVouchers(emptyList()))</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (callbackData?.isRemoveVoucher == true) {</b>
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                    state.value.selectedVouchers.filter { it.ID != voucher.ID }</b>
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val collectedVoucher = callbackData?.collectedVoucher?.toVoucherBase()</b>
&nbsp;
<b class="nc">&nbsp;        if (collectedVoucher != null) {</b>
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                    vouchers = state.value.vouchers.map { item -&gt;</b>
<b class="nc">&nbsp;                        if (item.extra?.collectId != null &amp;&amp; item.extra?.collectId == voucher.extra?.collectId) {</b>
<b class="nc">&nbsp;                            collectedVoucher</b>
&nbsp;                        } else {
<b class="nc">&nbsp;                            item</b>
<b class="nc">&nbsp;                        }</b>
&nbsp;                    },
<b class="nc">&nbsp;                    isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                    isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                    hasNextPage = state.value.hasNextPage,</b>
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val selectedVoucher = callbackData?.itemSelected?.toVoucherBase()</b>
&nbsp;
<b class="nc">&nbsp;        if (selectedVoucher != null &amp;&amp; checkVoucherAvailabilityByGroup(selectedVoucher)) {</b>
<b class="nc">&nbsp;            this.onToggleVoucherSelect(selectedVoucher, index)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (callbackData?.shouldClosePrevScreen == true) {</b>
<b class="nc">&nbsp;            navigator.dismiss()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onVoucherClick(voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherComponentClicked(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        val params = VoucherDetailParams(</b>
<b class="nc">&nbsp;            voucher = voucher.toVoucherDTO(</b>
<b class="nc">&nbsp;                selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;                isDisabled = !checkVoucherAvailabilityByGroup(voucher)</b>
&nbsp;            ),
<b class="nc">&nbsp;            giftId = when {</b>
<b class="nc">&nbsp;                !voucher.giftId.isNullOrBlank() -&gt; voucher.giftId</b>
<b class="nc">&nbsp;                !voucher.ID.isNullOrBlank() -&gt; voucher.ID</b>
<b class="nc">&nbsp;                !voucher.id.isNullOrBlank() -&gt; voucher.id</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            },
<b class="nc">&nbsp;            giftType = when {</b>
<b class="nc">&nbsp;                !voucher.giftType.isNullOrBlank() -&gt; voucher.giftType</b>
<b class="nc">&nbsp;                !voucher.typeId.isNullOrBlank() -&gt; voucher.typeId</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            },
<b class="nc">&nbsp;            campaignId = voucher.extra?.campaignId,</b>
<b class="nc">&nbsp;            source = ChoosePromotionSource.ttat.toString(),</b>
&nbsp;        )
<b class="nc">&nbsp;        navigator.navigateFeatureCode(</b>
&nbsp;//            &quot;choose_promotion_voucher_detail&quot;,
<b class="nc">&nbsp;            &quot;instant_voucher_detail&quot;,</b>
<b class="nc">&nbsp;            ModelConvertUtils.encodeToJson(serializer(), params)?.jsonObject ?: emptyJsonObject(),</b>
<b class="nc">&nbsp;            VoucherDetailCallbackData.serializer(),</b>
<b class="nc">&nbsp;        ).onEach {</b>
<b class="nc">&nbsp;            this.handleVoucherDetailCallback(</b>
<b class="nc">&nbsp;                voucher,</b>
<b class="nc">&nbsp;                index,</b>
<b class="nc">&nbsp;                it,</b>
&nbsp;            )
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onToggleVoucherSelect(voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        val isSelected = checkVoucherSelected(voucher)</b>
&nbsp;
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = isSelected,</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherActionTriggered(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
<b class="nc">&nbsp;            action = if (isSelected) {</b>
<b class="nc">&nbsp;                &quot;unchoose&quot;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                &quot;choose&quot;</b>
&nbsp;            }
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            if (</b>
<b class="nc">&nbsp;                !isSelected &amp;&amp;</b>
<b class="nc">&nbsp;                ValidationUtils.checkUserProfStatus(voucher, navigator, viewModelScope)</b>
&nbsp;            ) {
&nbsp;                return@launch
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                    if (isSelected) {</b>
<b class="nc">&nbsp;                        state.value.selectedVouchers.filter { it.ID != voucher.ID }</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        state.value.selectedVouchers + voucher</b>
&nbsp;                    }
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onClaimVoucherCoin(
&nbsp;        voucher: IVoucherCoin,
&nbsp;    ) {
<b class="nc">&nbsp;        voucherCoinSlice.claimVoucherCoin(</b>
<b class="nc">&nbsp;            voucher,</b>
&nbsp;            onSuccess = {
<b class="nc">&nbsp;                if (voucher.extra?.isInvalid != true &amp;&amp; checkVoucherAvailabilityByGroup(it)) {</b>
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                            listOf(it) + state.value.selectedVouchers</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;            },
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    fun onCollectVoucher(voucher: VoucherBase, index: Int) {
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherActionTriggered(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
<b class="nc">&nbsp;            action = &quot;collect&quot;</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        collectVoucherSlice.onCollect(</b>
<b class="nc">&nbsp;            voucher,</b>
&nbsp;            onSuccess = {
<b class="nc">&nbsp;                dispatch(</b>
<b class="nc">&nbsp;                    ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                        vouchers = state.value.vouchers.map { item -&gt;</b>
<b class="nc">&nbsp;                            if (item.extra?.collectId == it.extra?.collectId) {</b>
<b class="nc">&nbsp;                                it</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                item</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;                        },
<b class="nc">&nbsp;                        isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                        isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                        hasNextPage = state.value.hasNextPage,</b>
&nbsp;                    )
&nbsp;                )
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    fun onCheckPromoCode(promoCode: String) {
<b class="nc">&nbsp;        trackVoucherPromoCodeInputted(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            promoCode = promoCode,</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        val selectedGroups = state.value.selectedVouchers.flattenToGroups().map { it.toString() }</b>
<b class="nc">&nbsp;        promoCodeSlice.onCheckPromoCode(</b>
<b class="nc">&nbsp;            params = if (isMultiBillFlow) {</b>
<b class="nc">&nbsp;                CheckPromoCodeParams.RequestDTO(</b>
<b class="nc">&nbsp;                    params.toPromoCodeRequestDTO(promoCode, selectedGroups)</b>
&nbsp;                )
&nbsp;            } else {
<b class="nc">&nbsp;                CheckPromoCodeParams.SBRequestDTO(</b>
<b class="nc">&nbsp;                    params.toPromoCodeSBRequestDTO(promoCode)</b>
&nbsp;                )
&nbsp;            },
&nbsp;            onSuccess = { generatedVouchers -&gt;
<b class="nc">&nbsp;                if (generatedVouchers.size == 1 &amp;&amp; state.value.selectedVouchers.isEmpty()) {</b>
&nbsp;                    // auto select voucher when only one voucher is generated
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                            generatedVouchers.filter { it.localType == VoucherLocalType.Recommend }</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                trackVoucherPromoCodeErrorViewed(</b>
<b class="nc">&nbsp;                    sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;                    promoCode = promoCode,</b>
<b class="nc">&nbsp;                    errorType = &quot;0&quot;,</b>
<b class="nc">&nbsp;                    errorMsg = &quot;0&quot;,</b>
&nbsp;                )
&nbsp;            },
&nbsp;            onError = {
<b class="nc">&nbsp;                trackVoucherPromoCodeErrorViewed(</b>
<b class="nc">&nbsp;                    sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;                    promoCode = promoCode,</b>
<b class="nc">&nbsp;                    errorType = &quot;1&quot;,</b>
<b class="nc">&nbsp;                    errorMsg = it,</b>
&nbsp;                )
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun checkVoucherSelected(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        return state.value.selectedVouchers.any { voucher.ID == it.ID }</b>
&nbsp;    }
&nbsp;
&nbsp;    fun checkVoucherAvailabilityByGroup(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        if (params.isSingleBillFlow == true) {</b>
&nbsp;            // no stacking voucher in single bill flow
<b class="nc">&nbsp;            return state.value.selectedVouchers.isEmpty() || checkVoucherSelected(voucher)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (voucher.groups.isNullOrEmpty()) {</b>
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val selectedGroups = state.value.selectedVouchers.flattenToGroups()</b>
&nbsp;
&nbsp;        // Available when no one has been selected or this item is selected
<b class="nc">&nbsp;        if (selectedGroups.isEmpty() || checkVoucherSelected(voucher)) {</b>
<b class="nc">&nbsp;            return true</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return !voucher.groups!!.any { itemGroup -&gt;</b>
<b class="nc">&nbsp;            selectedGroups.any { selectedGroup -&gt;</b>
<b class="nc">&nbsp;                MatrixGroupAvailability[selectedGroup]?.get(itemGroup) != &quot;available&quot;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Use to display stacking promo tag in voucher item
&nbsp;     * When voucher groups have &gt;= 2 groups in StackingVoucherGroups
&nbsp;     */
&nbsp;    val shouldDisplayStackingVoucherTag: Boolean
&nbsp;        get() {
<b class="nc">&nbsp;            if (params.isSingleBillFlow == true) {</b>
&nbsp;                // no stacking voucher in single bill flow
<b class="nc">&nbsp;                return false</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            val allGroupsSet = mutableSetOf&lt;VoucherGroup&gt;()</b>
<b class="nc">&nbsp;            var stackingVoucherGroupsCount = 0</b>
&nbsp;
<b class="nc">&nbsp;            for (voucherItem in state.value.vouchers) {</b>
<b class="nc">&nbsp;                if (voucherItem.groups.isNullOrEmpty()) continue</b>
&nbsp;
<b class="nc">&nbsp;                for (group in voucherItem.groups!!.filterNotNull()) {</b>
<b class="nc">&nbsp;                    if (allGroupsSet.contains(group)) continue</b>
<b class="nc">&nbsp;                    allGroupsSet.add(group)</b>
<b class="nc">&nbsp;                    if (StackingVoucherGroups.contains(group)) {</b>
<b class="nc">&nbsp;                        stackingVoucherGroupsCount++</b>
&nbsp;                        // Early exit if condition already satisfied
<b class="nc">&nbsp;                        if (stackingVoucherGroupsCount &gt;= 2) return true</b>
&nbsp;                        // Skip the rest of the groups in the current voucher
&nbsp;                        break
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
&nbsp;    fun checkVoucherStackable(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        if (!shouldDisplayStackingVoucherTag) {</b>
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return voucher.groups?.any { itemGroup -&gt;</b>
<b class="nc">&nbsp;            StackingVoucherGroups.any { it == itemGroup }</b>
<b class="nc">&nbsp;        } ?: false</b>
&nbsp;    }
&nbsp;
&nbsp;    fun screenGoBack() {
<b class="nc">&nbsp;        navigator.dismiss()</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    val footerButtonProps: StateFlow&lt;FooterButtonProps&gt; = combine(</b>
<b class="nc">&nbsp;        state,</b>
<b class="nc">&nbsp;        defaultSelectedVouchers,</b>
&nbsp;    ) { currentState, defaultVouchers -&gt;
<b class="nc">&nbsp;        getFooterButtonPropsUtil(</b>
<b class="nc">&nbsp;            selectedVouchers = currentState.selectedVouchers,</b>
<b class="nc">&nbsp;            defaultSelectedVouchers = defaultVouchers,</b>
<b class="nc">&nbsp;            callbackToPayment = { callbackToPayment() }</b>
&nbsp;        )
<b class="nc">&nbsp;    }.stateIn(</b>
<b class="nc">&nbsp;        viewModelScope,</b>
<b class="nc">&nbsp;        SharingStarted.WhileSubscribed(5000),</b>
<b class="nc">&nbsp;        FooterButtonProps()</b>
&nbsp;    )
&nbsp;
&nbsp;    private fun callbackToPayment() {
<b class="nc">&nbsp;        val vouchersToApply = state.value.selectedVouchers.filter {</b>
<b class="nc">&nbsp;            it.localType != VoucherLocalType.Invalid</b>
&nbsp;        }
<b class="nc">&nbsp;        val callbackData = ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;            ChoosePromotionCallbackData.serializer(), ChoosePromotionCallbackData(</b>
<b class="nc">&nbsp;                onPromotionChanged = true,</b>
<b class="nc">&nbsp;                selectedVouchers = vouchersToApply</b>
<b class="nc">&nbsp;                    .map {</b>
<b class="nc">&nbsp;                        val voucher: VoucherBase = it as VoucherBase</b>
<b class="nc">&nbsp;                        ModelConvertUtils.encodeToJson(</b>
<b class="nc">&nbsp;                            serializer(),</b>
<b class="nc">&nbsp;                            voucher.toVoucherDTO()</b>
<b class="nc">&nbsp;                        )?.jsonObject</b>
<b class="nc">&nbsp;                            ?: emptyJsonObject()</b>
&nbsp;                    }
&nbsp;            )
<b class="nc">&nbsp;        )?.jsonObject</b>
&nbsp;
<b class="nc">&nbsp;        logger.i(&quot;[ChoosePromotionVM], callbackData=$callbackData&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        trackVoucherApplyButtonClicked(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = vouchersToApply.map { it.typeId }.joinToString(&quot;,&quot;),</b>
<b class="nc">&nbsp;            campaignId = vouchersToApply.map { it.campaign ?: it.extra?.campaignId }</b>
<b class="nc">&nbsp;                .joinToString(&quot;,&quot;),</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        navigator.dismiss(callbackData)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private var displayedVouchers: List&lt;IVoucherBase&gt; = emptyList()</b>
&nbsp;    fun onVoucherDisplayed(voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        if (displayedVouchers.any {</b>
<b class="nc">&nbsp;                it.ID == voucher.ID</b>
<b class="nc">&nbsp;                        || (voucher.extra?.collectId != null &amp;&amp; it.extra?.collectId == voucher.extra?.collectId)</b>
&nbsp;            }) {
&nbsp;            return
&nbsp;        }
<b class="nc">&nbsp;        displayedVouchers = displayedVouchers + voucher</b>
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherComponentDisplayed(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
&nbsp;        )
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-08 10:52</div>
</div>
</body>
</html>
