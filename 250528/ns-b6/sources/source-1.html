


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > ChoosePromotionPosVM</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.promotion.presentation.viewModel</a>
</div>

<h1>Coverage Summary for Class: ChoosePromotionPosVM (vn.momo.compose.payment.promotion.presentation.viewModel)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ChoosePromotionPosVM</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/142)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/287)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1535)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/72)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/57)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$3$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$checkAndGetLocation$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/118)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$checkAndGetLocation$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/76)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$footerButtonProps$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$getLocation$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/66)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$invalidVouchersState$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$onCreate$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$onToggleVoucherSelect$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/76)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$onUseNowVoucher$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/37)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$onVoucherClick$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$special$$inlined$inject$default$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$special$$inlined$inject$default$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$special$$inlined$inject$default$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$totalVouchersState$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ChoosePromotionPosVM$totalVouchersState$1$invokeSuspend$$inlined$sortedByDescending$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/218)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/420)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2236)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.promotion.presentation.viewModel
&nbsp;
&nbsp;import kotlinx.coroutines.delay
&nbsp;import kotlinx.coroutines.flow.MutableStateFlow
&nbsp;import kotlinx.coroutines.flow.SharingStarted
&nbsp;import kotlinx.coroutines.flow.StateFlow
&nbsp;import kotlinx.coroutines.flow.combine
&nbsp;import kotlinx.coroutines.flow.launchIn
&nbsp;import kotlinx.coroutines.flow.onEach
&nbsp;import kotlinx.coroutines.flow.stateIn
&nbsp;import kotlinx.coroutines.launch
&nbsp;import kotlinx.serialization.builtins.serializer
&nbsp;import kotlinx.serialization.json.JsonObject
&nbsp;import kotlinx.serialization.json.buildJsonObject
&nbsp;import kotlinx.serialization.json.contentOrNull
&nbsp;import kotlinx.serialization.json.jsonObject
&nbsp;import kotlinx.serialization.json.jsonPrimitive
&nbsp;import kotlinx.serialization.serializer
&nbsp;import org.koin.core.parameter.parametersOf
&nbsp;import org.koin.core.scope.Scope
&nbsp;import vn.momo.api.APIs
&nbsp;import vn.momo.api.IComposeApi
&nbsp;import vn.momo.compose.payment.base.core.composeApi.ILogger
&nbsp;import vn.momo.compose.payment.base.core.composeApi.INavigator
&nbsp;import vn.momo.compose.payment.base.core.composeApi.model.VixResponse
&nbsp;import vn.momo.compose.payment.payx.presentation.viewModel.slices.ViewModel
&nbsp;import vn.momo.compose.payment.promotion.core.model.PromotionSourceScreen
&nbsp;import vn.momo.compose.payment.promotion.core.model.toTrackingParams
&nbsp;import vn.momo.compose.payment.promotion.core.mqtt.PromotionMqtt
&nbsp;import vn.momo.compose.payment.promotion.core.utils.InfiniteQuery
&nbsp;import vn.momo.compose.payment.promotion.core.utils.InfiniteQueryState
&nbsp;import vn.momo.compose.payment.promotion.core.utils.createInfiniteQuery
&nbsp;import vn.momo.compose.payment.promotion.data.constants.MatrixGroupAvailability
&nbsp;import vn.momo.compose.payment.promotion.data.constants.PosPageSize
&nbsp;import vn.momo.compose.payment.promotion.data.constants.StackingVoucherGroups
&nbsp;import vn.momo.compose.payment.promotion.data.constants.TrackingConst
&nbsp;import vn.momo.compose.payment.promotion.data.constants.VoucherPathType
&nbsp;import vn.momo.compose.payment.promotion.data.dto.CheckPromoCodeParams
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toPromoCodeRequestDTO
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toVoucherBase
&nbsp;import vn.momo.compose.payment.promotion.data.mappers.toVoucherDTO
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.ChoosePromotionSource
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.GetLocationResponse
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.IVoucherBase
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherBase
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherDetailCallbackData
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherDetailParams
&nbsp;import vn.momo.compose.payment.promotion.domain.entities.VoucherLocalType
&nbsp;import vn.momo.compose.payment.promotion.domain.repositories.IVoucherPosRepository
&nbsp;import vn.momo.compose.payment.promotion.presentation.model.ChoosePromotionPosScreenProps
&nbsp;import vn.momo.compose.payment.promotion.presentation.model.FooterButtonProps
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.ValidationUtils
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.distinctById
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.flattenToGroups
&nbsp;import vn.momo.compose.payment.promotion.presentation.utils.getFooterButtonPropsUtil
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.delegate.IPromotionVMTracking
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.reducers.ChoosePromotionReducer
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.CollectVoucherSlice
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.PromoCodeSlice
&nbsp;import vn.momo.compose.payment.promotion.presentation.viewModel.slices.VoucherSearchSlice
&nbsp;import vn.momo.compose.utils.TimeUtils
&nbsp;import vn.momo.compose.utils.datamapping.ModelConvertUtils
&nbsp;import vn.momo.compose.utils.emptyJsonObject
&nbsp;import vn.momo.compose.utils.toJsonElement
&nbsp;import vn.momo.core.features.authentication.userprofile.UserProfile
&nbsp;import vn.momo.core.features.permissions.PermissionEnum
&nbsp;
&nbsp;class ChoosePromotionPosVM(
<b class="nc">&nbsp;    private val koinScope: Scope,</b>
<b class="nc">&nbsp;    private val navigator: INavigator,</b>
<b class="nc">&nbsp;    private val logger: ILogger,</b>
<b class="nc">&nbsp;    private val voucherPosRepository: IVoucherPosRepository,</b>
<b class="nc">&nbsp;    private val composeApi: IComposeApi,</b>
<b class="nc">&nbsp;    private val screenProps: Map&lt;String, Any?&gt;? = null,</b>
<b class="nc">&nbsp;    private val promotionTracer: IPromotionVMTracking,</b>
<b class="nc">&nbsp;) : ViewModel&lt;ChoosePromotionReducer.State, ChoosePromotionReducer.Action, ChoosePromotionReducer.Effect&gt;(</b>
<b class="nc">&nbsp;    ChoosePromotionReducer.State(),</b>
<b class="nc">&nbsp;    ChoosePromotionReducer()</b>
&nbsp;), IPromotionVMTracking by promotionTracer {
<b class="nc">&nbsp;    val params =</b>
<b class="nc">&nbsp;        ChoosePromotionPosScreenProps.fromMap(screenProps) ?: ChoosePromotionPosScreenProps()</b>
<b class="nc">&nbsp;    private val promotionMqtt = PromotionMqtt(composeApi)</b>
&nbsp;    private var initialMountTime: Long = 0L
&nbsp;    private var hasTrackedScreenInteracted: Boolean = false
&nbsp;
<b class="nc">&nbsp;    val promoCodeSlice by koinScope.inject&lt;PromoCodeSlice&gt; { parametersOf(viewModelScope) }</b>
<b class="nc">&nbsp;    val voucherSearchSlice by koinScope.inject&lt;VoucherSearchSlice&gt; {</b>
<b class="nc">&nbsp;        parametersOf(</b>
<b class="nc">&nbsp;            viewModelScope,</b>
<b class="nc">&nbsp;            params</b>
&nbsp;        )
&nbsp;    }
<b class="nc">&nbsp;    val collectVoucherSlice by koinScope.inject&lt;CollectVoucherSlice&gt; { parametersOf(viewModelScope) }</b>
&nbsp;
&nbsp;    private var defaultSelectedVouchers: List&lt;IVoucherBase&gt; =
<b class="nc">&nbsp;        params.promotion?.voucher?.map { it.toVoucherBase() } ?: emptyList()</b>
&nbsp;
&nbsp;    private var userProfile: UserProfile? = null
&nbsp;
<b class="nc">&nbsp;    init {</b>
<b class="nc">&nbsp;        promotionMqtt.onMqttEvent(</b>
<b class="nc">&nbsp;            listOf(</b>
<b class="nc">&nbsp;                &quot;MQTT_MOMO_CORE_TAG&quot;,</b>
<b class="nc">&nbsp;                &quot;MQTT_SYNC_FORCE_UPDATE_AGENT_INFO&quot;</b>
&nbsp;            ),
<b class="nc">&nbsp;            JsonObject.serializer()</b>
<b class="nc">&nbsp;        ).onEach { data -&gt;</b>
<b class="nc">&nbsp;            val syncData = data?.get(&quot;syncData&quot;)?.jsonPrimitive?.contentOrNull ?: return@onEach</b>
<b class="nc">&nbsp;            val newUserProfile = ModelConvertUtils.decode(UserProfile.serializer(), syncData)</b>
<b class="nc">&nbsp;            if (newUserProfile != null) {</b>
<b class="nc">&nbsp;                if (</b>
<b class="nc">&nbsp;                    userProfile?.identify != newUserProfile.identify ||</b>
<b class="nc">&nbsp;                    userProfile?.faceMatchingStatus != newUserProfile.faceMatchingStatus ||</b>
<b class="nc">&nbsp;                    userProfile?.payLaterCode != newUserProfile.payLaterCode</b>
&nbsp;                ) {
<b class="nc">&nbsp;                    userProfile = newUserProfile</b>
<b class="nc">&nbsp;                    onRefetch()</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private val recommendVoucherQuery: InfiniteQuery&lt;IVoucherBase&gt; =
<b class="nc">&nbsp;        viewModelScope.createInfiniteQuery(</b>
<b class="nc">&nbsp;            queryKey = VoucherPathType.PosRecommend.toString(),</b>
&nbsp;            queryFn = { page -&gt;
<b class="nc">&nbsp;                voucherPosRepository.getListVoucherPos(</b>
<b class="nc">&nbsp;                    VoucherPathType.PosRecommend,</b>
<b class="nc">&nbsp;                    page,</b>
<b class="nc">&nbsp;                    this@ChoosePromotionPosVM.params,</b>
<b class="nc">&nbsp;                    state.value.userLocation,</b>
&nbsp;                )
&nbsp;            },
<b class="nc">&nbsp;            enabled = false,</b>
&nbsp;        )
&nbsp;
&nbsp;    private val recommendVoucherQueryState: StateFlow&lt;InfiniteQueryState&lt;IVoucherBase&gt;&gt;
<b class="nc">&nbsp;        get() = recommendVoucherQuery.state</b>
&nbsp;
<b class="nc">&nbsp;    val invalidVoucherQuery: InfiniteQuery&lt;IVoucherBase&gt; =</b>
<b class="nc">&nbsp;        viewModelScope.createInfiniteQuery(</b>
<b class="nc">&nbsp;            queryKey = VoucherPathType.PosInvalid.toString(),</b>
&nbsp;            queryFn = { page -&gt;
<b class="nc">&nbsp;                voucherPosRepository.getListVoucherPos(</b>
<b class="nc">&nbsp;                    VoucherPathType.PosInvalid,</b>
<b class="nc">&nbsp;                    page,</b>
<b class="nc">&nbsp;                    this@ChoosePromotionPosVM.params,</b>
<b class="nc">&nbsp;                    state.value.userLocation,</b>
&nbsp;                )
&nbsp;            },
<b class="nc">&nbsp;            enabled = false</b>
&nbsp;        )
&nbsp;
&nbsp;    fun onCreate() {
<b class="nc">&nbsp;        logger.i(&quot;[ChoosePromotionPosVM] onCreate with ${this.params}&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        if (defaultSelectedVouchers.isNotEmpty()) {</b>
<b class="nc">&nbsp;            dispatch(ChoosePromotionReducer.Action.SetSelectedVouchers(defaultSelectedVouchers))</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        initialMountTime = TimeUtils.getCurrentTimeMillis()</b>
<b class="nc">&nbsp;        trackVoucherScreenDisplayed(PromotionSourceScreen.POS)</b>
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            delay(TrackingConst.SCREEN_VIEWED_LENGTH)</b>
<b class="nc">&nbsp;            trackVoucherScreenViewed(PromotionSourceScreen.POS)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    init {</b>
<b class="nc">&nbsp;        checkAndGetLocation()</b>
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            recommendVoucherQueryState</b>
<b class="nc">&nbsp;                .collect { state -&gt;</b>
<b class="nc">&nbsp;                    val vouchers = state.pages</b>
<b class="nc">&nbsp;                        .flatMap { it.records }</b>
<b class="nc">&nbsp;                        .distinctById()</b>
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                            vouchers = vouchers,</b>
<b class="nc">&nbsp;                            isFetching = state.isFetching ?: false,</b>
<b class="nc">&nbsp;                            isRefetching = state.isRefetching ?: false,</b>
<b class="nc">&nbsp;                            hasNextPage = state.hasNextPage() ?: false,</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;
<b class="nc">&nbsp;                    if (!hasTrackedScreenInteracted &amp;&amp; state.isFetched) {</b>
<b class="nc">&nbsp;                        hasTrackedScreenInteracted = true</b>
<b class="nc">&nbsp;                        val duration = TimeUtils.getCurrentTimeMillis() - initialMountTime</b>
<b class="nc">&nbsp;                        trackVoucherScreenInteracted(PromotionSourceScreen.POS, duration)</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    invalidVoucherQuery.enabled.value = state.isFetched</b>
&nbsp;                }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            invalidVoucherQuery.state</b>
<b class="nc">&nbsp;                .collect { state -&gt;</b>
<b class="nc">&nbsp;                    if (!hasTrackedScreenInteracted &amp;&amp; state.isFetched) {</b>
<b class="nc">&nbsp;                        hasTrackedScreenInteracted = true</b>
<b class="nc">&nbsp;                        val duration = TimeUtils.getCurrentTimeMillis() - initialMountTime</b>
<b class="nc">&nbsp;                        trackVoucherScreenInteracted(PromotionSourceScreen.POS, duration)</b>
&nbsp;                    }
&nbsp;                }
&nbsp;        }
<b class="nc">&nbsp;    }</b>
&nbsp;
&nbsp;    private fun getLocation() {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            composeApi.requestCallback(APIs.getLocation.name, listOf()) {</b>
<b class="nc">&nbsp;                val getLocationResult = ModelConvertUtils.decode(</b>
<b class="nc">&nbsp;                    VixResponse.serializer(GetLocationResponse.serializer()),</b>
<b class="nc">&nbsp;                    it</b>
<b class="nc">&nbsp;                )?.response</b>
<b class="nc">&nbsp;                logger.i(&quot;[ChoosePromotionPosVM] getLocation: $it $getLocationResult&quot;)</b>
&nbsp;
<b class="nc">&nbsp;                if (getLocationResult?.coords != null) {</b>
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetUserLocation(</b>
<b class="nc">&nbsp;                            getLocationResult.coords,</b>
<b class="nc">&nbsp;                            true</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                } else {
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetUserLocation(</b>
<b class="nc">&nbsp;                            null,</b>
<b class="nc">&nbsp;                            true</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                recommendVoucherQuery.enabled.value = true</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun checkAndGetLocation() {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            composeApi.requestCallback(</b>
<b class="nc">&nbsp;                APIs.checkPermission.name,</b>
<b class="nc">&nbsp;                listOf(PermissionEnum.LOCATION.value)</b>
&nbsp;            ) { checkPermissionVixRes -&gt;
<b class="nc">&nbsp;                logger.i(&quot;[ChoosePromotionPosVM] checkPermissionVixRes: $checkPermissionVixRes&quot;)</b>
<b class="nc">&nbsp;                val checkPermissionResult = ModelConvertUtils.decode(</b>
<b class="nc">&nbsp;                    VixResponse.serializer(String.serializer()),</b>
<b class="nc">&nbsp;                    checkPermissionVixRes</b>
<b class="nc">&nbsp;                )?.response</b>
&nbsp;
<b class="nc">&nbsp;                val checkPermission = when {</b>
<b class="nc">&nbsp;                    !checkPermissionResult.isNullOrBlank() -&gt; checkPermissionResult</b>
<b class="nc">&nbsp;                    checkPermissionResult?.isBlank() == true -&gt; &quot;denied&quot;</b>
<b class="nc">&nbsp;                    else -&gt; &quot;blocked&quot;</b>
&nbsp;                }
<b class="nc">&nbsp;                logger.i(&quot;[ChoosePromotionPosVM] checkPermissionResult: $checkPermissionResult checkPermission: $checkPermission&quot;)</b>
&nbsp;
<b class="nc">&nbsp;                when (checkPermission) {</b>
<b class="nc">&nbsp;                    &quot;granted&quot; -&gt; {</b>
<b class="nc">&nbsp;                        getLocation()</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    &quot;denied&quot; -&gt; {</b>
<b class="nc">&nbsp;                        viewModelScope.launch {</b>
<b class="nc">&nbsp;                            composeApi.requestCallback(</b>
<b class="nc">&nbsp;                                APIs.requestPermission.name,</b>
<b class="nc">&nbsp;                                listOf(</b>
<b class="nc">&nbsp;                                    mapOf(</b>
<b class="nc">&nbsp;                                        &quot;permission&quot; to PermissionEnum.LOCATION.value,</b>
<b class="nc">&nbsp;                                        &quot;showPopupPermission&quot; to true,</b>
&nbsp;                                    )
&nbsp;                                ),
&nbsp;                            ) { requestPermissionVixRes -&gt;
<b class="nc">&nbsp;                                val requestPermissionResult = ModelConvertUtils.decode(</b>
<b class="nc">&nbsp;                                    VixResponse.serializer(String.serializer()),</b>
<b class="nc">&nbsp;                                    requestPermissionVixRes</b>
<b class="nc">&nbsp;                                )?.response</b>
<b class="nc">&nbsp;                                logger.i(&quot;[ChoosePromotionPosVM] requestPermissionResult: $requestPermissionResult&quot;)</b>
&nbsp;
<b class="nc">&nbsp;                                if (requestPermissionResult == &quot;granted&quot;) {</b>
<b class="nc">&nbsp;                                    getLocation()</b>
&nbsp;                                } else {
<b class="nc">&nbsp;                                    logger.i(&quot;[ChoosePromotionPosVM] requestPermission: blocked&quot;)</b>
<b class="nc">&nbsp;                                    dispatch(</b>
<b class="nc">&nbsp;                                        ChoosePromotionReducer.Action.SetUserLocation(</b>
<b class="nc">&nbsp;                                            null,</b>
<b class="nc">&nbsp;                                            true</b>
&nbsp;                                        )
&nbsp;                                    )
<b class="nc">&nbsp;                                    recommendVoucherQuery.enabled.value = true</b>
&nbsp;                                }
&nbsp;                            }
&nbsp;                        }
&nbsp;                    }
&nbsp;
&nbsp;                    else -&gt; {
<b class="nc">&nbsp;                        logger.i(&quot;[ChoosePromotionPosVM] checkPermissionResult: blocked&quot;)</b>
<b class="nc">&nbsp;                        dispatch(</b>
<b class="nc">&nbsp;                            ChoosePromotionReducer.Action.SetUserLocation(</b>
<b class="nc">&nbsp;                                null,</b>
<b class="nc">&nbsp;                                true</b>
&nbsp;                            )
&nbsp;                        )
<b class="nc">&nbsp;                        recommendVoucherQuery.enabled.value = true</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Combine selected vouchers and vouchers state
&nbsp;     * Put selected vouchers at the top of the list
&nbsp;     * Distinct by ID or extra.collectId
&nbsp;     */
<b class="nc">&nbsp;    val totalVouchersState = combine(</b>
<b class="nc">&nbsp;        promoCodeSlice.state,</b>
<b class="nc">&nbsp;        voucherSearchSlice.state,</b>
<b class="nc">&nbsp;        recommendVoucherQueryState</b>
&nbsp;    ) { promoCodeState, searchState, queryState -&gt;
<b class="nc">&nbsp;        (searchState.selectedVouchers</b>
<b class="nc">&nbsp;                + promoCodeState.generatedPromoVouchers</b>
<b class="nc">&nbsp;                + defaultSelectedVouchers</b>
<b class="nc">&nbsp;                + queryState.pages.flatMap { it.records })</b>
<b class="nc">&nbsp;            .sortedByDescending { it.generatedAt }</b>
<b class="nc">&nbsp;            .distinctById()</b>
<b class="nc">&nbsp;    }.stateIn(</b>
<b class="nc">&nbsp;        viewModelScope,</b>
<b class="nc">&nbsp;        SharingStarted.WhileSubscribed(5000),</b>
<b class="nc">&nbsp;        emptyList()</b>
&nbsp;    )
&nbsp;
<b class="nc">&nbsp;    val invalidVouchersState = combine(</b>
<b class="nc">&nbsp;        invalidVoucherQuery.state,</b>
<b class="nc">&nbsp;        totalVouchersState</b>
&nbsp;    ) { invalidState, totalState -&gt;
<b class="nc">&nbsp;        invalidState.pages</b>
<b class="nc">&nbsp;            .flatMap { it.records }</b>
<b class="nc">&nbsp;            .filter { invalidVoucher -&gt;</b>
<b class="nc">&nbsp;                totalState.none {</b>
<b class="nc">&nbsp;                    it.ID == invalidVoucher.ID</b>
<b class="nc">&nbsp;                            || (invalidVoucher.extra?.collectId != null &amp;&amp; it.extra?.collectId == invalidVoucher.extra?.collectId)</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
<b class="nc">&nbsp;            .distinctById()</b>
<b class="nc">&nbsp;    }.stateIn(</b>
<b class="nc">&nbsp;        viewModelScope,</b>
<b class="nc">&nbsp;        SharingStarted.WhileSubscribed(5000),</b>
<b class="nc">&nbsp;        emptyList()</b>
&nbsp;    )
&nbsp;
&nbsp;    val displayVouchersSize: Int
&nbsp;        get() {
<b class="nc">&nbsp;            return PosPageSize.initialPageSize +</b>
<b class="nc">&nbsp;                    (state.value.localPage - 1) * PosPageSize.pageSize</b>
&nbsp;        }
&nbsp;
&nbsp;    fun onFetchNextPage(hasNextPage: Boolean) {
<b class="nc">&nbsp;        dispatch(</b>
<b class="nc">&nbsp;            ChoosePromotionReducer.Action.SetLocalPage(</b>
<b class="nc">&nbsp;                if (hasNextPage) {</b>
<b class="nc">&nbsp;                    state.value.localPage + 1</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    1</b>
&nbsp;                }
&nbsp;            )
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    fun onRefetch() {
<b class="nc">&nbsp;        recommendVoucherQuery.onRefetch.invoke()</b>
<b class="nc">&nbsp;        dispatch(ChoosePromotionReducer.Action.SetLocalPage(1))</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun handleVoucherDetailCallback(
&nbsp;        voucher: IVoucherBase,
&nbsp;        callbackData: VoucherDetailCallbackData?,
&nbsp;        index: Int,
&nbsp;        sourceScreen: PromotionSourceScreen,
&nbsp;    ) {
<b class="nc">&nbsp;        logger.i(&quot;handleVoucherDetailCallback $callbackData&quot;)</b>
<b class="nc">&nbsp;        if (callbackData?.isRemoveVoucher == true) {</b>
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                    state.value.selectedVouchers.filter { it.ID != voucher.ID }</b>
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val collectedVoucher = callbackData?.collectedVoucher?.toVoucherBase()</b>
&nbsp;
<b class="nc">&nbsp;        if (collectedVoucher != null) {</b>
<b class="nc">&nbsp;            if (callbackData.shouldClearSelectedVouchers == true) {</b>
<b class="nc">&nbsp;                dispatch(</b>
<b class="nc">&nbsp;                    ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                        vouchers = (listOf(collectedVoucher) + state.value.vouchers).distinctById(),</b>
<b class="nc">&nbsp;                        isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                        isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                        hasNextPage = state.value.hasNextPage,</b>
&nbsp;                    )
&nbsp;                )
&nbsp;            } else {
<b class="nc">&nbsp;                dispatch(</b>
<b class="nc">&nbsp;                    ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                        vouchers = state.value.vouchers.map { item -&gt;</b>
<b class="nc">&nbsp;                            if (item.extra?.collectId != null &amp;&amp; item.extra?.collectId == voucher.extra?.collectId) {</b>
<b class="nc">&nbsp;                                collectedVoucher</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                item</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;                        },
<b class="nc">&nbsp;                        isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                        isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                        hasNextPage = state.value.hasNextPage,</b>
&nbsp;                    )
&nbsp;                )
&nbsp;            }
&nbsp;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val selectedVoucher = callbackData?.itemSelected?.toVoucherBase()</b>
&nbsp;
<b class="nc">&nbsp;        if (selectedVoucher != null) {</b>
<b class="nc">&nbsp;            if (callbackData.shouldClearSelectedVouchers == true) {</b>
<b class="nc">&nbsp;                this.onToggleVoucherSelect(</b>
<b class="nc">&nbsp;                    voucher = selectedVoucher,</b>
<b class="nc">&nbsp;                    sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;                    index = index,</b>
<b class="nc">&nbsp;                    shouldOverride = true,</b>
&nbsp;                )
<b class="nc">&nbsp;                voucherSearchSlice.onSelectVoucher(voucher)</b>
<b class="nc">&nbsp;            } else if (checkVoucherAvailabilityByGroup(selectedVoucher)) {</b>
<b class="nc">&nbsp;                this.onToggleVoucherSelect(</b>
<b class="nc">&nbsp;                    voucher = selectedVoucher,</b>
<b class="nc">&nbsp;                    sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;                    index = index,</b>
&nbsp;                )
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (callbackData?.shouldClosePrevScreen == true) {</b>
<b class="nc">&nbsp;            voucherSearchSlice.hideSearchModal()</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onVoucherClick(
&nbsp;        voucher: IVoucherBase,
&nbsp;        sourceScreen: PromotionSourceScreen,
&nbsp;        index: Int,
&nbsp;    ) {
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherComponentClicked(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        val params = VoucherDetailParams(</b>
<b class="nc">&nbsp;            voucher = voucher.toVoucherDTO(</b>
<b class="nc">&nbsp;                selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;                isDisabled = !checkVoucherAvailabilityByGroup(voucher)</b>
&nbsp;            ),
<b class="nc">&nbsp;            giftId = when {</b>
<b class="nc">&nbsp;                !voucher.giftId.isNullOrBlank() -&gt; voucher.giftId</b>
<b class="nc">&nbsp;                !voucher.ID.isNullOrBlank() -&gt; voucher.ID</b>
<b class="nc">&nbsp;                !voucher.id.isNullOrBlank() -&gt; voucher.id</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            },
<b class="nc">&nbsp;            giftType = when {</b>
<b class="nc">&nbsp;                !voucher.giftType.isNullOrBlank() -&gt; voucher.giftType</b>
<b class="nc">&nbsp;                !voucher.typeId.isNullOrBlank() -&gt; voucher.typeId</b>
<b class="nc">&nbsp;                else -&gt; null</b>
&nbsp;            },
<b class="nc">&nbsp;            campaignId = voucher.extra?.campaignId,</b>
<b class="nc">&nbsp;            source = if (sourceScreen == PromotionSourceScreen.POS_SEARCH) {</b>
<b class="nc">&nbsp;                ChoosePromotionSource.search.toString()</b>
&nbsp;            } else {
<b class="nc">&nbsp;                ChoosePromotionSource.pos.toString()</b>
&nbsp;            },
<b class="nc">&nbsp;            shouldClosePrevScreen = sourceScreen == PromotionSourceScreen.POS_SEARCH,</b>
<b class="nc">&nbsp;            shouldClearSelectedVouchers = sourceScreen == PromotionSourceScreen.POS_SEARCH,</b>
<b class="nc">&nbsp;            fromSearch = sourceScreen == PromotionSourceScreen.POS_SEARCH,</b>
&nbsp;        )
<b class="nc">&nbsp;        navigator.navigateFeatureCode(</b>
<b class="nc">&nbsp;            &quot;instant_voucher_detail&quot;,</b>
<b class="nc">&nbsp;            ModelConvertUtils.encodeToJson(serializer(), params)?.jsonObject ?: emptyJsonObject(),</b>
<b class="nc">&nbsp;            VoucherDetailCallbackData.serializer(),</b>
<b class="nc">&nbsp;        ).onEach {</b>
<b class="nc">&nbsp;            this.handleVoucherDetailCallback(</b>
<b class="nc">&nbsp;                voucher = voucher,</b>
<b class="nc">&nbsp;                callbackData = it,</b>
<b class="nc">&nbsp;                index = index,</b>
<b class="nc">&nbsp;                sourceScreen = sourceScreen,</b>
&nbsp;            )
<b class="nc">&nbsp;        }.launchIn(viewModelScope)</b>
&nbsp;    }
&nbsp;
&nbsp;    fun onToggleVoucherSelect(
&nbsp;        sourceScreen: PromotionSourceScreen,
&nbsp;        voucher: IVoucherBase,
&nbsp;        index: Int,
<b class="nc">&nbsp;        shouldOverride: Boolean? = false</b>
&nbsp;    ) {
<b class="nc">&nbsp;        val isSelected = if (shouldOverride == true) {</b>
<b class="nc">&nbsp;            false</b>
&nbsp;        } else {
<b class="nc">&nbsp;            checkVoucherSelected(voucher)</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = isSelected,</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherActionTriggered(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
<b class="nc">&nbsp;            action = if (isSelected) {</b>
<b class="nc">&nbsp;                &quot;unchoose&quot;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                &quot;choose&quot;</b>
&nbsp;            }
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            if (</b>
<b class="nc">&nbsp;                !isSelected &amp;&amp;</b>
<b class="nc">&nbsp;                ValidationUtils.checkUserProfStatus(voucher, navigator, viewModelScope)</b>
&nbsp;            ) {
&nbsp;                return@launch
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            dispatch(</b>
<b class="nc">&nbsp;                ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                    if (shouldOverride == true) {</b>
<b class="nc">&nbsp;                        listOf(voucher)</b>
<b class="nc">&nbsp;                    } else if (isSelected) {</b>
<b class="nc">&nbsp;                        state.value.selectedVouchers.filter { it.ID != voucher.ID }</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        state.value.selectedVouchers + voucher</b>
&nbsp;                    }
&nbsp;                )
&nbsp;            )
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    fun onCollectVoucher(sourceScreen: PromotionSourceScreen, voucher: VoucherBase, index: Int) {
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherActionTriggered(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
<b class="nc">&nbsp;            action = &quot;collect&quot;</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        collectVoucherSlice.onCollect(</b>
<b class="nc">&nbsp;            voucher,</b>
&nbsp;            onSuccess = {
<b class="nc">&nbsp;                logger.i(&quot;[ChoosePromotionPosVM] onCollectVoucher success ${it.extra} $it&quot;)</b>
<b class="nc">&nbsp;                dispatch(</b>
<b class="nc">&nbsp;                    ChoosePromotionReducer.Action.SetVoucherState(</b>
<b class="nc">&nbsp;                        vouchers = state.value.vouchers.map { item -&gt;</b>
<b class="nc">&nbsp;                            if (it.extra?.collectId != null &amp;&amp; item.extra?.collectId == it.extra?.collectId) {</b>
<b class="nc">&nbsp;                                it</b>
&nbsp;                            } else {
<b class="nc">&nbsp;                                item</b>
<b class="nc">&nbsp;                            }</b>
&nbsp;                        },
<b class="nc">&nbsp;                        isFetching = state.value.isFetching,</b>
<b class="nc">&nbsp;                        isRefetching = state.value.isRefetching,</b>
<b class="nc">&nbsp;                        hasNextPage = state.value.hasNextPage,</b>
&nbsp;                    )
&nbsp;                )
<b class="nc">&nbsp;                voucherSearchSlice.onVoucherCollected(it)</b>
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    fun onCheckPromoCode(promoCode: String) {
<b class="nc">&nbsp;        trackVoucherPromoCodeInputted(</b>
<b class="nc">&nbsp;            sourceScreen = PromotionSourceScreen.POS,</b>
<b class="nc">&nbsp;            promoCode = promoCode,</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        val selectedGroups = state.value.selectedVouchers.flattenToGroups().map { it.toString() }</b>
&nbsp;
<b class="nc">&nbsp;        val checkPromoCodeParams = CheckPromoCodeParams.RequestDTO(</b>
<b class="nc">&nbsp;            params.toPromoCodeRequestDTO(</b>
<b class="nc">&nbsp;                promoCode,</b>
<b class="nc">&nbsp;                selectedGroups = selectedGroups,</b>
&nbsp;            )
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        promoCodeSlice.onCheckPromoCode(</b>
<b class="nc">&nbsp;            checkPromoCodeParams,</b>
&nbsp;            onSuccess = { generatedVouchers -&gt;
<b class="nc">&nbsp;                if (generatedVouchers.size == 1 &amp;&amp; state.value.selectedVouchers.isEmpty()) {</b>
&nbsp;                    // auto select voucher when only one voucher is generated
<b class="nc">&nbsp;                    dispatch(</b>
<b class="nc">&nbsp;                        ChoosePromotionReducer.Action.SetSelectedVouchers(</b>
<b class="nc">&nbsp;                            generatedVouchers.filter { it.localType == VoucherLocalType.Recommend }</b>
&nbsp;                        )
&nbsp;                    )
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                trackVoucherPromoCodeErrorViewed(</b>
<b class="nc">&nbsp;                    sourceScreen = PromotionSourceScreen.POS,</b>
<b class="nc">&nbsp;                    promoCode = promoCode,</b>
<b class="nc">&nbsp;                    errorType = &quot;0&quot;,</b>
<b class="nc">&nbsp;                    errorMsg = &quot;0&quot;,</b>
&nbsp;                )
&nbsp;            },
&nbsp;            onError = {
<b class="nc">&nbsp;                trackVoucherPromoCodeErrorViewed(</b>
<b class="nc">&nbsp;                    sourceScreen = PromotionSourceScreen.POS,</b>
<b class="nc">&nbsp;                    promoCode = promoCode,</b>
<b class="nc">&nbsp;                    errorType = &quot;1&quot;,</b>
<b class="nc">&nbsp;                    errorMsg = it,</b>
&nbsp;                )
&nbsp;            }
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun checkVoucherSelected(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        return state.value.selectedVouchers.any { voucher.ID == it.ID }</b>
&nbsp;    }
&nbsp;
&nbsp;    fun checkVoucherAvailabilityByGroup(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        if (voucher.groups.isNullOrEmpty()) {</b>
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        val selectedGroups = state.value.selectedVouchers.flattenToGroups()</b>
&nbsp;
&nbsp;        // Available when no one has been selected or this item is selected
<b class="nc">&nbsp;        if (selectedGroups.isEmpty() || checkVoucherSelected(voucher)) {</b>
<b class="nc">&nbsp;            return true</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return !voucher.groups!!.any { itemGroup -&gt;</b>
<b class="nc">&nbsp;            selectedGroups.any { selectedGroup -&gt;</b>
<b class="nc">&nbsp;                MatrixGroupAvailability[selectedGroup]?.get(itemGroup) != &quot;available&quot;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Hide stacking voucher tag to priority paymentMethod tag
&nbsp;     */
&nbsp;    val shouldDisplayStackingVoucherTag: Boolean
&nbsp;        get() {
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
&nbsp;    fun checkVoucherStackable(voucher: IVoucherBase): Boolean {
<b class="nc">&nbsp;        if (!shouldDisplayStackingVoucherTag) {</b>
<b class="nc">&nbsp;            return false</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return voucher.groups?.any { itemGroup -&gt;</b>
<b class="nc">&nbsp;            StackingVoucherGroups.any { it == itemGroup }</b>
<b class="nc">&nbsp;        } ?: false</b>
&nbsp;    }
&nbsp;
&nbsp;    fun screenGoBack() {
<b class="nc">&nbsp;        val callbackData = buildJsonObject {</b>
<b class="nc">&nbsp;            put(&quot;voucher&quot;, defaultSelectedVouchers.map {</b>
<b class="nc">&nbsp;                val voucher: VoucherBase = it as VoucherBase</b>
<b class="nc">&nbsp;                ModelConvertUtils.encodeToJson(serializer(), voucher.toVoucherDTO())?.jsonObject</b>
<b class="nc">&nbsp;                    ?: emptyJsonObject()</b>
<b class="nc">&nbsp;            }.toJsonElement())</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        logger.i(&quot;[ChoosePromotionPosVM] screenGoBack callbackData=$callbackData&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        navigator.dismiss(callbackData)</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun callbackToPayment() {
<b class="nc">&nbsp;        val vouchersToApply = state.value.selectedVouchers.filter {</b>
<b class="nc">&nbsp;            it.localType != VoucherLocalType.Invalid</b>
&nbsp;        }
<b class="nc">&nbsp;        val callbackData = buildJsonObject {</b>
<b class="nc">&nbsp;            put(&quot;voucher&quot;, vouchersToApply.map {</b>
<b class="nc">&nbsp;                val voucher: VoucherBase = it as VoucherBase</b>
<b class="nc">&nbsp;                ModelConvertUtils.encodeToJson(serializer(), voucher.toVoucherDTO())?.jsonObject</b>
<b class="nc">&nbsp;                    ?: emptyJsonObject()</b>
<b class="nc">&nbsp;            }.toJsonElement())</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        logger.i(&quot;[ChoosePromotionPosVM] callbackToPayment callbackData=$callbackData&quot;)</b>
&nbsp;
<b class="nc">&nbsp;        trackVoucherApplyButtonClicked(</b>
<b class="nc">&nbsp;            sourceScreen = PromotionSourceScreen.POS,</b>
<b class="nc">&nbsp;            giftType = vouchersToApply.map { it.typeId }.joinToString(&quot;,&quot;),</b>
<b class="nc">&nbsp;            campaignId = vouchersToApply.map { it.campaign ?: it.extra?.campaignId }</b>
<b class="nc">&nbsp;                .joinToString(&quot;,&quot;),</b>
&nbsp;        )
&nbsp;
<b class="nc">&nbsp;        navigator.dismiss(callbackData)</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    val footerButtonProps: StateFlow&lt;FooterButtonProps&gt; = combine(</b>
<b class="nc">&nbsp;        state,</b>
<b class="nc">&nbsp;        MutableStateFlow(defaultSelectedVouchers)</b>
&nbsp;    ) { currentState, defaultVouchers -&gt;
<b class="nc">&nbsp;        getFooterButtonPropsUtil(</b>
<b class="nc">&nbsp;            selectedVouchers = currentState.selectedVouchers,</b>
<b class="nc">&nbsp;            defaultSelectedVouchers = defaultVouchers,</b>
<b class="nc">&nbsp;            callbackToPayment = { callbackToPayment() }</b>
&nbsp;        )
<b class="nc">&nbsp;    }.stateIn(</b>
<b class="nc">&nbsp;        viewModelScope,</b>
<b class="nc">&nbsp;        SharingStarted.WhileSubscribed(5000),</b>
<b class="nc">&nbsp;        FooterButtonProps()</b>
&nbsp;    )
&nbsp;
&nbsp;    fun onUseNowVoucher(voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        viewModelScope.launch {</b>
<b class="nc">&nbsp;            if (</b>
<b class="nc">&nbsp;                ValidationUtils.checkUserProfStatus(voucher, navigator, viewModelScope)</b>
&nbsp;            ) {
&nbsp;                return@launch
&nbsp;            }
<b class="nc">&nbsp;            onToggleVoucherSelect(</b>
<b class="nc">&nbsp;                sourceScreen = PromotionSourceScreen.POS_SEARCH,</b>
<b class="nc">&nbsp;                voucher = voucher,</b>
<b class="nc">&nbsp;                index = index,</b>
<b class="nc">&nbsp;                shouldOverride = true</b>
&nbsp;            )
<b class="nc">&nbsp;            voucherSearchSlice.onSelectVoucher(voucher)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    private var displayedVouchers: List&lt;IVoucherBase&gt; = emptyList()</b>
&nbsp;    fun onVoucherDisplayed(sourceScreen: PromotionSourceScreen, voucher: IVoucherBase, index: Int) {
<b class="nc">&nbsp;        if (displayedVouchers.any {</b>
<b class="nc">&nbsp;                it.ID == voucher.ID</b>
<b class="nc">&nbsp;                        || (voucher.extra?.collectId != null &amp;&amp; it.extra?.collectId == voucher.extra?.collectId)</b>
&nbsp;            }) {
&nbsp;            return
&nbsp;        }
<b class="nc">&nbsp;        displayedVouchers = displayedVouchers + voucher</b>
<b class="nc">&nbsp;        val voucherTrackingParams = voucher.toTrackingParams(</b>
<b class="nc">&nbsp;            selected = checkVoucherSelected(voucher),</b>
<b class="nc">&nbsp;            index = index,</b>
&nbsp;        )
<b class="nc">&nbsp;        trackVoucherComponentDisplayed(</b>
<b class="nc">&nbsp;            sourceScreen = sourceScreen,</b>
<b class="nc">&nbsp;            giftType = voucherTrackingParams.giftType,</b>
<b class="nc">&nbsp;            campaignId = voucherTrackingParams.campaignId,</b>
<b class="nc">&nbsp;            slot = voucherTrackingParams.slot,</b>
<b class="nc">&nbsp;            status = voucherTrackingParams.status,</b>
&nbsp;        )
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-08 10:52</div>
</div>
</body>
</html>
