


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>MoMoCompose Coverage Report > SuggestedSofRepository</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope: MoMoCompose<span class="separator">|</span>    <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">vn.momo.compose.payment.payx.data.repositoryImpl</a>
</div>

<h1>Coverage Summary for Class: SuggestedSofRepository (vn.momo.compose.payment.payx.data.repositoryImpl)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">SuggestedSofRepository</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/72)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/67)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/486)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankLinkedDict$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankLinkedDict$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankLinkedDict$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankNotLinked$$inlined$flatMapLatest$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankNotLinked$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankNotLinked$lambda$20$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankNotLinked$lambda$20$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getBankNotLinked$lambda$20$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getConfigSuggestPriority$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getConfigSuggestPriority$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getConfigSuggestPriority$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getListIconSuggest$$inlined$compareBy$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getListIconSuggest$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$$inlined$mapNotNull$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$$inlined$mapNotNull$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$$inlined$mapNotNull$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/57)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$getSuggestedSof$localFlow$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$remoteFlow$lambda$2$$inlined$map$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$remoteFlow$lambda$2$$inlined$map$1$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
  </tr>
  <tr>
    <td class="name">SuggestedSofRepository$remoteFlow$lambda$2$$inlined$map$1$2$1</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/74)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/74)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/561)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package vn.momo.compose.payment.payx.data.repositoryImpl
&nbsp;
&nbsp;import kotlinx.coroutines.ExperimentalCoroutinesApi
&nbsp;import kotlinx.coroutines.flow.Flow
&nbsp;import kotlinx.coroutines.flow.firstOrNull
&nbsp;import kotlinx.coroutines.flow.flatMapLatest
&nbsp;import kotlinx.coroutines.flow.flow
&nbsp;import kotlinx.coroutines.flow.map
&nbsp;import kotlinx.coroutines.flow.mapNotNull
&nbsp;import kotlinx.coroutines.flow.merge
&nbsp;import kotlinx.coroutines.flow.transformWhile
&nbsp;import kotlinx.serialization.json.JsonObject
&nbsp;import kotlinx.serialization.json.buildJsonObject
&nbsp;import kotlinx.serialization.json.intOrNull
&nbsp;import kotlinx.serialization.json.jsonPrimitive
&nbsp;import kotlinx.serialization.json.put
&nbsp;import vn.momo.compose.payment.base.core.composeApi.INavigator
&nbsp;import vn.momo.compose.payment.base.core.composeApi.appFeatureConfig.IAppFeatureConfig
&nbsp;import vn.momo.compose.payment.base.data.dataSource.dto.response.SofDTO
&nbsp;import vn.momo.compose.payment.base.data.dataSource.memory.CachedSuggestedSof
&nbsp;import vn.momo.compose.payment.base.domain.entities.DisableType
&nbsp;import vn.momo.compose.payment.base.domain.entities.EnumMoneySource
&nbsp;import vn.momo.compose.payment.base.domain.entities.SofAction
&nbsp;import vn.momo.compose.payment.base.domain.entities.SofActionType
&nbsp;import vn.momo.compose.payment.base.domain.repository.LocalSofRepository
&nbsp;import vn.momo.compose.payment.payx.data.dataMapper.convertMoneySource
&nbsp;import vn.momo.compose.payment.payx.data.dataMapper.throwableVerifyResponse
&nbsp;import vn.momo.compose.payment.payx.data.dataMapper.toModel
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.dto.request.GetSuggestedSofMoMoMsg
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.dto.request.MBGetSuggestedSofRequest
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.dto.response.MoMoMessageDTO
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.memory.PaymentSession
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.memory.SavedPaymentData
&nbsp;import vn.momo.compose.payment.payx.data.dataSource.remote.SuggestedSofRemoteDataSource
&nbsp;import vn.momo.compose.payment.payx.domain.entities.SofCTAItem
&nbsp;import vn.momo.compose.payment.payx.domain.entities.SuggestedSof
&nbsp;import vn.momo.compose.payment.payx.domain.repositories.ISuggestedSofRepository
&nbsp;import vn.momo.compose.payment.payx.utils.constant.ServiceFeatureCode
&nbsp;import vn.momo.compose.utils.datamapping.ModelConvertUtils
&nbsp;import vn.momo.compose.utils.datamapping.toJsonObject
&nbsp;import vn.momo.compose.utils.datamapping.tryToGetObject
&nbsp;import vn.momo.compose.utils.datamapping.tryToGetString
&nbsp;
&nbsp;val defaultPriority = mapOf(
&nbsp;    &quot;12345&quot; to 1, //VIETCOMBANK
&nbsp;    &quot;102&quot; to 2, //VIETINBANK
&nbsp;    &quot;110&quot; to 3, //BIDV
&nbsp;    &quot;111&quot; to 4, //AGRIBANK
&nbsp;    &quot;2000&quot; to 5, //SACOMBANK
&nbsp;    &quot;304&quot; to 6, //TECHCOMBANK
&nbsp;    &quot;301&quot; to 7, //MBBANK
&nbsp;    &quot;106&quot; to 8, //ACB
&nbsp;    &quot;103&quot; to 9, //VPBANK
&nbsp;    &quot;105&quot; to 10, //TPBANK
&nbsp;).toJsonObject()
&nbsp;
&nbsp;data class IconSuggest(
&nbsp;    val serviceCode: String,
&nbsp;    val icon: String
&nbsp;)
&nbsp;
<b class="nc">&nbsp;class SuggestedSofRepository(</b>
<b class="nc">&nbsp;    private val remoteDataSource: SuggestedSofRemoteDataSource,</b>
<b class="nc">&nbsp;    private val savedPaymentData: SavedPaymentData,</b>
<b class="nc">&nbsp;    private val localSof: LocalSofRepository,</b>
<b class="nc">&nbsp;    private val cacheSuggestedSof: CachedSuggestedSof,</b>
<b class="nc">&nbsp;    private val paymentSessionCenter: PaymentSession,</b>
<b class="nc">&nbsp;    private val appFeatureRepository: IAppFeatureConfig,</b>
<b class="nc">&nbsp;    private val navigator: INavigator</b>
&nbsp;) : ISuggestedSofRepository {
&nbsp;
<b class="nc">&nbsp;    private val remoteFlow = {</b>
<b class="nc">&nbsp;        remoteDataSource.get(generateGetSuggestedSofMessage()).throwableVerifyResponse().map {</b>
&nbsp;            navigator.showToastDebugger(buildJsonObject {
&nbsp;                put(&quot;title&quot;, &quot;SofInfo from BE - BottomSheet&quot;)
&nbsp;                put(&quot;message&quot;, &quot;Take ${it.momoMsg?.sofInfo?.size} money source from BE&quot;)
&nbsp;                put(&quot;duration&quot;, 3000)
&nbsp;            })
&nbsp;            Pair(&quot;remote&quot;, it.momoMsg?.sofInfo)
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    override fun getSuggestedSof(): Flow&lt;SuggestedSof&gt; {
<b class="nc">&nbsp;        val serviceCode =</b>
<b class="nc">&nbsp;            cloneTransaction()?.purchaseInfo?.invoiceInfo?.firstOrNull()?.items?.firstOrNull()?.serviceId</b>
<b class="nc">&nbsp;        val localFlow: Flow&lt;Pair&lt;String, List&lt;SofDTO?&gt;?&gt;&gt; =</b>
<b class="nc">&nbsp;            if (cacheSuggestedSof.list.isNullOrEmpty())</b>
<b class="nc">&nbsp;                localSof.getLocalSofSdk()</b>
<b class="nc">&nbsp;                    .map { Pair(&quot;local&quot;, localSof.filterService(it, serviceCode)) }</b>
<b class="nc">&nbsp;            else flow {</b>
<b class="nc">&nbsp;                emit(</b>
<b class="nc">&nbsp;                    Pair(&quot;local&quot;, cacheSuggestedSof.list)</b>
&nbsp;                )
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;        return merge(localFlow, remoteFlow()).transformWhile { (tag, sofList) -&gt;</b>
<b class="nc">&nbsp;            emit(sofList)</b>
<b class="nc">&nbsp;            if (tag == &quot;remote&quot;) {</b>
<b class="nc">&nbsp;                cacheSuggestedSof.list = sofList</b>
&nbsp;            }
<b class="nc">&nbsp;            tag != &quot;remote&quot;</b>
<b class="nc">&nbsp;        }.mapNotNull {</b>
&nbsp;            val sofList = it?.mapNotNull { dto -&gt; dto?.toModel() }
&nbsp;                ?.filter { sof -&gt; sof.disableType != DisableType.Hidden } ?: emptyList()
&nbsp;            val ctaList = it.generateCTA()
&nbsp;            SuggestedSof(sofList, ctaList)
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private fun List&lt;SofDTO?&gt;?.generateCTA(): List&lt;SofCTAItem&gt; =
<b class="nc">&nbsp;        if (this.isNullOrEmpty()) emptyList()</b>
<b class="nc">&nbsp;        else this.fold(emptyList()) { result, dto -&gt;</b>
<b class="nc">&nbsp;            if (dto?.detail == null || dto.detail!!.refId.isNullOrEmpty() || dto.detail!!.enableCTAHeader != true) return@fold result</b>
<b class="nc">&nbsp;            val isValidSource =</b>
<b class="nc">&nbsp;                dto.sourceToken?.isNotEmpty() == true &amp;&amp; dto.sourceToken != &quot;N/A&quot; &amp;&amp; dto.disableType == DisableType.Show.type</b>
<b class="nc">&nbsp;            if (isValidSource) return@fold result</b>
<b class="nc">&nbsp;            val currentCtaList = result.toMutableList()</b>
<b class="nc">&nbsp;            listOf(</b>
<b class="nc">&nbsp;                dto.detail!!.noticeCashIn, dto.detail!!.noticeCashOut, dto.detail!!.noticeActive</b>
<b class="nc">&nbsp;            ).forEach { notice -&gt;</b>
<b class="nc">&nbsp;                notice?.let {</b>
<b class="nc">&nbsp;                    currentCtaList.add(</b>
<b class="nc">&nbsp;                        SofCTAItem(</b>
<b class="nc">&nbsp;                            action = SofAction(</b>
<b class="nc">&nbsp;                                action = if (dto.detail!!.refId == ServiceFeatureCode.CashIn.code) SofActionType.CashIn(</b>
<b class="nc">&nbsp;                                    dto.detail!!.amountCashIn?.toLong() ?: 0</b>
&nbsp;                                )
<b class="nc">&nbsp;                                else SofActionType.HaveNextStep,</b>
<b class="nc">&nbsp;                                refId = dto.detail!!.refId,</b>
<b class="nc">&nbsp;                                logo = it.img,</b>
<b class="nc">&nbsp;                                title = it.title ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                                description = it.description ?: &quot;&quot;,</b>
<b class="nc">&nbsp;                                isShow = true,</b>
<b class="nc">&nbsp;                                params = ModelConvertUtils.decodeToPureMap(</b>
<b class="nc">&nbsp;                                    dto.detail?.refParams ?: &quot;&quot;</b>
&nbsp;                                )
&nbsp;                            ),
<b class="nc">&nbsp;                            relatedSourceToken = dto.sourceToken ?: &quot;N/A&quot;,</b>
<b class="nc">&nbsp;                            relatedSource = dto.convertMoneySource(),</b>
&nbsp;                        )
&nbsp;                    )
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            return@fold currentCtaList</b>
&nbsp;        }
&nbsp;
&nbsp;    private fun generateGetSuggestedSofMessage(): MBGetSuggestedSofRequest {
<b class="nc">&nbsp;        return MBGetSuggestedSofRequest(</b>
<b class="nc">&nbsp;            momoMsg = GetSuggestedSofMoMoMsg(</b>
<b class="nc">&nbsp;                purchaseInfo = cloneTransaction()?.purchaseInfo,</b>
<b class="nc">&nbsp;                purchaseId = cloneTransaction()?.purchaseId,</b>
<b class="nc">&nbsp;                cartId = cloneTransaction()?.cartId,</b>
<b class="nc">&nbsp;                bundleCode = &quot;&quot;,</b>
<b class="nc">&nbsp;                disableMoney = paymentSessionCenter.requestPayXData.disableMoney</b>
&nbsp;            )
&nbsp;        )
&nbsp;    }
&nbsp;
&nbsp;    private fun cloneTransaction(): MoMoMessageDTO? {
<b class="nc">&nbsp;        return savedPaymentData.cloneTransaction()</b>
&nbsp;    }
&nbsp;
&nbsp;    override suspend fun getListIconSuggest(): List&lt;String&gt; {
<b class="nc">&nbsp;        val priority = getConfigSuggestPriority() ?: defaultPriority</b>
<b class="nc">&nbsp;        val bankNotLinked = getBankNotLinked()</b>
&nbsp;
<b class="nc">&nbsp;        return bankNotLinked.sortedWith(compareBy {</b>
&nbsp;            priority[it.serviceCode]?.jsonPrimitive?.intOrNull ?: Int.MAX_VALUE
<b class="nc">&nbsp;        }).map { it.icon }</b>
&nbsp;    }
&nbsp;
&nbsp;    private suspend fun getConfigSuggestPriority(): JsonObject? {
<b class="nc">&nbsp;        return appFeatureRepository.getByServiceCodes(listOf(&quot;map_bank_flow&quot;)).map {</b>
&nbsp;            it.getOrNull(0)?.tryToGetObject(&quot;param&quot;)?.tryToGetObject(&quot;suggestPriority&quot;)
<b class="nc">&nbsp;        }.firstOrNull()</b>
&nbsp;    }
&nbsp;
&nbsp;    private fun getBankLinkedDict(): Flow&lt;Map&lt;String?, SofDTO&gt;&gt; {
<b class="nc">&nbsp;        return localSof.getLocalSofSdk().map { list -&gt;</b>
&nbsp;            list.filter { sof -&gt;
&nbsp;                sof.moneySource == EnumMoneySource.Bank.id
&nbsp;            }.associateBy { it.bankCode }
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @OptIn(ExperimentalCoroutinesApi::class)
&nbsp;    private suspend fun getBankNotLinked(): List&lt;IconSuggest&gt; {
<b class="nc">&nbsp;        val bankLinkedDictFlow = getBankLinkedDict()</b>
<b class="nc">&nbsp;        val bankFeaturesFlow = appFeatureRepository.getFeaturesWittType(listOf(&quot;BANK&quot;))</b>
&nbsp;
<b class="nc">&nbsp;        return bankLinkedDictFlow.flatMapLatest { bankLinkedDict -&gt;</b>
&nbsp;            bankFeaturesFlow.map { features -&gt;
&nbsp;                features.filter { feature -&gt;
&nbsp;                    val serviceCode = feature?.tryToGetString(&quot;serviceCode&quot;)
&nbsp;                    bankLinkedDict[serviceCode] == null
&nbsp;                }.mapNotNull {
&nbsp;                    it?.let {
&nbsp;                        IconSuggest(
&nbsp;                            serviceCode = it.tryToGetString(&quot;serviceCode&quot;),
&nbsp;                            icon = it.tryToGetString(&quot;icon&quot;)
&nbsp;                        )
&nbsp;                    }
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }.firstOrNull() ?: emptyList()</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-07-08 10:52</div>
</div>
</body>
</html>
